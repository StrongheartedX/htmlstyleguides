<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Station</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a12;
            --bg-card: #14141f;
            --bg-card-hover: #1c1c2a;
            --accent: #d4af37;
            --accent-dim: #8b7522;
            --text: #e8dcc8;
            --text-dim: #8a8070;
            --success: #4caf50;
            --danger: #e74c3c;
            --owned: #2e7d32;
            --disabled: #333340;
            --border: #2a2a3a;
            --radius: 8px;
            --gap: 16px;
            --font-title: 'Cinzel', Georgia, serif;
            --font-body: 'Crimson Text', Georgia, serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
            line-height: 1.5;
        }

        .shop-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px var(--gap);
        }

        /* Header */
        .shop-header {
            text-align: center;
            padding: 32px 0 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .shop-title {
            font-family: var(--font-title);
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .shop-subtitle {
            font-size: 1.1rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Player info bar */
        .player-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .gold-display {
            font-family: var(--font-title);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .gold-icon {
            margin-right: 6px;
        }

        .stats-display {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: var(--text-dim);
        }

        .stats-display span {
            white-space: nowrap;
        }

        /* Category sections */
        .category {
            margin-bottom: 32px;
        }

        .category-title {
            font-family: var(--font-title);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            letter-spacing: 1px;
        }

        .category-title .cat-icon {
            margin-right: 8px;
            opacity: 0.8;
        }

        /* Item grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: var(--gap);
        }

        /* Item card */
        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-card:hover:not(.item-owned):not(.item-locked) {
            background: var(--bg-card-hover);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .item-card:active:not(.item-owned):not(.item-locked) {
            transform: translateY(0);
        }

        .item-card.item-owned {
            border-color: var(--owned);
            cursor: default;
            opacity: 0.75;
        }

        .item-card.item-locked {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .item-icon {
            font-size: 2rem;
            line-height: 1;
        }

        .item-name {
            font-family: var(--font-title);
            font-size: 1.05rem;
            font-weight: 700;
        }

        .item-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            flex-grow: 1;
        }

        .item-cost {
            font-family: var(--font-title);
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: 700;
        }

        .item-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.75rem;
            font-family: var(--font-title);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .badge-owned {
            background: var(--owned);
            color: #fff;
        }

        .badge-locked {
            background: var(--disabled);
            color: var(--text-dim);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 24px;
            font-family: var(--font-title);
            font-size: 1rem;
            z-index: 100;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Footer actions */
        .shop-footer {
            text-align: center;
            padding: 32px 0 48px;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .btn {
            font-family: var(--font-title);
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: var(--radius);
            padding: 12px 28px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.15s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn-primary:hover {
            background: #e0bf45;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-dim);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .continue-btn {
            font-size: 1.2rem;
            padding: 16px 40px;
        }

        /* Import modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            font-family: var(--font-title);
            margin-bottom: 12px;
            color: var(--accent);
        }

        .modal textarea {
            width: 100%;
            height: 140px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-title {
                font-size: 1.6rem;
            }

            .player-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }

            .item-card {
                padding: 12px;
            }

            .item-icon {
                font-size: 1.6rem;
            }

            .footer-buttons {
                flex-direction: column;
                align-items: center;
            }

            .continue-btn {
                width: 100%;
                max-width: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="shop-container">
        <header class="shop-header">
            <h1 class="shop-title" id="shop-title">Supply Station</h1>
            <p class="shop-subtitle" id="shop-subtitle">Prepare for the next world</p>
        </header>

        <div class="player-bar">
            <div class="gold-display">
                <span class="gold-icon">&#x2B50;</span>
                <span id="gold-amount">0</span> Gold
            </div>
            <div class="stats-display">
                <span>Runs: <strong id="stat-runs">0</strong></span>
                <span>Total Kills: <strong id="stat-kills">0</strong></span>
                <span>World: <strong id="stat-world">1</strong></span>
            </div>
        </div>

        <section class="category" id="cat-stats">
            <h2 class="category-title"><span class="cat-icon">&#x2694;</span>Stat Upgrades</h2>
            <div class="item-grid" id="grid-stats"></div>
        </section>

        <section class="category" id="cat-weapons">
            <h2 class="category-title"><span class="cat-icon">&#x26A1;</span>Starting Weapons</h2>
            <div class="item-grid" id="grid-weapons"></div>
        </section>

        <section class="category" id="cat-passives">
            <h2 class="category-title"><span class="cat-icon">&#x2728;</span>Passives</h2>
            <div class="item-grid" id="grid-passives"></div>
        </section>

        <footer class="shop-footer">
            <div class="footer-buttons">
                <button class="btn btn-secondary" onclick="exportSave()">Export Save</button>
                <button class="btn btn-secondary" onclick="openImportModal()">Import Save</button>
                <button class="btn btn-danger" onclick="resetSave()">Reset Save</button>
            </div>
            <a id="continue-btn" class="btn btn-primary continue-btn" href="#">
                Continue to Next World &#x2192;
            </a>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <h3>Import Save</h3>
            <p style="margin-bottom:8px; color:var(--text-dim); font-size:0.9rem;">
                Paste exported JSON below. This will overwrite your current save.
            </p>
            <textarea id="import-textarea" placeholder='{"version":1,"gold":0,...}'></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="doImport()">Import</button>
            </div>
        </div>
    </div>

    <script>
    // =========================================================================
    // SHOP CONFIGURATION
    // Themed shop pages override this object to customise items, destination,
    // and visual identity. This template provides sensible defaults.
    // =========================================================================
    const SHOP_CONFIG = window.SHOP_CONFIG || {
        title: 'Supply Station',
        subtitle: 'Spend gold between worlds',
        nextWorld: { label: 'Next World', url: '#' },
        statUpgrades: [
            { id: 'hp1',    name: 'Vitality I',     desc: '+20% Max HP',          icon: '\u2665', cost: 30,  stat: 'maxHp',       mult: 1.2 },
            { id: 'hp2',    name: 'Vitality II',    desc: '+30% Max HP',          icon: '\u2665', cost: 80,  stat: 'maxHp',       mult: 1.3, requires: 'hp1' },
            { id: 'spd1',   name: 'Swiftness I',    desc: '+15% Move Speed',      icon: '\u27A4', cost: 25,  stat: 'speed',       mult: 1.15 },
            { id: 'spd2',   name: 'Swiftness II',   desc: '+20% Move Speed',      icon: '\u27A4', cost: 70,  stat: 'speed',       mult: 1.2, requires: 'spd1' },
            { id: 'dmg1',   name: 'Might I',        desc: '+20% Damage',          icon: '\u2694', cost: 35,  stat: 'damage',      mult: 1.2 },
            { id: 'dmg2',   name: 'Might II',       desc: '+25% Damage',          icon: '\u2694', cost: 90,  stat: 'damage',      mult: 1.25, requires: 'dmg1' },
            { id: 'atk1',   name: 'Haste I',        desc: '+15% Attack Speed',    icon: '\u231A', cost: 30,  stat: 'attackSpeed', mult: 1.15 },
            { id: 'def1',   name: 'Armor I',        desc: '-15% Damage Taken',    icon: '\u26E8', cost: 35,  stat: 'defense',     mult: 0.85 },
            { id: 'pick1',  name: 'Magnetism I',    desc: '+40% Pickup Range',    icon: '\u2609', cost: 20,  stat: 'pickupRadius', mult: 1.4 }
        ],
        startingWeapons: [
            { id: 'w_projectile', name: 'Projectile',   desc: 'Start with a ranged projectile weapon', icon: '\u2726', cost: 50,  weaponType: 'projectile' },
            { id: 'w_orbit',      name: 'Orbit Shield', desc: 'Start with an orbiting barrier',        icon: '\u2B21', cost: 60,  weaponType: 'orbit' },
            { id: 'w_area',       name: 'Area Blast',   desc: 'Start with an expanding area attack',   icon: '\u29BF', cost: 55,  weaponType: 'area' },
            { id: 'w_chain',      name: 'Chain Strike', desc: 'Start with a chaining attack',          icon: '\u2301', cost: 65,  weaponType: 'chain' },
            { id: 'w_beam',       name: 'Beam',         desc: 'Start with a sustained beam weapon',    icon: '\u2588', cost: 70,  weaponType: 'beam' },
            { id: 'w_rain',       name: 'Rain',         desc: 'Start with a rain-from-above attack',   icon: '\u2663', cost: 60,  weaponType: 'rain' }
        ],
        passives: [
            { id: 'p_regen',      name: 'Regeneration',  desc: 'Slowly recover HP during runs',   icon: '\u2661', cost: 45 },
            { id: 'p_xpboost',    name: 'XP Boost',      desc: '+15% XP from all sources',        icon: '\u2605', cost: 40 },
            { id: 'p_goldboost',  name: 'Gold Rush',     desc: '+20% gold earned per run',         icon: '\u2B50', cost: 50 },
            { id: 'p_critchance', name: 'Critical Eye',  desc: '+10% critical hit chance',         icon: '\u25C8', cost: 55 },
            { id: 'p_revive',     name: 'Second Wind',   desc: 'Revive once per run at 30% HP',   icon: '\u2764', cost: 100 }
        ]
    };

    // =========================================================================
    // SAVE MANAGER (mirrors engine.js SaveManager, standalone for the shop)
    // =========================================================================
    const STORAGE_KEY = 'survivors-save';
    const SAVE_VERSION = 1;

    function defaultSave() {
        return {
            version: SAVE_VERSION,
            gold: 0,
            currentWorld: 0,
            inventory: [],
            skillTree: {},
            upgrades: {},
            stats: { totalKills: 0, bestTime: 0, runsCompleted: 0 }
        };
    }

    function loadSave() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultSave();
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return defaultSave();
            return migrateSave(parsed);
        } catch (e) {
            console.warn('Shop: failed to load save', e);
            return defaultSave();
        }
    }

    function migrateSave(data) {
        const base = defaultSave();
        return {
            version: SAVE_VERSION,
            gold: typeof data.gold === 'number' ? data.gold : base.gold,
            currentWorld: typeof data.currentWorld === 'number' ? data.currentWorld : base.currentWorld,
            inventory: Array.isArray(data.inventory) ? data.inventory : base.inventory,
            skillTree: data.skillTree && typeof data.skillTree === 'object' ? data.skillTree : base.skillTree,
            upgrades: data.upgrades && typeof data.upgrades === 'object' ? data.upgrades : base.upgrades,
            stats: {
                totalKills: (data.stats && typeof data.stats.totalKills === 'number') ? data.stats.totalKills : base.stats.totalKills,
                bestTime: (data.stats && typeof data.stats.bestTime === 'number') ? data.stats.bestTime : base.stats.bestTime,
                runsCompleted: (data.stats && typeof data.stats.runsCompleted === 'number') ? data.stats.runsCompleted : base.stats.runsCompleted
            }
        };
    }

    function writeSave(data) {
        try {
            const merged = Object.assign(defaultSave(), data);
            merged.version = SAVE_VERSION;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
            return true;
        } catch (e) {
            console.warn('Shop: failed to write save', e);
            return false;
        }
    }

    // =========================================================================
    // STATE
    // =========================================================================
    let saveData = loadSave();

    function isOwned(itemId) {
        return !!(saveData.upgrades && saveData.upgrades[itemId]);
    }

    function canAfford(cost) {
        return saveData.gold >= cost;
    }

    function requirementMet(item) {
        if (!item.requires) return true;
        return isOwned(item.requires);
    }

    // =========================================================================
    // RENDERING
    // =========================================================================
    function renderHeader() {
        document.getElementById('shop-title').textContent = SHOP_CONFIG.title;
        document.getElementById('shop-subtitle').textContent = SHOP_CONFIG.subtitle;
        document.title = SHOP_CONFIG.title;

        const continueBtn = document.getElementById('continue-btn');
        continueBtn.href = SHOP_CONFIG.nextWorld.url;
        continueBtn.innerHTML = 'Continue to ' + SHOP_CONFIG.nextWorld.label + ' &#x2192;';
    }

    function renderPlayerBar() {
        document.getElementById('gold-amount').textContent = saveData.gold;
        document.getElementById('stat-runs').textContent = saveData.stats.runsCompleted;
        document.getElementById('stat-kills').textContent = saveData.stats.totalKills;
        document.getElementById('stat-world').textContent = (saveData.currentWorld || 0) + 1;
    }

    function createCard(item, category) {
        const owned = isOwned(item.id);
        const affordable = canAfford(item.cost);
        const reqMet = requirementMet(item);
        const locked = !affordable || !reqMet;

        const card = document.createElement('div');
        card.className = 'item-card' + (owned ? ' item-owned' : '') + (!owned && locked ? ' item-locked' : '');

        let badgeHTML = '';
        if (owned) {
            badgeHTML = '<span class="item-badge badge-owned">Owned</span>';
        } else if (!reqMet) {
            badgeHTML = '<span class="item-badge badge-locked">Locked</span>';
        }

        card.innerHTML =
            badgeHTML +
            '<div class="item-icon">' + item.icon + '</div>' +
            '<div class="item-name">' + item.name + '</div>' +
            '<div class="item-desc">' + item.desc + '</div>' +
            '<div class="item-cost">' + (owned ? 'Purchased' : item.cost + ' Gold') + '</div>';

        if (!owned) {
            card.addEventListener('click', function () {
                buyItem(item, category);
            });
        }

        return card;
    }

    function renderGrid(gridId, items, category) {
        const grid = document.getElementById(gridId);
        grid.innerHTML = '';
        items.forEach(function (item) {
            grid.appendChild(createCard(item, category));
        });
    }

    function renderAll() {
        renderHeader();
        renderPlayerBar();
        renderGrid('grid-stats', SHOP_CONFIG.statUpgrades, 'stat');
        renderGrid('grid-weapons', SHOP_CONFIG.startingWeapons, 'weapon');
        renderGrid('grid-passives', SHOP_CONFIG.passives, 'passive');
    }

    // =========================================================================
    // PURCHASE LOGIC
    // =========================================================================
    function buyItem(item, category) {
        if (isOwned(item.id)) return;
        if (!canAfford(item.cost)) {
            showToast('Not enough gold!');
            return;
        }
        if (!requirementMet(item)) {
            showToast('Requires: ' + item.requires);
            return;
        }

        saveData.gold -= item.cost;
        if (!saveData.upgrades) saveData.upgrades = {};
        saveData.upgrades[item.id] = {
            category: category,
            purchasedAt: Date.now()
        };

        // Store additional metadata depending on category
        if (item.stat) {
            saveData.upgrades[item.id].stat = item.stat;
            saveData.upgrades[item.id].mult = item.mult;
        }
        if (item.weaponType) {
            saveData.upgrades[item.id].weaponType = item.weaponType;
        }

        writeSave(saveData);
        renderAll();
        showToast('Purchased: ' + item.name);
    }

    // =========================================================================
    // EXPORT / IMPORT / RESET
    // =========================================================================
    function exportSave() {
        const json = JSON.stringify(saveData, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(json).then(function () {
                showToast('Save copied to clipboard!');
            }).catch(function () {
                fallbackExport(json);
            });
        } else {
            fallbackExport(json);
        }
    }

    function fallbackExport(json) {
        const ta = document.getElementById('import-textarea');
        ta.value = json;
        openImportModal();
        ta.select();
        showToast('Save JSON shown in text box. Copy it manually.');
    }

    function openImportModal() {
        document.getElementById('import-modal').classList.add('active');
    }

    function closeImportModal() {
        document.getElementById('import-modal').classList.remove('active');
    }

    function doImport() {
        const raw = document.getElementById('import-textarea').value.trim();
        if (!raw) {
            showToast('Paste a save JSON first.');
            return;
        }
        try {
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object' || typeof parsed.version !== 'number') {
                showToast('Invalid save format.');
                return;
            }
            saveData = migrateSave(parsed);
            writeSave(saveData);
            closeImportModal();
            renderAll();
            showToast('Save imported successfully!');
        } catch (e) {
            showToast('Failed to parse JSON.');
        }
    }

    function resetSave() {
        if (!confirm('Reset all progress? This cannot be undone.')) return;
        saveData = defaultSave();
        writeSave(saveData);
        renderAll();
        showToast('Save reset.');
    }

    // =========================================================================
    // TOAST
    // =========================================================================
    let toastTimer = null;
    function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(function () {
            el.classList.remove('show');
        }, 2200);
    }

    // Close import modal on overlay click
    document.getElementById('import-modal').addEventListener('click', function (e) {
        if (e.target === this) closeImportModal();
    });

    // =========================================================================
    // INIT
    // =========================================================================
    renderAll();
    </script>
</body>
</html>
