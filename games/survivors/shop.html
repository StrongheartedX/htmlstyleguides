<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        :root {
            --bg: #111;
            --bg-card: #1a1a1a;
            --bg-card-hover: #252525;
            --accent: #c4a24e;
            --highlight: #c4a24e;
            --text: #e0e0e0;
            --text-dim: #888;
            --success: #5a8f4a;
            --danger: #9e2a2a;
            --owned: #3a6635;
            --disabled: #2a2a2a;
            --border: #333;
            --radius: 6px;
            --gap: 16px;
            --font-title: sans-serif;
            --font-body: sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
            line-height: 1.5;
        }

        .shop-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px var(--gap);
        }

        /* Header */
        .shop-header {
            text-align: center;
            padding: 32px 0 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
            position: relative;
        }

        .shop-title {
            font-family: var(--font-display, var(--font-title));
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .shop-subtitle {
            font-size: 1.15rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Player info bar */
        .player-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 20px;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-wrap: wrap;
            gap: 12px;
        }

        .gold-display {
            font-family: var(--font-title);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .gold-icon {
            margin-right: 6px;
        }

        .stats-display {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: var(--text-dim);
        }

        .stats-display span {
            white-space: nowrap;
        }

        /* Category sections */
        .category {
            margin-bottom: 32px;
        }

        .category-title {
            font-family: var(--font-title);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            letter-spacing: 1px;
        }

        .category-title .cat-icon {
            margin-right: 8px;
            opacity: 0.8;
        }

        /* Item grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: var(--gap);
        }

        /* Item card */
        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s, box-shadow 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-card:hover:not(.item-owned):not(.item-locked) {
            background: var(--bg-card-hover);
            border-color: var(--highlight);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px color-mix(in srgb, var(--highlight) 20%, transparent);
        }

        .item-card:active:not(.item-owned):not(.item-locked) {
            transform: translateY(0);
        }

        .item-card.item-owned {
            border-color: var(--owned);
            cursor: default;
            opacity: 0.75;
        }

        .item-card.item-locked {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .item-icon {
            font-size: 2rem;
            line-height: 1;
        }

        .item-name {
            font-family: var(--font-title);
            font-size: 1rem;
            font-weight: 700;
        }

        .item-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            flex-grow: 1;
        }

        .item-cost {
            font-family: var(--font-title);
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: 700;
        }

        .item-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.75rem;
            font-family: var(--font-title);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .badge-owned {
            background: var(--owned);
            color: #fff;
        }

        .badge-locked {
            background: var(--disabled);
            color: var(--text-dim);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--highlight);
            border-radius: var(--radius);
            padding: 12px 24px;
            font-family: var(--font-title);
            font-size: 1rem;
            z-index: 100;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Footer actions */
        .shop-footer {
            text-align: center;
            padding: 32px 0 48px;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .btn {
            font-family: var(--font-title);
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: var(--radius);
            padding: 12px 28px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--btn-primary-bg, var(--highlight));
            color: var(--btn-primary-color, #fff);
        }

        .btn-primary:hover {
            background: var(--btn-primary-hover-bg, var(--highlight));
            box-shadow: var(--btn-primary-hover-shadow, none);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-dim);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-danger:hover {
            filter: brightness(0.85);
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .continue-btn {
            font-size: 1.2rem;
            padding: 16px 40px;
        }

        /* Import modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            font-family: var(--font-display, var(--font-title));
            margin-bottom: 12px;
            color: var(--accent);
        }

        .modal textarea {
            width: 100%;
            height: 140px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Skill Tree */
        .skill-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-points-display {
            font-family: var(--font-title);
            font-size: 1.1rem;
            color: var(--accent);
            font-weight: 700;
        }

        .skill-tree-svg-wrap {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 16px;
            margin-top: 12px;
            overflow-x: auto;
        }

        .skill-tree-svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }

        .skill-tree-svg .branch-label {
            font-family: var(--font-title);
            font-size: 13px;
            font-weight: 700;
            fill: var(--text);
        }

        .skill-tree-svg .node-circle {
            stroke-width: 2.5;
            cursor: pointer;
            transition: filter 0.2s;
        }

        .skill-tree-svg .node-circle:hover {
            filter: brightness(1.3);
        }

        .skill-tree-svg .node-circle.locked {
            cursor: not-allowed;
            opacity: 0.35;
        }

        .skill-tree-svg .node-circle.locked:hover {
            filter: none;
        }

        .skill-tree-svg .node-circle.unlocked {
            filter: drop-shadow(0 0 6px currentColor);
        }

        .skill-tree-svg .node-label {
            font-family: var(--font-body);
            font-size: 11px;
            fill: var(--text);
            pointer-events: none;
        }

        .skill-tree-svg .node-label.dimmed {
            opacity: 0.4;
        }

        .skill-tree-svg .connector {
            stroke-width: 2;
            fill: none;
        }

        .skill-tree-svg .connector.active {
            opacity: 1;
        }

        .skill-tree-svg .connector.inactive {
            opacity: 0.2;
            stroke-dasharray: 4 3;
        }

        .skill-tree-tooltip {
            position: fixed;
            background: var(--tooltip-bg, var(--bg-card));
            border: 1px solid var(--highlight);
            border-radius: 6px;
            padding: 10px 14px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--text);
            max-width: 220px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.4;
        }

        .skill-tree-tooltip.visible {
            opacity: 1;
        }

        .skill-tree-tooltip .tt-name {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .skill-tree-tooltip .tt-status {
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Inventory system */
        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .equip-slots {
            display: flex;
            gap: 12px;
            margin: 12px 0 16px;
            flex-wrap: wrap;
        }

        .equip-slot {
            width: 80px;
            height: 80px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            position: relative;
            cursor: default;
            transition: border-color 0.2s;
        }

        .equip-slot.filled {
            border-style: solid;
            cursor: pointer;
        }

        .equip-slot.filled:hover {
            border-color: var(--danger);
        }

        .equip-slot .slot-label {
            font-family: var(--font-title);
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .equip-slot .slot-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        .equip-slot .slot-name {
            font-size: 0.65rem;
            color: var(--text);
            text-align: center;
            line-height: 1.1;
            max-width: 72px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .equip-slot.slot-empty .slot-icon {
            font-size: 1.2rem;
            color: var(--text-dim);
            opacity: 0.3;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .inv-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
            position: relative;
        }

        .inv-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-1px);
        }

        .inv-item.inv-equipped {
            border-color: var(--accent);
        }

        .inv-item .inv-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        .inv-item .inv-name {
            font-family: var(--font-title);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .inv-item .inv-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .inv-item .inv-rarity {
            font-family: var(--font-title);
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1px 6px;
            border-radius: 3px;
        }

        .rarity-common    { color: #cccccc; border: 1px solid #666; }
        .rarity-rare       { color: #4488ff; border: 1px solid #4488ff; }
        .rarity-epic       { color: #aa44ff; border: 1px solid #aa44ff; }
        .rarity-legendary  { color: #ffcc00; border: 1px solid #ffcc00; }

        .inv-item .inv-equipped-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.65rem;
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .inv-empty-msg {
            color: var(--text-dim);
            font-style: italic;
            padding: 16px;
            text-align: center;
        }

        .inv-tooltip {
            position: fixed;
            background: var(--tooltip-bg, var(--bg-card));
            border: 1px solid var(--highlight);
            border-radius: 6px;
            padding: 10px 14px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--text);
            max-width: 240px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.4;
        }

        .inv-tooltip.visible {
            opacity: 1;
        }

        .inv-tooltip .tt-name {
            font-family: var(--font-title);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .inv-tooltip .tt-action {
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .inv-tooltip .tt-salvage {
            font-size: 0.8rem;
            margin-top: 4px;
            color: var(--accent);
            font-weight: 700;
        }

        .inv-salvage-btn {
            font-family: var(--font-title);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            margin-top: 4px;
        }

        .inv-salvage-btn:hover {
            background: var(--danger);
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-title {
                font-size: 1.6rem;
            }

            .player-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }

            .item-card {
                padding: 12px;
            }

            .item-icon {
                font-size: 1.6rem;
            }

            .footer-buttons {
                flex-direction: column;
                align-items: center;
            }

            .continue-btn {
                width: 100%;
                max-width: 320px;
            }

            .skill-tree-svg-wrap {
                padding: 16px 8px;
            }

            .skill-tree-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .inv-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .equip-slots {
                justify-content: center;
                width: 100%;
            }

            .equip-slot {
                width: 70px;
                height: 70px;
            }

            .inv-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body style="display:none">
    <div class="shop-container">
        <header class="shop-header" id="shop-header-el">
            <!-- Theme decorations injected here by extraCss/JS -->
            <h1 class="shop-title" id="shop-title">Shop</h1>
            <p class="shop-subtitle" id="shop-subtitle">Loading...</p>
        </header>

        <div class="player-bar">
            <div class="gold-display">
                <span class="gold-icon" id="gold-icon">&#x2B50;</span>
                <span id="gold-amount">0</span> Gold
            </div>
            <div class="stats-display">
                <span>Runs: <strong id="stat-runs">0</strong></span>
                <span>Total Kills: <strong id="stat-kills">0</strong></span>
                <span>World: <strong id="stat-world">1</strong></span>
                <span>Skill Pts: <strong id="stat-sp">0</strong></span>
            </div>
        </div>

        <!-- 5 category sections with placeholder titles (filled by shop-engine.js) -->
        <section class="category" id="cat-stats">
            <h2 class="category-title" id="cat-stats-title"><span class="cat-icon"></span>Stats</h2>
            <div class="item-grid" id="grid-stats"></div>
        </section>

        <section class="category" id="cat-weapons">
            <h2 class="category-title" id="cat-weapons-title"><span class="cat-icon"></span>Weapons</h2>
            <div class="item-grid" id="grid-weapons"></div>
        </section>

        <section class="category" id="cat-passives">
            <h2 class="category-title" id="cat-passives-title"><span class="cat-icon"></span>Passives</h2>
            <div class="item-grid" id="grid-passives"></div>
        </section>

        <section class="category" id="cat-skilltree">
            <div class="skill-tree-header">
                <h2 class="category-title" id="cat-skills-title" style="border-bottom:none;margin-bottom:0;padding-bottom:0">
                    <span class="cat-icon"></span>Skill Tree
                </h2>
                <div class="skill-points-display">
                    Skill Points: <span id="skill-points-count">0</span>
                </div>
            </div>
            <div class="skill-tree-svg-wrap">
                <svg id="skill-tree-svg" class="skill-tree-svg" viewBox="0 0 760 340" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </section>

        <div class="skill-tree-tooltip" id="skill-tooltip"></div>

        <section class="category" id="cat-inventory">
            <div class="inv-header">
                <h2 class="category-title" id="cat-inv-title" style="border-bottom:none;margin-bottom:0;padding-bottom:0">
                    <span class="cat-icon"></span>Inventory
                </h2>
                <div style="font-size:0.9rem;color:var(--text-dim);display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                    <span>Equipped: <strong id="inv-equip-count">0</strong>/3</span>
                    <span>Slots: <strong id="inv-slot-info">0/6</strong></span>
                    <button class="btn btn-secondary" id="inv-expand-btn" onclick="buyInventorySlots()" style="font-size:0.8rem;padding:4px 12px">Expand</button>
                </div>
            </div>
            <div class="equip-slots" id="equip-slots"></div>
            <div class="inv-grid" id="inv-grid"></div>
        </section>

        <div class="inv-tooltip" id="inv-tooltip"></div>

        <footer class="shop-footer">
            <div class="footer-buttons">
                <button class="btn btn-secondary" onclick="exportSave()">Export Save</button>
                <button class="btn btn-secondary" onclick="openImportModal()">Import Save</button>
                <button class="btn btn-danger" onclick="resetSave()">Reset Save</button>
            </div>
            <a id="continue-btn" class="btn btn-primary continue-btn" href="#">
                Continue &#x2192;
            </a>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <h3>Import Save</h3>
            <p style="margin-bottom:8px;color:var(--text-dim);font-size:0.9rem;">
                Paste exported JSON below. This will overwrite your current save.
            </p>
            <textarea id="import-textarea" placeholder='{"version":1,"gold":0,...}'></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="doImport()">Import</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        var params = new URLSearchParams(window.location.search);
        var world = params.get('world') || 'gothic';

        var themeScript = document.createElement('script');
        themeScript.src = 'themes/' + world + '.js';
        themeScript.onload = function() {
            var T = window.THEME;
            if (!T || !T.shopConfig) {
                document.body.style.display = '';
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#fff;font-size:1.5rem;background:#111">No shop config for "' + world + '". <a href="index.html" style="color:#ffd700;margin-left:8px">Back to menu</a></div>';
                return;
            }

            var config = T.shopConfig;

            // Set SHOP_CONFIG and SKILL_TREE_DEF globals
            window.SHOP_CONFIG = config;
            window.SKILL_TREE_DEF = config.skillTree;

            // Apply CSS vars
            var root = document.documentElement;
            var vars = config.cssVars || {};
            for (var key in vars) {
                root.style.setProperty(key, vars[key]);
            }

            // Apply Google Fonts
            if (config.googleFontsUrl) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = config.googleFontsUrl;
                document.head.appendChild(link);
            }

            // Inject extra CSS
            if (config.extraCss) {
                var style = document.createElement('style');
                style.textContent = config.extraCss;
                document.head.appendChild(style);
            }

            // Inject header decoration HTML
            if (config.headerDecorationHtml) {
                document.getElementById('shop-header-el').insertAdjacentHTML('afterbegin', config.headerDecorationHtml);
            }

            // Show body
            document.body.style.display = '';

            // Load shop engine
            var engineScript = document.createElement('script');
            engineScript.src = 'shop-engine.js';
            document.body.appendChild(engineScript);
        };
        themeScript.onerror = function() {
            document.body.style.display = '';
            document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#fff;font-size:1.5rem;background:#111">Theme "' + world + '" not found. <a href="index.html" style="color:#ffd700;margin-left:8px">Back to menu</a></div>';
        };
        document.body.appendChild(themeScript);
    })();
    </script>
</body>
</html>
