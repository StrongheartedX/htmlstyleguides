<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gothic Survivors</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0f;font-family:'Crimson Text',serif;color:#e8dcc8}
canvas{display:block;width:100%;height:100%;touch-action:none}
#ui-overlay{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}
#hud{position:absolute;top:0;left:0;width:100%;padding:8px 12px;display:flex;justify-content:space-between;align-items:flex-start;font-family:'Cinzel',serif}
#hud-left,#hud-right{display:flex;flex-direction:column;gap:4px}
#hud-right{align-items:flex-end}
.hud-text{font-size:14px;text-shadow:0 0 8px rgba(180,30,30,0.6),1px 1px 2px #000;color:#e8dcc8}
.hud-big{font-size:18px;font-weight:700;color:#d4af37}
#xp-bar-container{position:absolute;top:0;left:0;width:100%;height:4px;background:rgba(0,0,0,0.7)}
#xp-bar{height:100%;background:linear-gradient(90deg,#6b2fa0,#d4af37);width:0%;transition:width 0.3s}
#hp-bar-container{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:200px;height:8px;background:rgba(0,0,0,0.7);border:1px solid #555;border-radius:4px;overflow:hidden}
#hp-bar{height:100%;background:linear-gradient(90deg,#8b0000,#cc3333);width:100%;transition:width 0.3s}
#weapon-bar{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:4px}
.weapon-slot{width:36px;height:36px;border:2px solid #555;background:rgba(0,0,0,0.6);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:18px}
.weapon-slot.active{border-color:#d4af37;box-shadow:0 0 8px rgba(212,175,55,0.5)}
#title-screen,#game-over-screen,#level-up-screen,#pause-screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;pointer-events:auto}
#title-screen{background:radial-gradient(ellipse at center,#1a0a0a 0%,#0a0a0f 70%)}
#game-over-screen{background:rgba(5,0,0,0.92);display:none}
#level-up-screen{background:rgba(5,0,0,0.85);display:none}
#pause-screen{background:rgba(0,0,0,0.88);display:none;overflow-y:auto}
.screen-title{font-family:'Cinzel',serif;font-size:clamp(2.5rem,8vw,5rem);font-weight:900;color:#8b0000;text-shadow:0 0 40px rgba(139,0,0,0.6),0 0 80px rgba(139,0,0,0.3);margin-bottom:8px;text-align:center;letter-spacing:0.05em}
.screen-subtitle{font-family:'Crimson Text',serif;font-size:clamp(1rem,3vw,1.4rem);color:#d4af37;font-style:italic;margin-bottom:32px;text-align:center}
.btn{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;padding:14px 40px;border:2px solid #d4af37;background:rgba(139,0,0,0.3);color:#e8dcc8;cursor:pointer;letter-spacing:0.1em;text-transform:uppercase;transition:all 0.2s;pointer-events:auto}
.btn:hover{background:rgba(139,0,0,0.6);box-shadow:0 0 20px rgba(212,175,55,0.4);transform:scale(1.05)}
.stats-line{font-size:1.1rem;color:#b0a090;margin:4px 0}
.upgrade-cards{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:700px;padding:0 16px}
.upgrade-card{width:200px;padding:20px 16px;border:2px solid #555;background:rgba(20,10,10,0.9);cursor:pointer;text-align:center;transition:all 0.2s;pointer-events:auto;border-radius:4px}
.upgrade-card:hover{border-color:#d4af37;box-shadow:0 0 20px rgba(212,175,55,0.3);transform:translateY(-4px)}
.upgrade-icon{font-size:2.5rem;margin-bottom:8px}
.upgrade-name{font-family:'Cinzel',serif;font-size:1rem;font-weight:700;color:#d4af37;margin-bottom:6px}
.upgrade-desc{font-size:0.85rem;color:#b0a090;line-height:1.4}
.upgrade-hotkey{position:absolute;top:8px;right:10px;font-family:'Cinzel',serif;font-size:0.75rem;color:#777;border:1px solid #555;border-radius:3px;width:22px;height:22px;display:flex;align-items:center;justify-content:center}
.upgrade-card{position:relative}
.upgrade-card.selected{border-color:#d4af37;box-shadow:0 0 20px rgba(212,175,55,0.3);transform:translateY(-4px)}
#touch-zone{position:fixed;bottom:0;left:0;width:200px;height:200px;z-index:15;pointer-events:auto;display:none}
@media(hover:none)and(pointer:coarse){#touch-zone{display:block}}
@media(max-width:600px){.upgrade-cards{flex-direction:column;align-items:center}.upgrade-card{width:85%}.weapon-slot{width:28px;height:28px;font-size:14px}}
.pause-header{display:flex;gap:24px;justify-content:center;align-items:center;padding:12px 20px;background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.1);width:100%;max-width:700px;border-radius:8px 8px 0 0;font-family:inherit;font-size:0.95rem;color:#ccc}
.pause-stat{display:flex;align-items:center;gap:6px}
.pause-stat-icon{font-weight:bold;font-size:1.1rem}
.pause-tabs{display:flex;gap:0;width:100%;max-width:700px;border-bottom:2px solid rgba(255,255,255,0.1)}
.pause-tab{flex:1;padding:12px 16px;border:none;background:rgba(255,255,255,0.03);color:#888;font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.05em;pointer-events:auto}
.pause-tab:hover{background:rgba(255,255,255,0.08);color:#ccc}
.pause-tab.active{background:rgba(255,255,255,0.1);color:#ffd700;border-bottom:2px solid #ffd700}
.tab-badge{display:inline-block;background:#e74c3c;color:#fff;border-radius:10px;padding:1px 7px;font-size:0.75rem;margin-left:4px;vertical-align:middle}
.pause-content{width:100%;max-width:700px;padding:20px;min-height:200px;pointer-events:auto}
.pause-resume-panel{display:flex;flex-direction:column;align-items:center;gap:16px;padding:40px 0}
.inv-section-label{font-family:inherit;font-size:0.85rem;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.1em;margin:12px 0 8px}
.inv-equipped-row{display:flex;gap:10px;flex-wrap:wrap}
.inv-slot{border:2px solid #333;background:rgba(10,10,25,0.8);border-radius:6px;padding:10px;text-align:center;transition:all 0.2s}
.inv-slot.equipped{width:140px;min-height:80px;cursor:pointer}
.inv-slot.equipped.filled:hover{border-color:#ff6666;box-shadow:0 0 12px rgba(255,100,100,0.3)}
.inv-slot.empty{opacity:0.4}
.inv-slot-icon{font-size:1.8rem;margin-bottom:4px}
.inv-slot-name{font-family:inherit;font-size:0.8rem;font-weight:700;margin-bottom:2px}
.inv-slot-desc{font-size:0.7rem;color:#888;line-height:1.3}
.inv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.inv-slot.grid-slot{min-height:90px}
.inv-slot.grid-slot.filled{border-color:#555}
.inv-count{font-size:0.7rem;color:#aaa;margin-left:2px}
.inv-slot-actions{display:flex;gap:4px;margin-top:6px;justify-content:center;flex-wrap:wrap}
.inv-btn{font-family:inherit;font-size:0.7rem;padding:4px 10px;border:1px solid;border-radius:3px;cursor:pointer;transition:all 0.15s;pointer-events:auto}
.inv-btn.equip{border-color:#2ecc71;background:rgba(46,204,113,0.15);color:#2ecc71}
.inv-btn.equip:hover{background:rgba(46,204,113,0.3)}
.inv-btn.salvage{border-color:#e67e22;background:rgba(230,126,34,0.1);color:#e67e22}
.inv-btn.salvage:hover{background:rgba(230,126,34,0.25)}
.inv-equipped-badge{font-size:0.65rem;color:#2ecc71;border:1px solid #2ecc71;border-radius:3px;padding:2px 6px}
.skills-header{font-family:inherit;font-size:1rem;color:#ccc;margin-bottom:16px;text-align:center}
.skill-branch{margin-bottom:16px}
.skill-branch-label{font-family:inherit;font-size:0.9rem;font-weight:700;margin-bottom:8px;padding-left:4px}
.skill-branch-nodes{display:flex;align-items:center;gap:0;flex-wrap:wrap}
.skill-node{border:2px solid #333;background:rgba(10,10,25,0.8);border-radius:6px;padding:10px 14px;min-width:120px;text-align:center;position:relative;transition:all 0.2s}
.skill-node.unlocked{border-color:var(--branch-color);background:rgba(255,255,255,0.05);box-shadow:0 0 10px rgba(255,255,255,0.05)}
.skill-node.available{border-color:var(--branch-color);cursor:pointer;animation:skillPulse 1.5s ease-in-out infinite}
.skill-node.available:hover{transform:translateY(-2px);box-shadow:0 0 16px rgba(255,215,0,0.3)}
.skill-node.locked{opacity:0.35}
.skill-node-name{font-family:inherit;font-size:0.8rem;font-weight:700;color:#ddd;margin-bottom:2px}
.skill-node-desc{font-size:0.65rem;color:#888;line-height:1.3}
.skill-node-badge{position:absolute;top:4px;right:6px;color:#2ecc71;font-weight:bold;font-size:0.9rem}
.skill-connector{width:20px;height:3px;flex-shrink:0}
@keyframes skillPulse{0%,100%{box-shadow:0 0 6px rgba(255,215,0,0.1)}50%{box-shadow:0 0 16px rgba(255,215,0,0.3)}}
@media(max-width:600px){.inv-grid{grid-template-columns:repeat(2,1fr)}.inv-equipped-row{justify-content:center}.skill-branch-nodes{flex-direction:column;align-items:stretch}.skill-connector{width:3px;height:12px;align-self:center}.pause-header{flex-wrap:wrap;gap:12px}}
</style>
</head>
<body>
<canvas id="game-canvas"></canvas>
<div id="ui-overlay">
  <div id="xp-bar-container"><div id="xp-bar"></div></div>
  <div id="hud">
    <div id="hud-left">
      <div class="hud-text hud-big" id="hud-level">Level 1</div>
      <div class="hud-text" id="hud-time">0:00</div>
      <div class="hud-text" id="hud-kills">Kills: 0</div>
    </div>
    <div id="hud-right">
      <div class="hud-text" id="hud-wave">Wave 1</div>
    </div>
  </div>
  <div id="hp-bar-container"><div id="hp-bar"></div></div>
  <div id="weapon-bar"></div>
</div>
<div id="touch-zone"></div>

<div id="title-screen">
  <div class="screen-title">Gothic Survivors</div>
  <div class="screen-subtitle">Survive the Endless Night</div>
  <button class="btn" id="btn-start">Begin</button>
  <div style="margin-top:24px;font-size:0.85rem;color:#777;text-align:center">WASD / Arrows to move &bull; Auto-attack &bull; Survive</div>
</div>

<div id="game-over-screen">
  <div class="screen-title">Death Claims You</div>
  <div id="go-stats"></div>
  <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
    <a href="index.html" class="btn" style="text-decoration:none">Choose Class</a>
    <button class="btn" id="btn-restart" style="opacity:0.7">Retry</button>
  </div>
</div>

<div id="level-up-screen">
  <div class="screen-title" style="font-size:clamp(1.5rem,5vw,2.5rem)">Level Up</div>
  <div class="screen-subtitle">Choose your blessing</div>
  <div class="upgrade-cards" id="upgrade-cards"></div>
</div>

<div id="pause-screen"></div>

<div id="victory-screen" style="display:none">
  <div class="screen-title" style="color:#d4af37">World Complete!</div>
  <div class="screen-subtitle">The Darkness has been vanquished</div>
  <div id="victory-stats"></div>
  <div id="victory-next" style="margin-top:24px;font-size:1rem;color:#8b0000">Warping to next world...</div>
</div>

<script>
// ============================================================
// GOTHIC THEME CONFIGURATION
// ============================================================
const THEME = {
  name: 'Gothic Survivors',
  fonts: { title: 'Cinzel', body: 'Crimson Text' },
  victoryCondition: { timeSeconds: 420, bossName: 'The Pale One' },
  worldOrder: { current: 1, next: 'shop-forest.html' },
  palette: {
    bg: '#0a0a0f', bgLight: '#1a1020', accent: '#8b0000',
    gold: '#d4af37', bone: '#e8dcc8', emerald: '#2e8b57',
    purple: '#6b2fa0', blood: '#cc3333', midnight: '#0d0d1a',
    floorBase: '#1a1420', floorLine: '#251830'
  },
  effectColors: {
    field: { fillRgb: '212,175,55', strokeRgb: '212,175,55' },
    orbit: { ring: 'rgba(212,175,55,0.15)', orb: '#d4af37' },
    area: { rgb: '212,175,55' },
    beam: { rgb: '255,220,100', glow: '#ffd866' },
    chain: { rgb: '119,187,255', particle: '#77bbff' },
    damageFlash: { rgb: '180,0,0' },
    invuln: { rgb: '255,255,255' },
    rain: { particle: '#ff6633' }
  },
  enemies: [
    { name:'Skeleton', color:'#c8b89a', size:14, speed:55, hp:3, xp:1, spawnAfter:0, draw:'skeleton', movementType:'chase' },
    { name:'Zombie', color:'#5a7a5a', size:16, speed:35, hp:6, xp:2, spawnAfter:0, draw:'zombie', movementType:'chase' },
    { name:'Ghost', color:'rgba(180,180,220,0.6)', size:13, speed:70, hp:2, xp:2, spawnAfter:30, draw:'ghost', movementType:'orbit' },
    { name:'Wraith', color:'#6633aa', size:15, speed:80, hp:4, xp:3, spawnAfter:90, draw:'wraith', movementType:'strafe' },
    { name:'Shadow Stalker', color:'#332244', size:14, speed:88, hp:5, xp:3, spawnAfter:120, draw:'stalker', movementType:'flanker' },
    { name:'Vampire', color:'#aa2222', size:15, speed:90, hp:8, xp:5, spawnAfter:180, draw:'vampire', movementType:'ambush' },
    { name:'Gargoyle', color:'#777788', size:16, speed:60, hp:7, xp:4, spawnAfter:180, draw:'gargoyle', movementType:'divebomber' },
    { name:'Dark Knight', color:'#556677', size:18, speed:35, hp:15, xp:5, spawnAfter:240, draw:'darkknight', movementType:'shieldbearer' },
    { name:'Lich', color:'#44ddaa', size:17, speed:60, hp:15, xp:8, spawnAfter:300, draw:'lich', movementType:'charge' }
  ],
  bosses: [
    { name:'Bone Colossus', color:'#ddd0b8', size:50, speed:30, hp:200, xp:50, spawnAt:120, attackPattern:'shockwave' },
    { name:'Death Knight', color:'#444466', size:45, speed:45, hp:400, xp:80, spawnAt:240, attackPattern:'charge' },
    { name:'Arch-Lich', color:'#33cc99', size:48, speed:50, hp:700, xp:120, spawnAt:360, attackPattern:'summon' },
    { name:'The Pale One', color:'#eeeeff', size:55, speed:55, hp:1200, xp:200, spawnAt:480, attackPattern:'beam' }
  ],
  weapons: [
    { name:'Holy Bolt', desc:'Fires a bolt of light', icon:'\u2720', type:'projectile' },
    { name:'Guardian Spirit', desc:'Orbiting spirit shield', icon:'\u2748', type:'orbit' },
    { name:'Divine Nova', desc:'Expanding holy blast', icon:'\u2600', type:'area' },
    { name:'Chain Lightning', desc:'Bounces between foes', icon:'\u26A1', type:'chain' },
    { name:'Purifying Ray', desc:'Sustained beam of light', icon:'\u2604', type:'beam' },
    { name:'Meteor Shower', desc:'Holy fire from above', icon:'\u2604', type:'rain' },
    { name:'Chakram of Light', desc:'Returning blade of dawn', icon:'\u25C9', type:'boomerang' },
    { name:'Consecrated Ground', desc:'Hallowed earth zone', icon:'\u2742', type:'field' }
  ],
  passives: [
    { name:'Vitality', desc:'+20% Max HP', icon:'\u2665', stat:'maxHp', mult:1.2 },
    { name:'Swiftness', desc:'+15% Move Speed', icon:'\u27A4', stat:'speed', mult:1.15 },
    { name:'Magnetism', desc:'+40% Pickup Range', icon:'\u2609', stat:'pickupRadius', mult:1.4 },
    { name:'Might', desc:'+20% Damage', icon:'\u2694', stat:'damage', mult:1.2 },
    { name:'Haste', desc:'+15% Attack Speed', icon:'\u231A', stat:'attackSpeed', mult:1.15 },
    { name:'Armor', desc:'-15% Damage Taken', icon:'\u26E8', stat:'defense', mult:0.85 }
  ],
  drawPlayer(ctx, x, y, r, time) {
    // Robed figure
    ctx.save();
    ctx.translate(x, y);
    // Cloak
    ctx.beginPath();
    ctx.moveTo(-r*0.7, -r*0.3);
    ctx.lineTo(-r*0.9, r);
    ctx.lineTo(r*0.9, r);
    ctx.lineTo(r*0.7, -r*0.3);
    ctx.closePath();
    ctx.fillStyle = '#2a1a3a';
    ctx.fill();
    // Body
    ctx.beginPath();
    ctx.arc(0, -r*0.1, r*0.65, 0, Math.PI*2);
    ctx.fillStyle = '#3a2a4a';
    ctx.fill();
    // Head
    ctx.beginPath();
    ctx.arc(0, -r*0.7, r*0.35, 0, Math.PI*2);
    ctx.fillStyle = '#e8dcc8';
    ctx.fill();
    // Eyes glow
    const glow = 0.5 + 0.5*Math.sin(time*3);
    ctx.fillStyle = `rgba(212,175,55,${0.6+glow*0.4})`;
    ctx.beginPath();
    ctx.arc(-r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.arc(r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  },
  drawEnemy(ctx, e, time) {
    const {x, y, size, type} = e;
    ctx.save();
    ctx.translate(x, y);
    const s = size;
    if(type.draw==='skeleton') {
      ctx.fillStyle = type.color;
      ctx.beginPath(); ctx.arc(0, -s*0.4, s*0.4, 0, Math.PI*2); ctx.fill();
      ctx.fillRect(-s*0.25, -s*0.1, s*0.5, s*0.8);
      ctx.fillStyle='#333';
      ctx.fillRect(-s*0.15, -s*0.5, s*0.08, s*0.08);
      ctx.fillRect(s*0.07, -s*0.5, s*0.08, s*0.08);
    } else if(type.draw==='zombie') {
      ctx.fillStyle = type.color;
      ctx.beginPath(); ctx.arc(0, -s*0.3, s*0.45, 0, Math.PI*2); ctx.fill();
      ctx.fillRect(-s*0.3, 0, s*0.6, s*0.6);
      ctx.fillStyle='#2a4a2a';
      ctx.fillRect(-s*0.3, 0.1*s, s*0.6, s*0.3);
    } else if(type.draw==='ghost') {
      const a = 0.4+0.3*Math.sin(time*4+e.spawnTime);
      ctx.globalAlpha = a;
      ctx.fillStyle = '#b4b4dc';
      ctx.beginPath(); ctx.arc(0, -s*0.2, s*0.5, Math.PI, 0);
      ctx.lineTo(s*0.5, s*0.5);
      for(let i=0;i<5;i++){
        const px = s*0.5 - i*(s/5);
        ctx.lineTo(px - s*0.1, s*0.3 + (i%2)*s*0.2);
      }
      ctx.closePath(); ctx.fill();
      ctx.globalAlpha = 1;
    } else if(type.draw==='wraith') {
      ctx.fillStyle = '#6633aa';
      ctx.shadowColor = '#9955ff';
      ctx.shadowBlur = 15;
      ctx.beginPath(); ctx.arc(0, 0, s*0.5, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      ctx.fillStyle = '#cc77ff';
      ctx.beginPath(); ctx.arc(-s*0.15,-s*0.1,3,0,Math.PI*2); ctx.arc(s*0.15,-s*0.1,3,0,Math.PI*2); ctx.fill();
    } else if(type.draw==='vampire') {
      ctx.fillStyle = '#1a0a0a';
      ctx.beginPath();
      ctx.moveTo(-s*0.8, -s*0.2);
      ctx.lineTo(-s*0.3, -s*0.6);
      ctx.lineTo(s*0.3, -s*0.6);
      ctx.lineTo(s*0.8, -s*0.2);
      ctx.lineTo(s*0.3, s*0.4);
      ctx.lineTo(-s*0.3, s*0.4);
      ctx.closePath(); ctx.fill();
      ctx.fillStyle = type.color;
      ctx.beginPath(); ctx.arc(0, -s*0.3, s*0.3, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='#ff3333';
      ctx.beginPath(); ctx.arc(-s*0.1,-s*0.3,2.5,0,Math.PI*2); ctx.arc(s*0.1,-s*0.3,2.5,0,Math.PI*2); ctx.fill();
    } else if(type.draw==='lich') {
      ctx.fillStyle = '#1a3a2a';
      ctx.beginPath(); ctx.arc(0, 0, s*0.55, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = type.color;
      ctx.shadowColor = type.color; ctx.shadowBlur = 20;
      ctx.beginPath(); ctx.arc(0, -s*0.15, s*0.35, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      ctx.fillStyle = '#001a0d';
      ctx.beginPath(); ctx.arc(-s*0.1,-s*0.2,3,0,Math.PI*2); ctx.arc(s*0.1,-s*0.2,3,0,Math.PI*2); ctx.fill();
    } else if(type.draw==='stalker') {
      // Dark shadowy figure with glowing eyes
      ctx.fillStyle = type.color;
      ctx.shadowColor = '#6633aa';
      ctx.shadowBlur = 12;
      ctx.beginPath();
      ctx.moveTo(0, -s*0.5);
      ctx.lineTo(s*0.4, s*0.4);
      ctx.lineTo(-s*0.4, s*0.4);
      ctx.closePath();
      ctx.fill();
      ctx.shadowBlur = 0;
      // Glowing eyes
      ctx.fillStyle = '#ff3366';
      ctx.beginPath(); ctx.arc(-s*0.1, -s*0.1, 2, 0, Math.PI*2); ctx.arc(s*0.1, -s*0.1, 2, 0, Math.PI*2); ctx.fill();
    } else if(type.draw==='gargoyle') {
      // Winged stone creature
      const hover = Math.sin(time * 3 + e.spawnTime) * 3;
      ctx.translate(0, hover);
      ctx.fillStyle = type.color;
      ctx.beginPath(); ctx.arc(0, 0, s*0.4, 0, Math.PI*2); ctx.fill();
      // Wings
      ctx.fillStyle = '#555566';
      ctx.beginPath();
      ctx.moveTo(-s*0.3, -s*0.1); ctx.lineTo(-s*0.7, -s*0.4); ctx.lineTo(-s*0.2, s*0.1);
      ctx.closePath(); ctx.fill();
      ctx.beginPath();
      ctx.moveTo(s*0.3, -s*0.1); ctx.lineTo(s*0.7, -s*0.4); ctx.lineTo(s*0.2, s*0.1);
      ctx.closePath(); ctx.fill();
      // Eyes
      ctx.fillStyle = '#ff4400';
      ctx.beginPath(); ctx.arc(-s*0.1, -s*0.05, 2, 0, Math.PI*2); ctx.arc(s*0.1, -s*0.05, 2, 0, Math.PI*2); ctx.fill();
    } else if(type.draw==='darkknight') {
      // Armored knight shape with shield
      ctx.fillStyle = type.color;
      ctx.fillRect(-s*0.35, -s*0.5, s*0.7, s*0.9);
      // Helmet
      ctx.fillStyle = '#334455';
      ctx.beginPath(); ctx.arc(0, -s*0.35, s*0.3, Math.PI, 0); ctx.fill();
      // Visor slit
      ctx.fillStyle = '#cc2222';
      ctx.fillRect(-s*0.15, -s*0.35, s*0.3, 3);
    }
    ctx.restore();
  },
  drawBoss(ctx, e, time) {
    const {x, y, size} = e;
    ctx.save();
    ctx.translate(x, y);
    const s = size;
    ctx.fillStyle = e.type.color;
    ctx.shadowColor = e.type.color;
    ctx.shadowBlur = 30;
    ctx.beginPath(); ctx.arc(0, 0, s, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    // Inner details
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.arc(0, 0, s*0.7, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = e.type.color;
    ctx.beginPath(); ctx.arc(0, 0, s*0.4, 0, Math.PI*2); ctx.fill();
    // Eyes
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.arc(-s*0.2, -s*0.15, s*0.1, 0, Math.PI*2);
    ctx.arc(s*0.2, -s*0.15, s*0.1, 0, Math.PI*2);
    ctx.fill();
    // HP bar
    const hpPct = e.hp / e.maxHp;
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(-s, -s-14, s*2, 8);
    ctx.fillStyle = hpPct > 0.5 ? '#cc3333' : '#ff6600';
    ctx.fillRect(-s, -s-14, s*2*hpPct, 8);
    ctx.strokeStyle = '#888';
    ctx.strokeRect(-s, -s-14, s*2, 8);
    // Name
    ctx.fillStyle = '#d4af37';
    ctx.font = '12px Cinzel';
    ctx.textAlign = 'center';
    ctx.fillText(e.type.name, 0, -s-18);
    ctx.restore();
  },
  drawBackground(ctx, cam, W, H, time) {
    // Dark stone floor with grid
    ctx.fillStyle = THEME.palette.floorBase;
    ctx.fillRect(0, 0, W, H);
    const gs = 64;
    const ox = (-cam.x % gs + gs) % gs;
    const oy = (-cam.y % gs + gs) % gs;
    ctx.strokeStyle = THEME.palette.floorLine;
    ctx.lineWidth = 1;
    ctx.globalAlpha = 0.3;
    for(let x = ox; x < W; x += gs) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for(let y = oy; y < H; y += gs) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }
    ctx.globalAlpha = 1;
    // Occasional torch-like flicker spots
    const flickerT = time * 2;
    for(let i = 0; i < 6; i++) {
      const tx = ((i * 347 + 100) % 1200) - cam.x % 1200;
      const ty = ((i * 521 + 200) % 900) - cam.y % 900;
      const flicker = 0.15 + 0.1 * Math.sin(flickerT + i * 1.7);
      const grd = ctx.createRadialGradient(tx, ty, 0, tx, ty, 120);
      grd.addColorStop(0, `rgba(200,120,40,${flicker})`);
      grd.addColorStop(1, 'transparent');
      ctx.fillStyle = grd;
      ctx.fillRect(tx-120, ty-120, 240, 240);
    }
  },
  drawProjectile(ctx, p) {
    ctx.save();
    ctx.translate(p.x, p.y);
    if(p.weaponType === 'projectile') {
      ctx.fillStyle = '#d4af37';
      ctx.shadowColor = '#d4af37'; ctx.shadowBlur = 10;
      ctx.beginPath(); ctx.arc(0,0,4+p.level,0,Math.PI*2); ctx.fill();
    } else if(p.weaponType === 'chain') {
      ctx.strokeStyle = '#77bbff';
      ctx.shadowColor = '#77bbff'; ctx.shadowBlur = 12;
      ctx.lineWidth = 2 + p.level;
      ctx.beginPath(); ctx.moveTo(-8,0); ctx.lineTo(8,0); ctx.stroke();
    } else if(p.weaponType === 'rain') {
      ctx.fillStyle = '#ff6633';
      ctx.shadowColor = '#ff3300'; ctx.shadowBlur = 15;
      ctx.beginPath(); ctx.arc(0,0,6+p.level*2,0,Math.PI*2); ctx.fill();
    } else if(p.weaponType === 'boomerang') {
      ctx.fillStyle = '#d4af37';
      ctx.rotate(p.angle || 0);
      ctx.beginPath();
      ctx.arc(0,-4,5+p.level,0,Math.PI);
      ctx.arc(0,4,5+p.level,Math.PI,0);
      ctx.fill();
    }
    ctx.restore();
  },
  drawGem(ctx, g, time) {
    const pulse = 1 + 0.15*Math.sin(time*5 + g.x);
    ctx.save();
    ctx.translate(g.x, g.y);
    ctx.scale(pulse, pulse);
    ctx.fillStyle = g.value > 5 ? '#d4af37' : g.value > 2 ? '#2e8b57' : '#6b2fa0';
    ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.moveTo(0, -5); ctx.lineTo(5, 0); ctx.lineTo(0, 5); ctx.lineTo(-5, 0);
    ctx.closePath(); ctx.fill();
    ctx.restore();
  },
  classConfig: {
    classId: 'darkknight',
    className: 'Dark Knight',
    classIcon: '\u2694\uFE0F',
    classDesc: 'Melee bruiser. Thrives in close combat with lifesteal and AoE.',
    startingStats: { hp: 120, speed: 140, damage: 1.0, defense: 1.2 },
    weaponAffinities: {
      primary: ['area', 'chain', 'field'],
      secondary: ['orbit', 'beam']
    },
    classPassive: { id: 'blood_pact', name: 'Blood Pact', desc: '+8% lifesteal, +10% AoE size', effect: { lifestealBonus: 0.08, aoeSizeMult: 1.10 } },
    signatureAbility: { name: 'Blood Ritual', desc: 'Sacrifice 20% HP, 6 blood explosions', icon: '\uD83E\uDE78', cooldown: 60, duration: 0 }
  }
};
</script>
<script src="engine.js"></script>
</body>
</html>