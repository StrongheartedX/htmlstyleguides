<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Void Bazaar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #060613;
            --bg-card: #0d0d24;
            --bg-card-hover: #151538;
            --accent: #7df9ff;
            --accent-dim: #3a8a8f;
            --text: #d0d8f0;
            --text-dim: #6670a0;
            --success: #4caf50;
            --danger: #e74c3c;
            --owned: #2e7d32;
            --disabled: #1a1a3a;
            --border: #1e2050;
            --radius: 8px;
            --gap: 16px;
            --font-title: 'Orbitron', 'Courier New', monospace;
            --font-body: 'Exo 2', 'Segoe UI', sans-serif;
            --nebula-purple: #9b59b6;
            --aurora-green: #00e676;
            --star-white: #f0f0ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
            line-height: 1.5;
            position: relative;
            overflow-x: hidden;
        }

        /* Starfield background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(88, 28, 135, 0.15) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(30, 58, 138, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 60% 80%, rgba(6, 78, 59, 0.1) 0%, transparent 50%),
                radial-gradient(1px 1px at 10% 15%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 25% 35%, rgba(255,255,255,0.8) 50%, transparent 50%),
                radial-gradient(1px 1px at 40% 10%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 55% 65%, rgba(255,255,255,0.6) 50%, transparent 50%),
                radial-gradient(1px 1px at 70% 45%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 85% 75%, rgba(255,255,255,0.7) 50%, transparent 50%),
                radial-gradient(1px 1px at 15% 80%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 50% 25%, rgba(255,255,255,0.5) 50%, transparent 50%),
                radial-gradient(1px 1px at 90% 10%, #fff 50%, transparent 50%),
                radial-gradient(1.5px 1.5px at 30% 55%, rgba(125,249,255,0.6) 50%, transparent 50%),
                radial-gradient(1.5px 1.5px at 65% 30%, rgba(155,89,182,0.5) 50%, transparent 50%),
                radial-gradient(1.5px 1.5px at 78% 88%, rgba(0,230,118,0.4) 50%, transparent 50%),
                radial-gradient(1px 1px at 5% 50%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 95% 55%, rgba(255,255,255,0.6) 50%, transparent 50%),
                radial-gradient(1px 1px at 45% 90%, #fff 50%, transparent 50%),
                radial-gradient(1px 1px at 33% 5%, rgba(255,255,255,0.7) 50%, transparent 50%),
                radial-gradient(1px 1px at 60% 50%, rgba(255,255,255,0.4) 50%, transparent 50%);
            pointer-events: none;
        }

        .shop-container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px var(--gap);
            position: relative;
            z-index: 1;
        }

        /* Header */
        .shop-header {
            text-align: center;
            padding: 32px 0 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .shop-title {
            font-family: var(--font-title);
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(125,249,255,0.4), 0 0 40px rgba(125,249,255,0.15);
        }

        .shop-subtitle {
            font-size: 1.1rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Player info bar */
        .player-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 20px;
            margin-bottom: 24px;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: 0 0 16px rgba(125,249,255,0.05);
        }

        .gold-display {
            font-family: var(--font-title);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .gold-icon {
            margin-right: 6px;
        }

        .stats-display {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: var(--text-dim);
        }

        .stats-display span {
            white-space: nowrap;
        }

        /* Category sections */
        .category {
            margin-bottom: 32px;
        }

        .category-title {
            font-family: var(--font-title);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            letter-spacing: 2px;
        }

        .category-title .cat-icon {
            margin-right: 8px;
            opacity: 0.8;
        }

        /* Item grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: var(--gap);
        }

        /* Item card */
        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s, box-shadow 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-card:hover:not(.item-owned):not(.item-locked) {
            background: var(--bg-card-hover);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 0 16px rgba(125,249,255,0.15);
        }

        .item-card:active:not(.item-owned):not(.item-locked) {
            transform: translateY(0);
        }

        .item-card.item-owned {
            border-color: var(--owned);
            cursor: default;
            opacity: 0.75;
        }

        .item-card.item-locked {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .item-icon {
            font-size: 2rem;
            line-height: 1;
        }

        .item-name {
            font-family: var(--font-title);
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .item-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            flex-grow: 1;
        }

        .item-cost {
            font-family: var(--font-title);
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 700;
        }

        .item-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.7rem;
            font-family: var(--font-title);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .badge-owned {
            background: var(--owned);
            color: #fff;
        }

        .badge-locked {
            background: var(--disabled);
            color: var(--text-dim);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 24px;
            font-family: var(--font-title);
            font-size: 0.9rem;
            z-index: 100;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(125,249,255,0.2);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Footer actions */
        .shop-footer {
            text-align: center;
            padding: 32px 0 48px;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .btn {
            font-family: var(--font-title);
            font-size: 0.85rem;
            font-weight: 700;
            border: none;
            border-radius: var(--radius);
            padding: 12px 28px;
            cursor: pointer;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn-primary:hover {
            background: #a0fbff;
            box-shadow: 0 0 20px rgba(125,249,255,0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-dim);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .continue-btn {
            font-size: 1rem;
            padding: 16px 40px;
        }

        /* Import modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 40px rgba(125,249,255,0.1);
        }

        .modal h3 {
            font-family: var(--font-title);
            margin-bottom: 12px;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .modal textarea {
            width: 100%;
            height: 140px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Skill Tree */
        .skill-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-points-display {
            font-family: var(--font-title);
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .skill-tree-svg-wrap {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 16px;
            margin-top: 12px;
            overflow-x: auto;
        }

        .skill-tree-svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }

        .skill-tree-svg .branch-label {
            font-family: 'Orbitron', 'Courier New', monospace;
            font-size: 12px;
            font-weight: 700;
            fill: var(--text);
        }

        .skill-tree-svg .node-circle {
            stroke-width: 2.5;
            cursor: pointer;
            transition: filter 0.2s;
        }

        .skill-tree-svg .node-circle:hover {
            filter: brightness(1.3);
        }

        .skill-tree-svg .node-circle.locked {
            cursor: not-allowed;
            opacity: 0.35;
        }

        .skill-tree-svg .node-circle.locked:hover {
            filter: none;
        }

        .skill-tree-svg .node-circle.unlocked {
            filter: drop-shadow(0 0 8px currentColor);
        }

        .skill-tree-svg .node-label {
            font-family: 'Exo 2', 'Segoe UI', sans-serif;
            font-size: 11px;
            fill: var(--text);
            pointer-events: none;
        }

        .skill-tree-svg .node-label.dimmed {
            opacity: 0.4;
        }

        .skill-tree-svg .connector {
            stroke-width: 2;
            fill: none;
        }

        .skill-tree-svg .connector.active {
            opacity: 1;
        }

        .skill-tree-svg .connector.inactive {
            opacity: 0.2;
            stroke-dasharray: 4 3;
        }

        .skill-tree-tooltip {
            position: fixed;
            background: #0a0a28;
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 10px 14px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--text);
            max-width: 220px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.4;
            box-shadow: 0 0 16px rgba(125,249,255,0.15);
        }

        .skill-tree-tooltip.visible {
            opacity: 1;
        }

        .skill-tree-tooltip .tt-name {
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .skill-tree-tooltip .tt-status {
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Inventory system */
        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .equip-slots {
            display: flex;
            gap: 12px;
            margin: 12px 0 16px;
            flex-wrap: wrap;
        }

        .equip-slot {
            width: 80px;
            height: 80px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            position: relative;
            cursor: default;
            transition: border-color 0.2s;
        }

        .equip-slot.filled {
            border-style: solid;
            cursor: pointer;
        }

        .equip-slot.filled:hover {
            border-color: var(--danger);
        }

        .equip-slot .slot-label {
            font-family: var(--font-title);
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .equip-slot .slot-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        .equip-slot .slot-name {
            font-size: 0.65rem;
            color: var(--text);
            text-align: center;
            line-height: 1.1;
            max-width: 72px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .equip-slot.slot-empty .slot-icon {
            font-size: 1.2rem;
            color: var(--text-dim);
            opacity: 0.3;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .inv-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
            position: relative;
        }

        .inv-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-1px);
        }

        .inv-item.inv-equipped {
            border-color: var(--accent);
        }

        .inv-item .inv-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        .inv-item .inv-name {
            font-family: var(--font-title);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .inv-item .inv-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .inv-item .inv-rarity {
            font-family: var(--font-title);
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1px 6px;
            border-radius: 3px;
        }

        .rarity-common    { color: #cccccc; border: 1px solid #666; }
        .rarity-rare       { color: #4488ff; border: 1px solid #4488ff; }
        .rarity-epic       { color: #aa44ff; border: 1px solid #aa44ff; }
        .rarity-legendary  { color: #ffcc00; border: 1px solid #ffcc00; }

        .inv-item .inv-equipped-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.6rem;
            font-family: var(--font-title);
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .inv-empty-msg {
            color: var(--text-dim);
            font-style: italic;
            padding: 16px;
            text-align: center;
        }

        .inv-tooltip {
            position: fixed;
            background: #0a0a28;
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 10px 14px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--text);
            max-width: 240px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.4;
            box-shadow: 0 0 16px rgba(125,249,255,0.15);
        }

        .inv-tooltip.visible {
            opacity: 1;
        }

        .inv-tooltip .tt-name {
            font-family: var(--font-title);
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .inv-tooltip .tt-action {
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .inv-tooltip .tt-salvage {
            font-size: 0.8rem;
            margin-top: 4px;
            color: var(--accent);
            font-weight: 700;
        }

        .inv-salvage-btn {
            font-family: var(--font-title);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            margin-top: 4px;
        }

        .inv-salvage-btn:hover {
            background: var(--danger);
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-title {
                font-size: 1.5rem;
                letter-spacing: 2px;
            }

            .player-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }

            .item-card {
                padding: 12px;
            }

            .item-icon {
                font-size: 1.6rem;
            }

            .footer-buttons {
                flex-direction: column;
                align-items: center;
            }

            .continue-btn {
                width: 100%;
                max-width: 320px;
            }

            .skill-tree-svg-wrap {
                padding: 16px 8px;
            }

            .skill-tree-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .inv-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .equip-slots {
                justify-content: center;
                width: 100%;
            }

            .equip-slot {
                width: 70px;
                height: 70px;
            }

            .inv-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="shop-container">
        <header class="shop-header">
            <h1 class="shop-title" id="shop-title">Warlock's Sanctum</h1>
            <p class="shop-subtitle" id="shop-subtitle">Deepen your arcane knowledge, Warlock</p>
        </header>

        <div class="player-bar">
            <div class="gold-display">
                <span class="gold-icon">&#x2B50;</span>
                <span id="gold-amount">0</span> Gold
            </div>
            <div class="stats-display">
                <span>Runs: <strong id="stat-runs">0</strong></span>
                <span>Total Kills: <strong id="stat-kills">0</strong></span>
                <span>World: <strong id="stat-world">1</strong></span>
                <span>Skill Pts: <strong id="stat-sp">0</strong></span>
            </div>
        </div>

        <section class="category" id="cat-stats">
            <h2 class="category-title"><span class="cat-icon">&#x1F52E;</span>Arcane Studies</h2>
            <div class="item-grid" id="grid-stats"></div>
        </section>

        <section class="category" id="cat-weapons">
            <h2 class="category-title"><span class="cat-icon">&#x26A1;</span>Stellar Armaments</h2>
            <div class="item-grid" id="grid-weapons"></div>
        </section>

        <section class="category" id="cat-passives">
            <h2 class="category-title"><span class="cat-icon">&#x2728;</span>Void Blessings</h2>
            <div class="item-grid" id="grid-passives"></div>
        </section>

        <section class="category" id="cat-skilltree">
            <div class="skill-tree-header">
                <h2 class="category-title" style="border-bottom:none;margin-bottom:0;padding-bottom:0">
                    <span class="cat-icon">&#x1F30C;</span>Constellation Map
                </h2>
                <div class="skill-points-display">
                    Skill Points: <span id="skill-points-count">0</span>
                </div>
            </div>
            <div class="skill-tree-svg-wrap">
                <svg id="skill-tree-svg" class="skill-tree-svg" viewBox="0 0 760 340" xmlns="http://www.w3.org/2000/svg"></svg>
            </div>
        </section>

        <div class="skill-tree-tooltip" id="skill-tooltip"></div>

        <section class="category" id="cat-inventory">
            <div class="inv-header">
                <h2 class="category-title" style="border-bottom:none;margin-bottom:0;padding-bottom:0">
                    <span class="cat-icon">&#x1F392;</span>Cargo Hold
                </h2>
                <div style="font-size:0.9rem;color:var(--text-dim);display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                    <span>Equipped: <strong id="inv-equip-count">0</strong>/3</span>
                    <span>Slots: <strong id="inv-slot-info">0/6</strong></span>
                    <button class="btn btn-secondary" id="inv-expand-btn" onclick="buyInventorySlots()" style="font-size:0.8rem;padding:4px 12px">Expand</button>
                </div>
            </div>
            <div class="equip-slots" id="equip-slots"></div>
            <div class="inv-grid" id="inv-grid"></div>
        </section>

        <div class="inv-tooltip" id="inv-tooltip"></div>

        <footer class="shop-footer">
            <div class="footer-buttons">
                <button class="btn btn-secondary" onclick="exportSave()">Export Save</button>
                <button class="btn btn-secondary" onclick="openImportModal()">Import Save</button>
                <button class="btn btn-danger" onclick="resetSave()">Reset Save</button>
            </div>
            <a id="continue-btn" class="btn btn-primary continue-btn" href="#">
                Continue to Next World &#x2192;
            </a>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <h3>Import Save</h3>
            <p style="margin-bottom:8px; color:var(--text-dim); font-size:0.9rem;">
                Paste exported JSON below. This will overwrite your current save.
            </p>
            <textarea id="import-textarea" placeholder='{"version":1,"gold":0,...}'></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="doImport()">Import</button>
            </div>
        </div>
    </div>

    <script>
    // =========================================================================
    // SHOP CONFIGURATION - Cosmic / Void Bazaar Theme
    // =========================================================================
    const SHOP_CONFIG = {
        title: 'Warlock\u2019s Sanctum',
        subtitle: 'Deepen your arcane knowledge, Warlock',
        nextWorld: { label: 'Cosmic Frontier', url: 'cosmic.html' },
        // Warlock class: ability-scaling caster focused on Damage (ability power), Max HP (survivability), Pickup Radius
        // Universal: Speed, Pickup Radius
        // De-emphasized: Attack Speed, Crit (warlock uses ability scaling, not crit)
        statUpgrades: [
            // Damage: +15% per tier (Ability Power -- core Warlock stat)
            { id: 'dmg1', name: 'Arcane Flux I',      desc: '+15% Damage \u2014 Channel raw void energy',       icon: '\u{1F52E}', cost: 50,   stat: 'damage', mult: 1.15 },
            { id: 'dmg2', name: 'Arcane Flux II',     desc: '+15% Damage \u2014 Refine the cosmic flow',        icon: '\u{1F52E}', cost: 150,  stat: 'damage', mult: 1.15, requires: 'dmg1' },
            { id: 'dmg3', name: 'Arcane Flux III',    desc: '+15% Damage \u2014 Tap forbidden frequencies',     icon: '\u{1F52E}', cost: 400,  stat: 'damage', mult: 1.15, requires: 'dmg2' },
            { id: 'dmg4', name: 'Arcane Flux IV',     desc: '+15% Damage \u2014 Resonate with dark matter',     icon: '\u{1F52E}', cost: 800,  stat: 'damage', mult: 1.15, requires: 'dmg3' },
            { id: 'dmg5', name: 'Arcane Flux V',      desc: '+15% Damage \u2014 Become the singularity',        icon: '\u{1F52E}', cost: 1500, stat: 'damage', mult: 1.15, requires: 'dmg4' },
            // Max HP: +20 flat per tier (survivability for glass cannon caster)
            { id: 'hp1', name: 'Stellar Core I',      desc: '+20 Max HP \u2014 Infuse stardust into your hull',    icon: '\u2665', cost: 50,   stat: 'maxHp', bonus: 20 },
            { id: 'hp2', name: 'Stellar Core II',     desc: '+20 Max HP \u2014 Neutron-reinforced plating',        icon: '\u2665', cost: 150,  stat: 'maxHp', bonus: 20, requires: 'hp1' },
            { id: 'hp3', name: 'Stellar Core III',    desc: '+20 Max HP \u2014 White dwarf compression armor',     icon: '\u2665', cost: 400,  stat: 'maxHp', bonus: 20, requires: 'hp2' },
            { id: 'hp4', name: 'Stellar Core IV',     desc: '+20 Max HP \u2014 Pulsar-grade shielding',            icon: '\u2665', cost: 800,  stat: 'maxHp', bonus: 20, requires: 'hp3' },
            { id: 'hp5', name: 'Stellar Core V',      desc: '+20 Max HP \u2014 Supernova remnant fortress',        icon: '\u2665', cost: 1500, stat: 'maxHp', bonus: 20, requires: 'hp4' },
            // Speed: +10% per tier (universal - repositioning)
            { id: 'spd1', name: 'Warp Drive I',       desc: '+10% Speed \u2014 Tachyon-laced thrusters',          icon: '\u27A4', cost: 50,   stat: 'speed', mult: 1.10 },
            { id: 'spd2', name: 'Warp Drive II',      desc: '+10% Speed \u2014 Graviton wave surfing',            icon: '\u27A4', cost: 150,  stat: 'speed', mult: 1.10, requires: 'spd1' },
            { id: 'spd3', name: 'Warp Drive III',     desc: '+10% Speed \u2014 Fold spacetime around you',        icon: '\u27A4', cost: 400,  stat: 'speed', mult: 1.10, requires: 'spd2' },
            { id: 'spd4', name: 'Warp Drive IV',      desc: '+10% Speed \u2014 Alcubierre micro-bubble',          icon: '\u27A4', cost: 800,  stat: 'speed', mult: 1.10, requires: 'spd3' },
            { id: 'spd5', name: 'Warp Drive V',       desc: '+10% Speed \u2014 Phase through reality itself',     icon: '\u27A4', cost: 1500, stat: 'speed', mult: 1.10, requires: 'spd4' },
            // Pickup Radius: +15 flat per tier (universal)
            { id: 'pick1', name: 'Gravity Well I',    desc: '+15 Pickup Range \u2014 Micro black hole attractor',  icon: '\u2609', cost: 50,   stat: 'pickupRadius', bonus: 15 },
            { id: 'pick2', name: 'Gravity Well II',   desc: '+15 Pickup Range \u2014 Singularity siphon',          icon: '\u2609', cost: 150,  stat: 'pickupRadius', bonus: 15, requires: 'pick1' },
            { id: 'pick3', name: 'Gravity Well III',  desc: '+15 Pickup Range \u2014 Event horizon expansion',     icon: '\u2609', cost: 400,  stat: 'pickupRadius', bonus: 15, requires: 'pick2' },
            { id: 'pick4', name: 'Gravity Well IV',   desc: '+15 Pickup Range \u2014 Spacetime curvature lens',    icon: '\u2609', cost: 800,  stat: 'pickupRadius', bonus: 15, requires: 'pick3' },
            { id: 'pick5', name: 'Gravity Well V',    desc: '+15 Pickup Range \u2014 Absolute gravitational pull', icon: '\u2609', cost: 1500, stat: 'pickupRadius', bonus: 15, requires: 'pick4' }
        ],
        // Starting weapons: Warlock favors area, field, chain, beam (ability-style)
        startingWeapons: [
            { id: 'w_area',       name: 'Supernova Burst',    desc: 'Start with an expanding stellar shockwave',     icon: '\u29BF', cost: 150, weaponType: 'area' },
            { id: 'w_field',      name: 'Dark Matter Zone',   desc: 'Start with a persistent dark energy field',     icon: '\u2742', cost: 150, weaponType: 'field' },
            { id: 'w_chain',      name: 'Neutrino Chain',     desc: 'Start with a particle-chaining beam',           icon: '\u2301', cost: 200, weaponType: 'chain' },
            { id: 'w_beam',       name: 'Quasar Beam',        desc: 'Start with a sustained quasar energy beam',     icon: '\u2588', cost: 200, weaponType: 'beam' },
            { id: 'w_rain',       name: 'Meteor Shower',      desc: 'Start with a rain of cosmic debris from above', icon: '\u2663', cost: 200, weaponType: 'rain' },
            { id: 'w_orbit',      name: 'Asteroid Ring',      desc: 'Start with orbiting space debris shield',       icon: '\u2B21', cost: 250, weaponType: 'orbit' },
            { id: 'w_projectile', name: 'Plasma Bolt',        desc: 'Start with a superheated plasma projector',     icon: '\u2726', cost: 250, weaponType: 'projectile' },
            { id: 'w_boomerang',  name: 'Orbital Disc',       desc: 'Start with a returning graviton disc',          icon: '\u25C9', cost: 250, weaponType: 'boomerang' }
        ],
        passives: [
            { id: 'p_regen',      name: 'Cosmic Mending',     desc: 'Recover 1 HP every 5 seconds from starlight',  icon: '\u2661', cost: 150 },
            { id: 'p_xpboost',    name: 'Nebula Wisdom',      desc: '+10% XP from all sources in the cosmos',       icon: '\u2605', cost: 150 },
            { id: 'p_lifesteal',  name: 'Void Siphon',        desc: 'Drain 1% of damage dealt as life force',       icon: '\u2764', cost: 200 },
            { id: 'p_critchance', name: 'Singularity Focus',  desc: '+5% critical hit chance via quantum targeting', icon: '\u25C8', cost: 250 }
        ]
    };

    // =========================================================================
    // SAVE MANAGER (mirrors engine.js SaveManager, standalone for the shop)
    // =========================================================================
    const STORAGE_KEY = 'survivors-save';
    const SAVE_VERSION = 1;

    function defaultSave() {
        return {
            version: SAVE_VERSION,
            gold: 0,
            skillPoints: 0,
            currentWorld: 0,
            inventory: [],
            equipped: [],
            inventorySlots: 6,
            skillTree: {},
            upgrades: {},
            stats: { totalKills: 0, bestTime: 0, runsCompleted: 0 }
        };
    }

    function loadSave() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultSave();
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object') return defaultSave();
            return migrateSave(parsed);
        } catch (e) {
            console.warn('Shop: failed to load save', e);
            return defaultSave();
        }
    }

    function migrateSave(data) {
        const base = defaultSave();
        return {
            version: SAVE_VERSION,
            gold: typeof data.gold === 'number' ? data.gold : base.gold,
            skillPoints: typeof data.skillPoints === 'number' ? data.skillPoints : base.skillPoints,
            currentWorld: typeof data.currentWorld === 'number' ? data.currentWorld : base.currentWorld,
            inventory: Array.isArray(data.inventory) ? data.inventory : base.inventory,
            equipped: Array.isArray(data.equipped) ? data.equipped.slice(0, 3) : base.equipped,
            inventorySlots: typeof data.inventorySlots === 'number' ? data.inventorySlots : base.inventorySlots,
            skillTree: data.skillTree && typeof data.skillTree === 'object' ? data.skillTree : base.skillTree,
            upgrades: data.upgrades && typeof data.upgrades === 'object' ? data.upgrades : base.upgrades,
            stats: {
                totalKills: (data.stats && typeof data.stats.totalKills === 'number') ? data.stats.totalKills : base.stats.totalKills,
                bestTime: (data.stats && typeof data.stats.bestTime === 'number') ? data.stats.bestTime : base.stats.bestTime,
                runsCompleted: (data.stats && typeof data.stats.runsCompleted === 'number') ? data.stats.runsCompleted : base.stats.runsCompleted
            }
        };
    }

    function writeSave(data) {
        try {
            const merged = Object.assign(defaultSave(), data);
            merged.version = SAVE_VERSION;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
            return true;
        } catch (e) {
            console.warn('Shop: failed to write save', e);
            return false;
        }
    }

    // =========================================================================
    // STATE
    // =========================================================================
    let saveData = loadSave();

    function isOwned(itemId) {
        return !!(saveData.upgrades && saveData.upgrades[itemId]);
    }

    function canAfford(cost) {
        return saveData.gold >= cost;
    }

    function requirementMet(item) {
        if (!item.requires) return true;
        return isOwned(item.requires);
    }

    // =========================================================================
    // RENDERING
    // =========================================================================
    function renderHeader() {
        document.getElementById('shop-title').textContent = SHOP_CONFIG.title;
        document.getElementById('shop-subtitle').textContent = SHOP_CONFIG.subtitle;
        document.title = SHOP_CONFIG.title;

        const continueBtn = document.getElementById('continue-btn');
        continueBtn.href = SHOP_CONFIG.nextWorld.url;
        continueBtn.innerHTML = 'Continue to ' + SHOP_CONFIG.nextWorld.label + ' &#x2192;';
    }

    function renderPlayerBar() {
        document.getElementById('gold-amount').textContent = saveData.gold;
        document.getElementById('stat-runs').textContent = saveData.stats.runsCompleted;
        document.getElementById('stat-kills').textContent = saveData.stats.totalKills;
        document.getElementById('stat-world').textContent = (saveData.currentWorld || 0) + 1;
        var spEl = document.getElementById('stat-sp');
        if (spEl) spEl.textContent = saveData.skillPoints || 0;
    }

    function createCard(item, category) {
        const owned = isOwned(item.id);
        const affordable = canAfford(item.cost);
        const reqMet = requirementMet(item);
        const locked = !affordable || !reqMet;

        const card = document.createElement('div');
        card.className = 'item-card' + (owned ? ' item-owned' : '') + (!owned && locked ? ' item-locked' : '');

        let badgeHTML = '';
        if (owned) {
            badgeHTML = '<span class="item-badge badge-owned">Owned</span>';
        } else if (!reqMet) {
            badgeHTML = '<span class="item-badge badge-locked">Locked</span>';
        }

        card.innerHTML =
            badgeHTML +
            '<div class="item-icon">' + item.icon + '</div>' +
            '<div class="item-name">' + item.name + '</div>' +
            '<div class="item-desc">' + item.desc + '</div>' +
            '<div class="item-cost">' + (owned ? 'Acquired' : item.cost + ' Gold') + '</div>';

        if (!owned) {
            card.addEventListener('click', function () {
                buyItem(item, category);
            });
        }

        return card;
    }

    function renderGrid(gridId, items, category) {
        const grid = document.getElementById(gridId);
        grid.innerHTML = '';
        items.forEach(function (item) {
            grid.appendChild(createCard(item, category));
        });
    }

    function renderAll() {
        renderHeader();
        renderPlayerBar();
        renderGrid('grid-stats', SHOP_CONFIG.statUpgrades, 'stat');
        renderGrid('grid-weapons', SHOP_CONFIG.startingWeapons, 'weapon');
        renderGrid('grid-passives', SHOP_CONFIG.passives, 'passive');
        if (typeof renderSkillTree === 'function') renderSkillTree();
        renderInventory();
    }

    // =========================================================================
    // PURCHASE LOGIC
    // =========================================================================
    function buyItem(item, category) {
        if (isOwned(item.id)) return;
        if (!canAfford(item.cost)) {
            showToast('Insufficient stellar credits!');
            return;
        }
        if (!requirementMet(item)) {
            showToast('Requires: ' + item.requires);
            return;
        }

        saveData.gold -= item.cost;
        if (!saveData.upgrades) saveData.upgrades = {};
        saveData.upgrades[item.id] = {
            category: category,
            purchasedAt: Date.now()
        };

        // Store additional metadata depending on category
        if (item.stat) {
            saveData.upgrades[item.id].stat = item.stat;
            if (item.mult !== undefined) saveData.upgrades[item.id].mult = item.mult;
            if (item.bonus !== undefined) saveData.upgrades[item.id].bonus = item.bonus;
        }
        if (item.weaponType) {
            saveData.upgrades[item.id].weaponType = item.weaponType;
        }

        writeSave(saveData);
        renderAll();
        showToast('Acquired: ' + item.name);
    }

    // =========================================================================
    // EXPORT / IMPORT / RESET
    // =========================================================================
    function exportSave() {
        const json = JSON.stringify(saveData, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(json).then(function () {
                showToast('Save transmitted to clipboard!');
            }).catch(function () {
                fallbackExport(json);
            });
        } else {
            fallbackExport(json);
        }
    }

    function fallbackExport(json) {
        const ta = document.getElementById('import-textarea');
        ta.value = json;
        openImportModal();
        ta.select();
        showToast('Save data displayed. Copy it manually.');
    }

    function openImportModal() {
        document.getElementById('import-modal').classList.add('active');
    }

    function closeImportModal() {
        document.getElementById('import-modal').classList.remove('active');
    }

    function doImport() {
        const raw = document.getElementById('import-textarea').value.trim();
        if (!raw) {
            showToast('Paste a save JSON first.');
            return;
        }
        try {
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== 'object' || typeof parsed.version !== 'number') {
                showToast('Invalid save format.');
                return;
            }
            saveData = migrateSave(parsed);
            writeSave(saveData);
            closeImportModal();
            renderAll();
            showToast('Save imported successfully!');
        } catch (e) {
            showToast('Failed to parse JSON.');
        }
    }

    function resetSave() {
        if (!confirm('Purge all progress from the void? This cannot be undone.')) return;
        saveData = defaultSave();
        writeSave(saveData);
        renderAll();
        showToast('Save purged.');
    }

    // =========================================================================
    // TOAST
    // =========================================================================
    let toastTimer = null;
    function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(function () {
            el.classList.remove('show');
        }, 2200);
    }

    // Close import modal on overlay click
    document.getElementById('import-modal').addEventListener('click', function (e) {
        if (e.target === this) closeImportModal();
    });

    // =========================================================================
    // SKILL TREE
    // =========================================================================
    const SKILL_TREE_DEF = {
        offense: {
            label: 'Offense',
            color: '#e74c3c',
            icon: '\u2694',
            nodes: [
                { id: 'offense_1', name: 'Critical Eye',       desc: '+8% critical hit chance' },
                { id: 'offense_2', name: 'Lethal Strikes',     desc: '+50% critical damage multiplier' },
                { id: 'offense_3', name: 'Multi-Projectile',   desc: '+2 extra projectiles per volley' },
                { id: 'offense_4', name: 'Piercing Shots',     desc: 'Projectiles pierce +3 enemies' }
            ]
        },
        defense: {
            label: 'Defense',
            color: '#3498db',
            icon: '\u26E8',
            nodes: [
                { id: 'defense_1', name: 'Regeneration',       desc: 'Recover 1 HP every 5 seconds' },
                { id: 'defense_2', name: 'Dash Shield',        desc: 'Extended invulnerability after dashing' },
                { id: 'defense_3', name: 'Damage Reduction',   desc: '15% less damage taken' },
                { id: 'defense_4', name: 'Second Life',        desc: 'Revive once per run at 30% HP' }
            ]
        },
        utility: {
            label: 'Utility',
            color: '#2ecc71',
            icon: '\u2728',
            nodes: [
                { id: 'utility_1', name: 'Long Dash',          desc: '+40% dash distance' },
                { id: 'utility_2', name: 'Quick Recovery',     desc: '-30% dash cooldown' },
                { id: 'utility_3', name: 'Magnet Range',       desc: '+40 pickup radius' },
                { id: 'utility_4', name: 'XP Multiplier',      desc: '+25% XP from all sources' }
            ]
        }
    };

    function getSpentPoints() {
        const st = saveData.skillTree || {};
        return Object.keys(st).filter(function(k) { return st[k]; }).length;
    }

    function getAvailablePoints() {
        return (saveData.skillPoints || 0) - getSpentPoints();
    }

    function isSkillUnlocked(skillId) {
        return !!(saveData.skillTree && saveData.skillTree[skillId]);
    }

    function canUnlockSkill(skillId) {
        if (isSkillUnlocked(skillId)) return false;
        if (getAvailablePoints() <= 0) return false;
        for (var bk in SKILL_TREE_DEF) {
            var nodes = SKILL_TREE_DEF[bk].nodes;
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].id === skillId) {
                    if (i === 0) return true;
                    return isSkillUnlocked(nodes[i - 1].id);
                }
            }
        }
        return false;
    }

    function unlockSkill(skillId) {
        if (!canUnlockSkill(skillId)) return;
        if (!saveData.skillTree) saveData.skillTree = {};
        saveData.skillTree[skillId] = true;
        writeSave(saveData);
        renderSkillTree();
        showToast('Constellation unlocked!');
    }

    function renderSkillTree() {
        var svg = document.getElementById('skill-tree-svg');
        svg.innerHTML = '';

        document.getElementById('skill-points-count').textContent = getAvailablePoints();

        var branches = Object.keys(SKILL_TREE_DEF);
        var rowHeight = 90;
        var startY = 50;
        var nodeStartX = 180;
        var nodeSpacingX = 150;
        var nodeRadius = 22;

        for (var bi = 0; bi < branches.length; bi++) {
            var branch = SKILL_TREE_DEF[branches[bi]];
            var cy = startY + bi * rowHeight;

            // Branch label + icon
            var labelEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelEl.setAttribute('x', 16);
            labelEl.setAttribute('y', cy + 5);
            labelEl.setAttribute('class', 'branch-label');
            labelEl.setAttribute('fill', branch.color);
            labelEl.textContent = branch.icon + ' ' + branch.label;
            svg.appendChild(labelEl);

            // Connector lines
            for (var ni = 0; ni < branch.nodes.length; ni++) {
                var nx = nodeStartX + ni * nodeSpacingX;
                var prevUnlocked = ni === 0 ? true : isSkillUnlocked(branch.nodes[ni - 1].id);
                var thisUnlocked = isSkillUnlocked(branch.nodes[ni].id);

                if (ni === 0) {
                    var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 110);
                    line.setAttribute('y1', cy);
                    line.setAttribute('x2', nx - nodeRadius);
                    line.setAttribute('y2', cy);
                    line.setAttribute('stroke', branch.color);
                    line.setAttribute('class', 'connector ' + (thisUnlocked ? 'active' : 'inactive'));
                    svg.appendChild(line);
                } else {
                    var prevX = nodeStartX + (ni - 1) * nodeSpacingX;
                    var lineConn = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    lineConn.setAttribute('x1', prevX + nodeRadius);
                    lineConn.setAttribute('y1', cy);
                    lineConn.setAttribute('x2', nx - nodeRadius);
                    lineConn.setAttribute('y2', cy);
                    lineConn.setAttribute('stroke', branch.color);
                    lineConn.setAttribute('class', 'connector ' + (thisUnlocked ? 'active' : 'inactive'));
                    svg.appendChild(lineConn);
                }

                // Node circle
                var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', nx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', nodeRadius);
                circle.setAttribute('stroke', branch.color);

                var canUnlock = canUnlockSkill(branch.nodes[ni].id);
                if (thisUnlocked) {
                    circle.setAttribute('fill', branch.color);
                    circle.setAttribute('class', 'node-circle unlocked');
                } else if (canUnlock) {
                    circle.setAttribute('fill', 'rgba(' + hexToRgb(branch.color) + ', 0.15)');
                    circle.setAttribute('class', 'node-circle');
                    circle.setAttribute('stroke-dasharray', '4 3');
                } else {
                    circle.setAttribute('fill', 'rgba(20,20,50,0.6)');
                    circle.setAttribute('class', 'node-circle locked');
                }

                (function(node, branchDef, canU) {
                    circle.addEventListener('click', function() {
                        if (canU) unlockSkill(node.id);
                        else if (isSkillUnlocked(node.id)) showToast('Already unlocked');
                        else if (getAvailablePoints() <= 0) showToast('No skill points available');
                        else showToast('Unlock previous constellations first');
                    });
                    circle.addEventListener('mouseenter', function(ev) {
                        showSkillTooltip(ev, node, branchDef, canU);
                    });
                    circle.addEventListener('mousemove', function(ev) {
                        moveSkillTooltip(ev);
                    });
                    circle.addEventListener('mouseleave', function() {
                        hideSkillTooltip();
                    });
                })(branch.nodes[ni], branch, canUnlock);

                svg.appendChild(circle);

                // Node icon inside circle
                var iconText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                iconText.setAttribute('x', nx);
                iconText.setAttribute('y', cy + 1);
                iconText.setAttribute('text-anchor', 'middle');
                iconText.setAttribute('dominant-baseline', 'middle');
                iconText.setAttribute('font-size', '14');
                iconText.setAttribute('fill', thisUnlocked ? '#fff' : (canUnlock ? branch.color : '#555'));
                iconText.setAttribute('pointer-events', 'none');
                iconText.textContent = (ni + 1);
                svg.appendChild(iconText);

                // Node name label below
                var nameLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                nameLabel.setAttribute('x', nx);
                nameLabel.setAttribute('y', cy + nodeRadius + 16);
                nameLabel.setAttribute('text-anchor', 'middle');
                nameLabel.setAttribute('class', 'node-label' + (!thisUnlocked && !canUnlock ? ' dimmed' : ''));
                nameLabel.textContent = branch.nodes[ni].name;
                svg.appendChild(nameLabel);
            }
        }
    }

    function hexToRgb(hex) {
        var r = parseInt(hex.slice(1, 3), 16);
        var g = parseInt(hex.slice(3, 5), 16);
        var b = parseInt(hex.slice(5, 7), 16);
        return r + ',' + g + ',' + b;
    }

    var tooltipEl = document.getElementById('skill-tooltip');

    function showSkillTooltip(ev, node, branch, canUnlock) {
        var unlocked = isSkillUnlocked(node.id);
        var statusText = unlocked ? 'Unlocked' :
            (canUnlock ? 'Click to unlock (1 point)' :
            (getAvailablePoints() <= 0 ? 'No skill points' : 'Unlock previous first'));
        tooltipEl.innerHTML =
            '<div class="tt-name" style="color:' + branch.color + '">' + node.name + '</div>' +
            '<div>' + node.desc + '</div>' +
            '<div class="tt-status">' + statusText + '</div>';
        tooltipEl.classList.add('visible');
        moveSkillTooltip(ev);
    }

    function moveSkillTooltip(ev) {
        tooltipEl.style.left = (ev.clientX + 14) + 'px';
        tooltipEl.style.top = (ev.clientY + 14) + 'px';
    }

    function hideSkillTooltip() {
        tooltipEl.classList.remove('visible');
    }

    // =========================================================================
    // LOOT TABLE (must match engine.js LOOT_TABLE)
    // =========================================================================
    const LOOT_TABLE = [
        { id: 'loot_rusty_shield',    name: 'Rusty Shield',      rarity: 'common',    icon: '\u26E8', desc: '+5 Max HP' },
        { id: 'loot_old_boots',       name: 'Old Boots',         rarity: 'common',    icon: '\u{1F462}', desc: '+5% Speed' },
        { id: 'loot_cracked_lens',    name: 'Cracked Lens',      rarity: 'common',    icon: '\u{1F50D}', desc: '+10 Pickup Radius' },
        { id: 'loot_torn_gloves',     name: 'Torn Gloves',       rarity: 'common',    icon: '\u{1F9E4}', desc: '+5% Damage' },
        { id: 'loot_dull_whetstone',  name: 'Dull Whetstone',    rarity: 'common',    icon: '\u25C8', desc: '+5% Attack Speed' },
        { id: 'loot_vampiric_ring',   name: 'Vampiric Ring',     rarity: 'rare',      icon: '\u{1F48D}', desc: '2% Lifesteal' },
        { id: 'loot_scope',           name: 'Marksman Scope',    rarity: 'rare',      icon: '\u{1F3AF}', desc: '+10% Crit Chance' },
        { id: 'loot_iron_plate',      name: 'Iron Plate',        rarity: 'rare',      icon: '\u2694', desc: '+10% Defense' },
        { id: 'loot_swift_cloak',     name: 'Swift Cloak',       rarity: 'rare',      icon: '\u{1F9E3}', desc: '+15% Speed' },
        { id: 'loot_emerald_charm',   name: 'Emerald Charm',     rarity: 'rare',      icon: '\u{1F48E}', desc: '+20% XP Gain' },
        { id: 'loot_berserker_gauntlet', name: 'Berserker Gauntlet', rarity: 'epic',  icon: '\u{1F94A}', desc: '+30% Damage below 50% HP' },
        { id: 'loot_magnet_core',     name: 'Magnet Core',       rarity: 'epic',      icon: '\u{1F9F2}', desc: '+50 Pickup Radius' },
        { id: 'loot_crimson_heart',   name: 'Crimson Heart',     rarity: 'epic',      icon: '\u2764', desc: '+40 Max HP, +Regen' },
        { id: 'loot_quicksilver',     name: 'Quicksilver Vial',  rarity: 'epic',      icon: '\u{1F4A7}', desc: '-25% Dash Cooldown' },
        { id: 'loot_war_drum',        name: 'War Drum',          rarity: 'epic',      icon: '\u{1F941}', desc: '+25% Attack Speed' },
        { id: 'loot_phoenix_feather', name: 'Phoenix Feather',   rarity: 'legendary', icon: '\u{1F525}', desc: 'Auto-revive once per run' },
        { id: 'loot_crown_of_thorns', name: 'Crown of Thorns',   rarity: 'legendary', icon: '\u{1F451}', desc: 'Reflect 20% damage taken' },
        { id: 'loot_void_orb',        name: 'Void Orb',          rarity: 'legendary', icon: '\u{1F311}', desc: '+50% Damage, -20% Max HP' }
    ];

    const RARITY_ORDER = { legendary: 0, epic: 1, rare: 2, common: 3 };
    const SALVAGE_VALUES = { common: 5, rare: 15, epic: 40, legendary: 100 };

    const INV_SLOT_UPGRADES = [
        { slots: 8,  cost: 100 },
        { slots: 10, cost: 250 },
        { slots: 12, cost: 500 },
        { slots: 16, cost: 1000 },
        { slots: 20, cost: 2000 }
    ];

    function getLootById(id) {
        return LOOT_TABLE.find(function(item) { return item.id === id; }) || null;
    }

    function isEquipped(itemId) {
        return saveData.equipped && saveData.equipped.indexOf(itemId) !== -1;
    }

    function equipItem(itemId) {
        if (!saveData.equipped) saveData.equipped = [];
        if (saveData.equipped.length >= 3) {
            showToast('Unequip an item first (max 3)');
            return;
        }
        if (saveData.equipped.indexOf(itemId) !== -1) return;
        saveData.equipped.push(itemId);
        writeSave(saveData);
        renderInventory();
        renderPlayerBar();
        showToast('Equipped!');
    }

    function unequipItem(itemId) {
        if (!saveData.equipped) return;
        var idx = saveData.equipped.indexOf(itemId);
        if (idx === -1) return;
        saveData.equipped.splice(idx, 1);
        writeSave(saveData);
        renderInventory();
        renderPlayerBar();
        showToast('Unequipped');
    }

    function salvageItem(itemId) {
        var loot = getLootById(itemId);
        if (!loot) return;
        if (isEquipped(itemId)) {
            showToast('Unequip before salvaging');
            return;
        }
        var goldValue = SALVAGE_VALUES[loot.rarity] || 5;
        var invIdx = saveData.inventory.indexOf(itemId);
        if (invIdx === -1) return;
        saveData.inventory.splice(invIdx, 1);
        saveData.gold += goldValue;
        writeSave(saveData);
        renderInventory();
        renderPlayerBar();
        showToast('Salvaged ' + loot.name + ' for ' + goldValue + 'g');
    }

    function buyInventorySlots() {
        var currentSlots = saveData.inventorySlots || 6;
        var upgrade = INV_SLOT_UPGRADES.find(function(u) { return u.slots > currentSlots; });
        if (!upgrade) {
            showToast('Inventory fully upgraded!');
            return;
        }
        if (saveData.gold < upgrade.cost) {
            showToast('Not enough gold! Need ' + upgrade.cost + 'g');
            return;
        }
        saveData.gold -= upgrade.cost;
        saveData.inventorySlots = upgrade.slots;
        writeSave(saveData);
        renderInventory();
        renderPlayerBar();
        showToast('Inventory expanded to ' + upgrade.slots + ' slots!');
    }

    function renderInventory() {
        var equipped = saveData.equipped || [];
        var inventory = saveData.inventory || [];
        var maxSlots = saveData.inventorySlots || 6;

        var itemCounts = {};
        inventory.forEach(function(id) {
            itemCounts[id] = (itemCounts[id] || 0) + 1;
        });
        var uniqueIds = Object.keys(itemCounts);
        var usedSlots = uniqueIds.length;

        document.getElementById('inv-equip-count').textContent = equipped.length;
        var slotInfo = document.getElementById('inv-slot-info');
        if (slotInfo) slotInfo.textContent = usedSlots + '/' + maxSlots;

        var expandBtn = document.getElementById('inv-expand-btn');
        if (expandBtn) {
            var nextUpgrade = INV_SLOT_UPGRADES.find(function(u) { return u.slots > maxSlots; });
            if (nextUpgrade) {
                expandBtn.textContent = 'Expand to ' + nextUpgrade.slots + ' (' + nextUpgrade.cost + 'g)';
                expandBtn.style.display = 'inline-block';
                expandBtn.disabled = saveData.gold < nextUpgrade.cost;
                expandBtn.style.opacity = saveData.gold >= nextUpgrade.cost ? '1' : '0.5';
            } else {
                expandBtn.textContent = 'Max Slots';
                expandBtn.style.display = 'inline-block';
                expandBtn.disabled = true;
                expandBtn.style.opacity = '0.5';
            }
        }

        var slotsContainer = document.getElementById('equip-slots');
        slotsContainer.innerHTML = '';
        for (var s = 0; s < 3; s++) {
            var slotDiv = document.createElement('div');
            if (s < equipped.length) {
                var loot = getLootById(equipped[s]);
                if (loot) {
                    slotDiv.className = 'equip-slot filled rarity-' + loot.rarity;
                    slotDiv.style.borderColor = getRarityColor(loot.rarity);
                    slotDiv.innerHTML =
                        '<div class="slot-icon">' + loot.icon + '</div>' +
                        '<div class="slot-name">' + loot.name + '</div>';
                    (function(id) {
                        slotDiv.addEventListener('click', function() { unequipItem(id); });
                        slotDiv.addEventListener('mouseenter', function(ev) {
                            showInvTooltip(ev, getLootById(id), true, false);
                        });
                        slotDiv.addEventListener('mousemove', function(ev) { moveInvTooltip(ev); });
                        slotDiv.addEventListener('mouseleave', function() { hideInvTooltip(); });
                    })(equipped[s]);
                }
            } else {
                slotDiv.className = 'equip-slot slot-empty';
                slotDiv.innerHTML =
                    '<div class="slot-icon">+</div>' +
                    '<div class="slot-label">Empty</div>';
            }
            slotsContainer.appendChild(slotDiv);
        }

        var grid = document.getElementById('inv-grid');
        grid.innerHTML = '';

        if (inventory.length === 0) {
            grid.innerHTML = '<div class="inv-empty-msg">No items yet. Defeat cosmic entities to find loot!</div>';
            return;
        }

        uniqueIds.sort(function(a, b) {
            var la = getLootById(a);
            var lb = getLootById(b);
            if (!la || !lb) return 0;
            return (RARITY_ORDER[la.rarity] || 99) - (RARITY_ORDER[lb.rarity] || 99);
        });

        uniqueIds.forEach(function(itemId) {
            var loot = getLootById(itemId);
            if (!loot) return;
            var count = itemCounts[itemId];
            var eq = isEquipped(itemId);
            var salvageGold = SALVAGE_VALUES[loot.rarity] || 5;

            var card = document.createElement('div');
            card.className = 'inv-item' + (eq ? ' inv-equipped' : '');

            var countLabel = count > 1 ? ' x' + count : '';
            card.innerHTML =
                (eq ? '<div class="inv-equipped-badge">Equipped</div>' : '') +
                '<div class="inv-icon">' + loot.icon + '</div>' +
                '<div class="inv-name" style="color:' + getRarityColor(loot.rarity) + '">' + loot.name + countLabel + '</div>' +
                '<div class="inv-desc">' + loot.desc + '</div>' +
                '<div class="inv-rarity rarity-' + loot.rarity + '">' + loot.rarity + '</div>' +
                (eq ? '' : '<button class="inv-salvage-btn" title="Salvage for ' + salvageGold + 'g">Salvage ' + salvageGold + 'g</button>');

            (function(id, isEq) {
                card.addEventListener('click', function(ev) {
                    if (ev.target.classList.contains('inv-salvage-btn')) return;
                    if (isEq) unequipItem(id);
                    else equipItem(id);
                });
                card.addEventListener('mouseenter', function(ev) {
                    showInvTooltip(ev, getLootById(id), isEq, !isEq);
                });
                card.addEventListener('mousemove', function(ev) { moveInvTooltip(ev); });
                card.addEventListener('mouseleave', function() { hideInvTooltip(); });
            })(itemId, eq);

            var salvBtn = card.querySelector('.inv-salvage-btn');
            if (salvBtn) {
                (function(id) {
                    salvBtn.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        salvageItem(id);
                    });
                })(itemId);
            }

            grid.appendChild(card);
        });
    }

    function getRarityColor(rarity) {
        var colors = { common: '#cccccc', rare: '#4488ff', epic: '#aa44ff', legendary: '#ffcc00' };
        return colors[rarity] || '#cccccc';
    }

    // Inventory tooltips
    var invTooltipEl = document.getElementById('inv-tooltip');

    function showInvTooltip(ev, loot, isEquipped, showSalvage) {
        if (!loot) return;
        var action = isEquipped ? 'Click to unequip' : 'Click to equip';
        var salvageText = showSalvage ? '<div class="tt-salvage">Salvage: ' + (SALVAGE_VALUES[loot.rarity] || 5) + 'g</div>' : '';
        invTooltipEl.innerHTML =
            '<div class="tt-name" style="color:' + getRarityColor(loot.rarity) + '">' + loot.icon + ' ' + loot.name + '</div>' +
            '<div>' + loot.desc + '</div>' +
            salvageText +
            '<div class="tt-action">' + action + '</div>';
        invTooltipEl.classList.add('visible');
        moveInvTooltip(ev);
    }

    function moveInvTooltip(ev) {
        invTooltipEl.style.left = (ev.clientX + 14) + 'px';
        invTooltipEl.style.top = (ev.clientY + 14) + 'px';
    }

    function hideInvTooltip() {
        invTooltipEl.classList.remove('visible');
    }

    // =========================================================================
    // INIT
    // =========================================================================
    renderAll();
    renderSkillTree();
    </script>
</body>
</html>
