<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survivors Arena</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-font: 'Press Start 2P', monospace;
            --ui-font: 'Cinzel', serif;
            --bone: #e8dcc8;
            --gold: #d4af37;
            --shadow: #0a0a0f;
            --mist: #b0a090;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #000;
            color: var(--bone);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-family: var(--pixel-font);
        }

        /* ========== CANVAS ========== */
        #camp-canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            cursor: default;
        }

        /* ========== HUD BAR ========== */
        .hud-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 36px;
            background: rgba(5,5,10,0.85);
            border-bottom: 2px solid rgba(212,175,55,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            z-index: 10;
            font-size: 8px;
        }

        .hud-left, .hud-right { display: flex; align-items: center; gap: 12px; }

        .hud-back {
            color: var(--gold);
            text-decoration: none;
            letter-spacing: 0.08em;
            transition: color 0.2s;
        }
        .hud-back:hover { color: #fff; }

        .hud-title {
            color: var(--bone);
            letter-spacing: 0.12em;
            font-size: 9px;
        }

        .hud-gold {
            color: var(--gold);
            letter-spacing: 0.05em;
        }

        .hud-btn {
            background: none;
            border: 1px solid rgba(212,175,55,0.3);
            color: var(--gold);
            font-family: var(--pixel-font);
            font-size: 8px;
            padding: 3px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hud-btn:hover {
            background: rgba(212,175,55,0.15);
            border-color: var(--gold);
        }

        /* ========== INFO PANEL ========== */
        .info-panel {
            position: fixed;
            top: 36px; right: 0;
            width: 300px;
            height: calc(100vh - 36px);
            background: rgba(8,6,12,0.92);
            border-left: 2px solid rgba(212,175,55,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 9;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .info-panel.open { transform: translateX(0); }

        .info-close {
            position: absolute;
            top: 8px; right: 8px;
            background: none;
            border: none;
            color: var(--mist);
            font-family: var(--pixel-font);
            font-size: 10px;
            cursor: pointer;
        }
        .info-close:hover { color: #fff; }

        .info-icon { font-size: 32px; margin-bottom: 8px; }
        .info-class-name {
            font-family: var(--pixel-font);
            font-size: 12px;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }
        .info-class-desc {
            font-family: var(--pixel-font);
            font-size: 7px;
            color: rgba(232,220,200,0.55);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .info-section-label {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        /* Stat bars */
        .info-stat-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }
        .info-stat-label {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(232,220,200,0.5);
            width: 42px;
            text-align: right;
            flex-shrink: 0;
        }
        .info-stat-track {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.08);
        }
        .info-stat-fill {
            height: 100%;
            transition: width 0.4s;
        }
        .info-stat-val {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(232,220,200,0.4);
            width: 28px;
        }

        /* Weapon tags */
        .info-weapons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 16px;
        }
        .info-weapon-tag {
            font-family: var(--pixel-font);
            font-size: 6px;
            padding: 3px 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: rgba(232,220,200,0.6);
        }

        /* Passive */
        .info-passive-name {
            font-family: var(--pixel-font);
            font-size: 7px;
            margin-bottom: 2px;
        }
        .info-passive-desc {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(232,220,200,0.45);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        /* Play button */
        .info-play-btn {
            display: block;
            width: 100%;
            font-family: var(--pixel-font);
            font-size: 9px;
            text-align: center;
            padding: 10px;
            border: 2px solid var(--gold);
            background: rgba(139,0,0,0.3);
            color: var(--bone);
            cursor: pointer;
            text-decoration: none;
            letter-spacing: 0.08em;
            transition: all 0.2s;
        }
        .info-play-btn:hover {
            background: rgba(139,0,0,0.6);
            box-shadow: 0 0 16px rgba(212,175,55,0.3);
        }
        .info-play-btn.locked {
            opacity: 0.35;
            cursor: not-allowed;
            border-color: rgba(176,160,144,0.2);
            background: rgba(10,10,15,0.5);
        }

        .info-lock-msg {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(176,160,144,0.4);
            text-align: center;
            margin-top: 6px;
        }

        /* ========== SETTINGS PANEL ========== */
        .settings-panel {
            position: fixed;
            top: 36px; right: 0;
            width: 280px;
            background: rgba(8,6,12,0.95);
            border-left: 2px solid rgba(212,175,55,0.3);
            border-bottom: 2px solid rgba(212,175,55,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 11;
            padding: 16px;
        }
        .settings-panel.open { transform: translateX(0); }

        .settings-title {
            font-family: var(--pixel-font);
            font-size: 9px;
            color: var(--gold);
            margin-bottom: 14px;
            letter-spacing: 0.08em;
        }

        .settings-btn {
            display: block;
            width: 100%;
            font-family: var(--pixel-font);
            font-size: 7px;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(212,175,55,0.25);
            background: rgba(15,10,10,0.8);
            color: var(--mist);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .settings-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .settings-btn.danger:hover {
            border-color: #cc3333;
            color: #ff4444;
        }

        .settings-divider {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.06);
            margin: 12px 0;
        }

        .settings-link {
            display: block;
            font-family: var(--pixel-font);
            font-size: 7px;
            color: var(--mist);
            text-decoration: none;
            padding: 6px 0;
            transition: color 0.2s;
        }
        .settings-link:hover { color: var(--gold); }

        /* ========== HALL OF FAME PANEL ========== */
        .hof-panel {
            position: fixed;
            top: 36px; left: 50%;
            transform: translateX(-50%) translateY(-120%);
            width: 520px;
            max-width: 92vw;
            background: rgba(8,6,12,0.95);
            border: 2px solid rgba(212,175,55,0.3);
            z-index: 11;
            padding: 20px;
            transition: transform 0.3s ease;
        }
        .hof-panel.open { transform: translateX(-50%) translateY(8px); }

        .hof-title {
            font-family: var(--pixel-font);
            font-size: 10px;
            color: var(--gold);
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 0.1em;
        }

        .hof-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .hof-card {
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(10,10,15,0.6);
            padding: 12px 8px;
            text-align: center;
        }
        .hof-card.played { border-color: rgba(212,175,55,0.2); }
        .hof-card.unplayed { opacity: 0.35; }

        .hof-card-name {
            font-family: var(--pixel-font);
            font-size: 7px;
            margin-bottom: 6px;
        }
        .hof-stars {
            font-size: 10px;
            margin-bottom: 6px;
            letter-spacing: 2px;
        }
        .hof-star-on { color: var(--gold); }
        .hof-star-off { color: rgba(176,160,144,0.15); }

        .hof-stat {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(232,220,200,0.5);
            line-height: 1.8;
        }
        .hof-stat strong { color: var(--bone); }

        .hof-no-data {
            font-family: var(--pixel-font);
            font-size: 6px;
            color: rgba(176,160,144,0.3);
            font-style: italic;
        }

        .hof-close {
            display: block;
            margin: 14px auto 0;
            font-family: var(--pixel-font);
            font-size: 7px;
            background: none;
            border: 1px solid rgba(212,175,55,0.3);
            color: var(--mist);
            padding: 6px 16px;
            cursor: pointer;
        }
        .hof-close:hover { color: var(--gold); border-color: var(--gold); }

        /* ========== IMPORT MODAL ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #111;
            border: 2px solid rgba(212,175,55,0.3);
            padding: 20px;
            max-width: 420px;
            width: 90%;
        }
        .modal h3 {
            font-family: var(--pixel-font);
            font-size: 9px;
            color: var(--gold);
            margin-bottom: 12px;
        }
        .modal textarea {
            width: 100%;
            height: 100px;
            background: #0a0a0f;
            border: 1px solid rgba(212,175,55,0.2);
            color: var(--bone);
            font-family: monospace;
            font-size: 10px;
            padding: 8px;
            resize: vertical;
            margin-bottom: 12px;
        }
        .modal-btns {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            font-family: var(--pixel-font);
            font-size: 7px;
            color: var(--bone);
            background: rgba(15,10,10,0.95);
            border: 1px solid rgba(212,175,55,0.3);
            padding: 8px 18px;
            z-index: 200;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            .info-panel {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 55vh;
                transform: translateY(100%);
                border-left: none;
                border-top: 2px solid rgba(212,175,55,0.3);
            }
            .info-panel.open { transform: translateY(0); }

            .hof-grid { grid-template-columns: repeat(2, 1fr); }

            .hud-title { display: none; }
        }
    </style>
</head>
<body>

<!-- HUD Bar -->
<div class="hud-bar">
    <div class="hud-left">
        <a href="../index.html" class="hud-back">&larr; ARCADE</a>
        <span class="hud-title">SURVIVORS ARENA</span>
    </div>
    <div class="hud-right">
        <span class="hud-gold" id="hud-gold"></span>
        <button class="hud-btn" id="btn-hof" title="Hall of Fame">FAME</button>
        <button class="hud-btn" id="btn-settings" title="Settings">GEAR</button>
    </div>
</div>

<!-- Game Canvas -->
<canvas id="camp-canvas"></canvas>

<!-- Character Info Panel -->
<div class="info-panel" id="info-panel">
    <button class="info-close" id="info-close">&times;</button>
    <div id="info-content"></div>
</div>

<!-- Settings Panel -->
<div class="settings-panel" id="settings-panel">
    <div class="settings-title">SETTINGS</div>
    <button class="settings-btn" id="btn-export">EXPORT SAVE</button>
    <button class="settings-btn" id="btn-import">IMPORT SAVE</button>
    <button class="settings-btn danger" id="btn-reset">RESET PROGRESS</button>
    <hr class="settings-divider">
    <a href="../squad-survivors.html" class="settings-link">&rarr; SQUAD SURVIVORS</a>
    <a href="../index.html" class="settings-link">&rarr; GAMES ARCADE</a>
</div>

<!-- Hall of Fame Panel -->
<div class="hof-panel" id="hof-panel">
    <div class="hof-title">HALL OF FAME</div>
    <div id="hof-content"></div>
    <button class="hof-close" id="hof-close">CLOSE</button>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
    <div class="modal">
        <h3>IMPORT SAVE</h3>
        <textarea id="import-textarea" placeholder="Paste save JSON here..."></textarea>
        <div class="modal-btns">
            <button class="hud-btn" id="btn-import-cancel">CANCEL</button>
            <button class="hud-btn" id="btn-import-confirm">IMPORT</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// SURVIVORS CAMPFIRE HUB
// ============================================================

const STORAGE_KEY = 'survivors-save';
const W = 480, H = 270;

// ---- CLASS DATA ----
const CLASSES = [
    {
        id: 'gunner', name: 'Gunner', icon: '\u{1F52B}',
        desc: 'Ranged specialist. Excels with projectiles and precision damage.',
        worldKey: 'cyberpunk', worldName: 'Cyberpunk', worldIndex: 0,
        stats: { hp: 80, speed: 160, damage: 1.2, defense: 0.9 },
        weapons: ['\u{1F52B} Projectile', '\u{1F4A0} Beam', '\u26A1 Chain'],
        passive: { name: 'Targeting System', desc: '+10% crit, +15% projectile speed' },
        accentColor: '#00ffff', accentColor2: '#ff0080',
        gradient: ['#ff0080', '#00ffff']
    },
    {
        id: 'darkknight', name: 'Dark Knight', icon: '\u2694\uFE0F',
        desc: 'Melee bruiser. Thrives in close combat with lifesteal and AoE.',
        worldKey: 'gothic', worldName: 'Gothic', worldIndex: 1,
        stats: { hp: 120, speed: 140, damage: 1.0, defense: 1.2 },
        weapons: ['\u{1F4A5} Area', '\u26A1 Chain', '\u{1F300} Field'],
        passive: { name: 'Blood Pact', desc: '+8% lifesteal, +10% AoE size' },
        accentColor: '#d4af37', accentColor2: '#8b0000',
        gradient: ['#8b0000', '#d4af37']
    },
    {
        id: 'ranger', name: 'Ranger', icon: '\u{1F3F9}',
        desc: 'Swift hunter. Masters boomerangs, traps, and damage over time.',
        worldKey: 'forest', worldName: 'Forest', worldIndex: 2,
        stats: { hp: 90, speed: 180, damage: 1.0, defense: 1.0 },
        weapons: ['\u{1F4AB} Boomerang', '\u{1F327}\uFE0F Rain', '\u{1F300} Field'],
        passive: { name: 'Wild Stride', desc: '+15% move speed, +10% evasion' },
        accentColor: '#33cc33', accentColor2: '#228b22',
        gradient: ['#228b22', '#daa520']
    },
    {
        id: 'warlock', name: 'Warlock', icon: '\u{1F52E}',
        desc: 'Arcane caster. Commands gravity, orbits, and devastating area spells.',
        worldKey: 'cosmic', worldName: 'Cosmic', worldIndex: 3,
        stats: { hp: 70, speed: 150, damage: 1.3, defense: 0.8 },
        weapons: ['\u{1F4AB} Orbit', '\u{1F300} Field', '\u{1F4A5} Area'],
        passive: { name: 'Arcane Attunement', desc: '+15% ability power, -10% cooldowns' },
        accentColor: '#9933ff', accentColor2: '#4169e1',
        gradient: ['#9933ff', '#4169e1']
    }
];

// Character positions in logical space (semicircle around fire)
const FIRE_X = 240, FIRE_Y = 180;
const CHAR_POSITIONS = [
    { x: 150, y: 165 },  // Gunner (top-left)
    { x: 330, y: 165 },  // Dark Knight (top-right)
    { x: 170, y: 205 },  // Ranger (bottom-left)
    { x: 310, y: 205 }   // Warlock (bottom-right)
];
const CHAR_RADIUS = 12;
const HIT_RADIUS = 18;

// ---- CAMP THEMES ----
const CAMP_THEMES = [
    { // Cyberpunk - Neon Outpost
        skyTop: '#050515', skyBot: '#0a0a2a',
        groundColor: '#0d0d2a', groundLine: '#1a1a3a',
        fireColors: ['#00ffff', '#ff0080', '#bf00ff'],
        fireGlow: 'rgba(0,255,255,0.15)',
        ambientColor: 'rgba(0,255,255,0.3)',
        bgElements: 'neon',
        particleType: 'rain'
    },
    { // Gothic - Cathedral Grounds
        skyTop: '#0a0a0f', skyBot: '#1a1020',
        groundColor: '#1a1420', groundLine: '#251830',
        fireColors: ['#ff8c00', '#d4af37', '#cc3333'],
        fireGlow: 'rgba(255,140,0,0.15)',
        ambientColor: 'rgba(212,175,55,0.2)',
        bgElements: 'gothic',
        particleType: 'dust'
    },
    { // Forest - The Grove
        skyTop: '#050a05', skyBot: '#0a1a0a',
        groundColor: '#0d1a0d', groundLine: '#1a2a1a',
        fireColors: ['#ff8c00', '#ffaa33', '#ff6600'],
        fireGlow: 'rgba(255,140,0,0.12)',
        ambientColor: 'rgba(51,204,51,0.25)',
        bgElements: 'forest',
        particleType: 'fireflies'
    },
    { // Cosmic - Station Deck
        skyTop: '#030308', skyBot: '#080818',
        groundColor: '#080818', groundLine: '#151530',
        fireColors: ['#9933ff', '#ff3366', '#4169e1'],
        fireGlow: 'rgba(153,51,255,0.12)',
        ambientColor: 'rgba(153,51,255,0.2)',
        bgElements: 'cosmic',
        particleType: 'sparks'
    }
];

// ---- STATE ----
let canvas, ctx;
let scale = 1;
let offsetX = 0, offsetY = 0;
let hoveredChar = -1;
let selectedChar = -1;
let mouseX = 0, mouseY = 0;
let fireParticles = [];
let ambientParticles = [];
let settingsOpen = false;
let hofOpen = false;
let lastTime = 0;

// ---- SAVE ----
function loadSave() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const d = JSON.parse(raw);
        return (d && typeof d === 'object') ? d : null;
    } catch(e) { return null; }
}

function getSaveState() {
    const save = loadSave();
    const currentWorld = save ? (typeof save.currentWorld === 'number' ? save.currentWorld : 0) : -1;
    const completed = save ? currentWorld >= CLASSES.length : false;
    const gold = save ? (save.gold || 0) : 0;
    const kills = save ? ((save.stats && save.stats.totalKills) || 0) : 0;
    const runs = save ? ((save.stats && save.stats.runsCompleted) || 0) : 0;
    const bestTime = save ? ((save.stats && save.stats.bestTime) || 0) : 0;
    return { save, currentWorld, completed, gold, kills, runs, bestTime };
}

function getCharState(classIdx) {
    const { save, currentWorld, completed } = getSaveState();
    if (!save) return classIdx === 0 ? 'current' : 'locked';
    if (completed) return 'cleared';
    const wi = CLASSES[classIdx].worldIndex;
    if (wi < currentWorld) return 'cleared';
    if (wi === currentWorld) return 'current';
    return 'locked';
}

function getThemeIndex() {
    const { save, currentWorld, completed } = getSaveState();
    if (!save) return 0;
    if (completed) return 3; // show cosmic after completion
    return Math.min(currentWorld, 3);
}

// ---- CANVAS SETUP ----
function initCanvas() {
    canvas = document.getElementById('camp-canvas');
    ctx = canvas.getContext('2d');
    resize();
    window.addEventListener('resize', resize);
}

function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = W * dpr;
    canvas.height = H * dpr;

    // Scale to fill viewport while maintaining aspect ratio
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const aspect = W / H;
    const vAspect = vw / vh;

    if (vAspect > aspect) {
        // Wider than needed - fill height
        scale = vh / H;
        offsetX = (vw - W * scale) / 2;
        offsetY = 0;
    } else {
        // Taller than needed - fill width
        scale = vw / W;
        offsetX = 0;
        offsetY = (vh - H * scale) / 2;
    }

    canvas.style.width = (W * scale) + 'px';
    canvas.style.height = (H * scale) + 'px';
    canvas.style.left = offsetX + 'px';
    canvas.style.top = offsetY + 'px';

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.imageSmoothingEnabled = false;
}

function screenToLogical(sx, sy) {
    return {
        x: (sx - offsetX) / scale,
        y: (sy - offsetY) / scale
    };
}

// ---- FIRE PARTICLES ----
function spawnFireParticle() {
    const theme = CAMP_THEMES[getThemeIndex()];
    const color = theme.fireColors[Math.floor(Math.random() * theme.fireColors.length)];
    return {
        x: FIRE_X + (Math.random() - 0.5) * 16,
        y: FIRE_Y - 2,
        vx: (Math.random() - 0.5) * 0.4,
        vy: -0.5 - Math.random() * 0.8,
        life: 1,
        decay: 0.01 + Math.random() * 0.015,
        size: 1 + Math.random() * 2,
        color: color
    };
}

function initParticles() {
    fireParticles = [];
    for (let i = 0; i < 30; i++) {
        const p = spawnFireParticle();
        p.life = Math.random();
        p.y = FIRE_Y - Math.random() * 20;
        fireParticles.push(p);
    }
    ambientParticles = [];
    for (let i = 0; i < 40; i++) {
        ambientParticles.push({
            x: Math.random() * W,
            y: Math.random() * H,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            life: Math.random(),
            size: 0.5 + Math.random() * 1.5,
            phase: Math.random() * Math.PI * 2
        });
    }
}

function updateParticles(dt) {
    // Fire
    for (let i = fireParticles.length - 1; i >= 0; i--) {
        const p = fireParticles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= p.decay;
        if (p.life <= 0) {
            fireParticles[i] = spawnFireParticle();
        }
    }

    // Ambient
    const pType = CAMP_THEMES[getThemeIndex()].particleType;
    for (const p of ambientParticles) {
        if (pType === 'rain') {
            p.vy = 1.5;
            p.vx = -0.2;
        } else if (pType === 'fireflies') {
            p.vx = Math.sin(p.phase + p.life * 4) * 0.15;
            p.vy = Math.cos(p.phase + p.life * 3) * 0.1;
        } else if (pType === 'sparks') {
            p.vy = -0.3 - Math.sin(p.phase) * 0.2;
            p.vx = Math.cos(p.phase) * 0.15;
        } else { // dust
            p.vx = Math.sin(p.phase + p.life * 2) * 0.08;
            p.vy = -0.05;
        }
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.002;
        if (p.life <= 0 || p.x < -5 || p.x > W + 5 || p.y < -5 || p.y > H + 5) {
            p.x = Math.random() * W;
            p.y = pType === 'rain' ? -5 : (pType === 'sparks' ? H + 5 : Math.random() * H);
            p.life = 1;
            p.phase = Math.random() * Math.PI * 2;
        }
    }
}

// ---- DRAWING ----
function drawSky(time) {
    const theme = CAMP_THEMES[getThemeIndex()];
    const grd = ctx.createLinearGradient(0, 0, 0, H * 0.6);
    grd.addColorStop(0, theme.skyTop);
    grd.addColorStop(1, theme.skyBot);
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, W, H * 0.6);
}

function drawStars(time) {
    const ti = getThemeIndex();
    if (ti !== 3 && ti !== 0) return; // Only cosmic and cyberpunk get stars
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    for (let i = 0; i < 50; i++) {
        const sx = (i * 137.5 + 23) % W;
        const sy = (i * 73.3 + 11) % (H * 0.5);
        const twinkle = 0.3 + 0.7 * Math.abs(Math.sin(time * 0.5 + i * 0.7));
        ctx.globalAlpha = twinkle * (ti === 3 ? 0.8 : 0.4);
        ctx.fillRect(Math.floor(sx), Math.floor(sy), 1, 1);
    }
    ctx.globalAlpha = 1;
}

function drawBackgroundElements(time) {
    const theme = CAMP_THEMES[getThemeIndex()];
    const bgType = theme.bgElements;

    ctx.save();
    if (bgType === 'neon') {
        // Neon buildings silhouettes
        ctx.fillStyle = '#0d0d2a';
        const buildings = [
            [30, 60, 40, 100], [80, 80, 35, 80], [130, 50, 50, 110],
            [300, 70, 45, 90], [360, 45, 55, 115], [420, 85, 40, 75]
        ];
        for (const [bx, by, bw, bh] of buildings) {
            ctx.fillRect(bx, H * 0.55 - bh, bw, bh);
        }
        // Neon sign accents
        const glow = 0.5 + 0.5 * Math.sin(time * 2);
        ctx.strokeStyle = `rgba(0,255,255,${0.2 + glow * 0.3})`;
        ctx.lineWidth = 1;
        ctx.strokeRect(42, H * 0.55 - 85, 16, 6);
        ctx.strokeStyle = `rgba(255,0,128,${0.2 + glow * 0.2})`;
        ctx.strokeRect(310, H * 0.55 - 60, 20, 4);
    } else if (bgType === 'gothic') {
        // Castle spires + dead trees
        ctx.fillStyle = '#12081a';
        // Spires
        const spires = [[60, 40], [100, 60], [380, 50], [430, 35]];
        for (const [sx, sh] of spires) {
            ctx.beginPath();
            ctx.moveTo(sx - 8, H * 0.55);
            ctx.lineTo(sx, H * 0.55 - sh);
            ctx.lineTo(sx + 8, H * 0.55);
            ctx.fill();
        }
        // Dead trees
        ctx.strokeStyle = '#1a1020';
        ctx.lineWidth = 2;
        for (const tx of [20, 160, 320, 460]) {
            ctx.beginPath();
            ctx.moveTo(tx, H * 0.55);
            ctx.lineTo(tx, H * 0.55 - 30);
            ctx.moveTo(tx, H * 0.55 - 20);
            ctx.lineTo(tx - 8, H * 0.55 - 30);
            ctx.moveTo(tx, H * 0.55 - 15);
            ctx.lineTo(tx + 6, H * 0.55 - 25);
            ctx.stroke();
        }
    } else if (bgType === 'forest') {
        // Tall trees + mushrooms
        ctx.fillStyle = '#0a180a';
        const trees = [[25, 70], [70, 90], [120, 80], [350, 85], [400, 75], [450, 95]];
        for (const [tx, th] of trees) {
            // Trunk
            ctx.fillStyle = '#1a1008';
            ctx.fillRect(tx - 3, H * 0.55 - th, 6, th);
            // Canopy
            ctx.fillStyle = '#0a1a0a';
            ctx.beginPath();
            ctx.arc(tx, H * 0.55 - th - 10, 18, 0, Math.PI * 2);
            ctx.fill();
        }
        // Mushroom glow
        const glow = 0.3 + 0.3 * Math.sin(time * 1.5);
        ctx.fillStyle = `rgba(51,204,51,${glow})`;
        ctx.beginPath();
        ctx.arc(180, H * 0.55 - 5, 3, 0, Math.PI * 2);
        ctx.arc(290, H * 0.55 - 3, 2, 0, Math.PI * 2);
        ctx.fill();
    } else if (bgType === 'cosmic') {
        // Nebula glow + distant station
        const glow = 0.3 + 0.2 * Math.sin(time * 0.8);
        const nebula = ctx.createRadialGradient(100, 40, 0, 100, 40, 60);
        nebula.addColorStop(0, `rgba(153,51,255,${glow})`);
        nebula.addColorStop(1, 'transparent');
        ctx.fillStyle = nebula;
        ctx.fillRect(40, 0, 120, 100);

        const nebula2 = ctx.createRadialGradient(380, 30, 0, 380, 30, 50);
        nebula2.addColorStop(0, `rgba(65,105,225,${glow * 0.7})`);
        nebula2.addColorStop(1, 'transparent');
        ctx.fillStyle = nebula2;
        ctx.fillRect(330, 0, 100, 80);

        // Station silhouette
        ctx.fillStyle = '#101025';
        ctx.fillRect(350, H * 0.55 - 35, 80, 35);
        ctx.fillRect(370, H * 0.55 - 50, 8, 15);
        ctx.fillRect(410, H * 0.55 - 45, 6, 10);
    }
    ctx.restore();
}

function drawGround(time) {
    const theme = CAMP_THEMES[getThemeIndex()];
    const groundY = Math.floor(H * 0.55);

    // Ground fill
    ctx.fillStyle = theme.groundColor;
    ctx.fillRect(0, groundY, W, H - groundY);

    // Ground lines (texture)
    ctx.strokeStyle = theme.groundLine;
    ctx.lineWidth = 1;
    for (let i = 0; i < 8; i++) {
        const ly = groundY + 10 + i * 12 + Math.sin(time * 0.3 + i) * 0.5;
        ctx.beginPath();
        ctx.moveTo(0, ly);
        for (let x = 0; x < W; x += 20) {
            ctx.lineTo(x, ly + Math.sin(x * 0.03 + i) * 2);
        }
        ctx.stroke();
    }
}

function drawCampfire(time) {
    const theme = CAMP_THEMES[getThemeIndex()];

    // Glow on ground
    const glowR = 50 + Math.sin(time * 3) * 8;
    const glow = ctx.createRadialGradient(FIRE_X, FIRE_Y + 5, 0, FIRE_X, FIRE_Y + 5, glowR);
    glow.addColorStop(0, theme.fireGlow);
    glow.addColorStop(1, 'transparent');
    ctx.fillStyle = glow;
    ctx.fillRect(FIRE_X - glowR, FIRE_Y + 5 - glowR, glowR * 2, glowR * 2);

    // Logs
    ctx.fillStyle = '#3a2510';
    ctx.save();
    ctx.translate(FIRE_X, FIRE_Y + 4);
    ctx.rotate(-0.3);
    ctx.fillRect(-12, -2, 24, 4);
    ctx.rotate(0.6);
    ctx.fillRect(-12, -2, 24, 4);
    ctx.restore();

    // Stone ring
    ctx.fillStyle = '#2a2a2a';
    for (let i = 0; i < 8; i++) {
        const a = (i / 8) * Math.PI * 2;
        const sx = FIRE_X + Math.cos(a) * 14;
        const sy = FIRE_Y + 4 + Math.sin(a) * 6;
        ctx.fillRect(Math.floor(sx) - 2, Math.floor(sy) - 1, 4, 3);
    }

    // Fire particles
    for (const p of fireParticles) {
        ctx.globalAlpha = p.life * 0.8;
        ctx.fillStyle = p.color;
        ctx.fillRect(Math.floor(p.x), Math.floor(p.y), Math.ceil(p.size), Math.ceil(p.size));
    }
    ctx.globalAlpha = 1;

    // Core glow
    const coreGlow = 0.6 + 0.4 * Math.sin(time * 5);
    ctx.fillStyle = `rgba(255,200,100,${coreGlow * 0.5})`;
    ctx.beginPath();
    ctx.arc(FIRE_X, FIRE_Y - 3, 6, 0, Math.PI * 2);
    ctx.fill();
}

function drawAmbientParticles(time) {
    const theme = CAMP_THEMES[getThemeIndex()];
    const pType = theme.particleType;

    for (const p of ambientParticles) {
        const alpha = p.life * 0.5;
        if (pType === 'rain') {
            ctx.strokeStyle = `rgba(0,200,255,${alpha * 0.3})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x - 1, p.y + 3);
            ctx.stroke();
        } else if (pType === 'fireflies') {
            const flicker = 0.3 + 0.7 * Math.abs(Math.sin(time * 3 + p.phase));
            ctx.fillStyle = `rgba(180,255,50,${alpha * flicker})`;
            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 1, 1);
            // Tiny glow
            ctx.fillStyle = `rgba(180,255,50,${alpha * flicker * 0.3})`;
            ctx.fillRect(Math.floor(p.x) - 1, Math.floor(p.y) - 1, 3, 3);
        } else if (pType === 'sparks') {
            ctx.fillStyle = `rgba(200,150,255,${alpha * 0.6})`;
            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 1, 1);
        } else { // dust
            ctx.fillStyle = `rgba(200,180,150,${alpha * 0.25})`;
            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), 1, 1);
        }
    }
}

// ---- CHARACTER DRAWING ----
function drawCharGunner(x, y, r, time, highlight) {
    ctx.save();
    ctx.translate(x, y);
    // Body
    ctx.beginPath();
    ctx.moveTo(-r*0.6, -r*0.2);
    ctx.lineTo(-r*0.8, r);
    ctx.lineTo(-r*0.2, r*0.8);
    ctx.lineTo(r*0.2, r*0.8);
    ctx.lineTo(r*0.8, r);
    ctx.lineTo(r*0.6, -r*0.2);
    ctx.closePath();
    ctx.fillStyle = highlight ? '#2a2a4a' : '#1a1a2a';
    ctx.fill();
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 1;
    ctx.stroke();
    // Torso
    ctx.fillStyle = highlight ? '#354060' : '#252540';
    ctx.fillRect(-r*0.4, -r*0.3, r*0.8, r*0.6);
    // Helmet
    ctx.beginPath();
    ctx.arc(0, -r*0.6, r*0.4, 0, Math.PI*2);
    ctx.fillStyle = '#1a1a30';
    ctx.fill();
    ctx.strokeStyle = '#ff0080';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    // Visor
    const glow = 0.5 + 0.5*Math.sin(time*3);
    ctx.fillStyle = `rgba(0,255,255,${0.6+glow*0.4})`;
    ctx.beginPath();
    ctx.ellipse(0, -r*0.65, r*0.28, r*0.08, 0, 0, Math.PI*2);
    ctx.fill();
    // Shoulders
    ctx.fillStyle = '#ff0080';
    ctx.fillRect(-r*0.55, -r*0.25, r*0.12, r*0.06);
    ctx.fillRect(r*0.43, -r*0.25, r*0.12, r*0.06);
    ctx.restore();
}

function drawCharDarkKnight(x, y, r, time, highlight) {
    ctx.save();
    ctx.translate(x, y);
    // Cloak
    ctx.beginPath();
    ctx.moveTo(-r*0.7, -r*0.3);
    ctx.lineTo(-r*0.9, r);
    ctx.lineTo(r*0.9, r);
    ctx.lineTo(r*0.7, -r*0.3);
    ctx.closePath();
    ctx.fillStyle = highlight ? '#3a2a5a' : '#2a1a3a';
    ctx.fill();
    // Body
    ctx.beginPath();
    ctx.arc(0, -r*0.1, r*0.65, 0, Math.PI*2);
    ctx.fillStyle = highlight ? '#4a3a5a' : '#3a2a4a';
    ctx.fill();
    // Head
    ctx.beginPath();
    ctx.arc(0, -r*0.7, r*0.35, 0, Math.PI*2);
    ctx.fillStyle = '#e8dcc8';
    ctx.fill();
    // Eyes
    const glow = 0.5 + 0.5*Math.sin(time*3);
    ctx.fillStyle = `rgba(212,175,55,${0.6+glow*0.4})`;
    ctx.beginPath();
    ctx.arc(-r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.arc(r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
}

function drawCharRanger(x, y, r, time, highlight) {
    ctx.save();
    ctx.translate(x, y);
    // Cloak
    ctx.beginPath();
    ctx.moveTo(-r*0.7, -r*0.3);
    ctx.lineTo(-r*0.9, r);
    ctx.lineTo(r*0.9, r);
    ctx.lineTo(r*0.7, -r*0.3);
    ctx.closePath();
    ctx.fillStyle = highlight ? '#2a4a2a' : '#1a3a1a';
    ctx.fill();
    // Body
    ctx.beginPath();
    ctx.arc(0, -r*0.1, r*0.65, 0, Math.PI*2);
    ctx.fillStyle = highlight ? '#3a5a3a' : '#2a4a2a';
    ctx.fill();
    // Head
    ctx.beginPath();
    ctx.arc(0, -r*0.7, r*0.35, 0, Math.PI*2);
    ctx.fillStyle = '#d8e8c8';
    ctx.fill();
    // Eyes
    const glow = 0.5 + 0.5*Math.sin(time*3);
    ctx.fillStyle = `rgba(218,165,32,${0.6+glow*0.4})`;
    ctx.beginPath();
    ctx.arc(-r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.arc(r*0.12, -r*0.75, 2.5, 0, Math.PI*2);
    ctx.fill();
    // Staff
    ctx.strokeStyle = '#8B6914';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(r*0.5, -r*0.6);
    ctx.lineTo(r*0.5, r*0.9);
    ctx.stroke();
    ctx.fillStyle = `rgba(51,204,51,${0.4+glow*0.3})`;
    ctx.beginPath();
    ctx.arc(r*0.5, -r*0.7, 3, 0, Math.PI*2);
    ctx.fill();
    // Leaves
    for (let i = 0; i < 3; i++) {
        const la = time*2 + i*2.1;
        const lx = Math.cos(la) * r*0.6;
        const ly = r*0.7 + Math.sin(la*1.3) * 3;
        ctx.fillStyle = `rgba(34,139,34,${0.3+0.2*Math.sin(time*3+i)})`;
        ctx.beginPath();
        ctx.ellipse(lx, ly, 3, 1.5, la, 0, Math.PI*2);
        ctx.fill();
    }
    ctx.restore();
}

function drawCharWarlock(x, y, r, time, highlight) {
    ctx.save();
    ctx.translate(x, y);
    // Engine glow
    const ePulse = 0.6 + 0.4*Math.sin(time*10);
    const grd = ctx.createRadialGradient(0, r*0.8, 0, 0, r*0.8, r*0.6);
    grd.addColorStop(0, `rgba(51,136,255,${ePulse*0.8})`);
    grd.addColorStop(0.5, `rgba(51,136,255,${ePulse*0.3})`);
    grd.addColorStop(1, 'transparent');
    ctx.fillStyle = grd;
    ctx.fillRect(-r*0.5, r*0.3, r, r*0.8);
    // Ship
    ctx.beginPath();
    ctx.moveTo(0, -r);
    ctx.lineTo(-r*0.7, r*0.6);
    ctx.lineTo(-r*0.3, r*0.4);
    ctx.lineTo(0, r*0.5);
    ctx.lineTo(r*0.3, r*0.4);
    ctx.lineTo(r*0.7, r*0.6);
    ctx.closePath();
    ctx.fillStyle = highlight ? '#556688' : '#445577';
    ctx.fill();
    ctx.strokeStyle = '#6688aa';
    ctx.lineWidth = 1;
    ctx.stroke();
    // Cockpit
    const cGlow = 0.5 + 0.5*Math.sin(time*3);
    ctx.fillStyle = `rgba(153,51,255,${0.6+cGlow*0.4})`;
    ctx.beginPath();
    ctx.arc(0, -r*0.3, r*0.2, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = `rgba(255,255,255,${0.3+cGlow*0.3})`;
    ctx.beginPath();
    ctx.arc(0, -r*0.3, r*0.1, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
}

const DRAW_FUNCS = [drawCharGunner, drawCharDarkKnight, drawCharRanger, drawCharWarlock];

function drawCharacters(time) {
    for (let i = 0; i < 4; i++) {
        const pos = CHAR_POSITIONS[i];
        const isHovered = hoveredChar === i;
        const isSelected = selectedChar === i;
        const state = getCharState(i);

        // Idle bob
        const bob = Math.sin(time * 2 + i * 1.5) * 2;
        const drawY = pos.y + bob + (isHovered ? -2 : 0);

        ctx.save();

        // Locked = dim
        if (state === 'locked') {
            ctx.globalAlpha = 0.35;
        }

        // Selected ring
        if (isSelected) {
            const pulse = 0.5 + 0.5 * Math.sin(time * 4);
            ctx.strokeStyle = CLASSES[i].accentColor;
            ctx.lineWidth = 1.5;
            ctx.globalAlpha = 0.5 + pulse * 0.5;
            ctx.beginPath();
            ctx.ellipse(pos.x, drawY + 2, HIT_RADIUS, HIT_RADIUS * 0.5, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = state === 'locked' ? 0.35 : 1;
        }

        // Draw character
        DRAW_FUNCS[i](pos.x, drawY, CHAR_RADIUS, time, isHovered || isSelected);

        // Badge
        if (state === 'cleared') {
            ctx.fillStyle = '#d4af37';
            ctx.font = "6px 'Press Start 2P'";
            ctx.textAlign = 'center';
            ctx.fillText('\u2713', pos.x, drawY - CHAR_RADIUS - 6);
        } else if (state === 'current') {
            const pulse = 0.5 + 0.5 * Math.sin(time * 3);
            ctx.fillStyle = `rgba(255,255,255,${0.4 + pulse * 0.4})`;
            ctx.beginPath();
            ctx.arc(pos.x, drawY - CHAR_RADIUS - 5, 2, 0, Math.PI * 2);
            ctx.fill();
        }

        // Name label below
        ctx.globalAlpha = state === 'locked' ? 0.35 : (isHovered || isSelected ? 1 : 0.6);
        ctx.fillStyle = isHovered || isSelected ? CLASSES[i].accentColor : '#aaa';
        ctx.font = "7px 'Press Start 2P'";
        ctx.textAlign = 'center';
        ctx.fillText(CLASSES[i].name, pos.x, drawY + CHAR_RADIUS + 10);

        ctx.restore();
    }
}

function drawCampProps(time) {
    const theme = CAMP_THEMES[getThemeIndex()];

    // Tent (left)
    ctx.fillStyle = '#2a1a10';
    ctx.beginPath();
    ctx.moveTo(40, H * 0.55);
    ctx.lineTo(70, H * 0.55 - 35);
    ctx.lineTo(100, H * 0.55);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = '#3a2a18';
    ctx.lineWidth = 1;
    ctx.stroke();
    // Tent pole
    ctx.strokeStyle = '#5a4020';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(70, H * 0.55 - 35);
    ctx.lineTo(70, H * 0.55 - 42);
    ctx.stroke();

    // Weapon rack (right)
    ctx.strokeStyle = '#4a3a2a';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(400, H * 0.55);
    ctx.lineTo(400, H * 0.55 - 25);
    ctx.moveTo(420, H * 0.55);
    ctx.lineTo(420, H * 0.55 - 25);
    ctx.moveTo(396, H * 0.55 - 22);
    ctx.lineTo(424, H * 0.55 - 22);
    ctx.stroke();
    // Weapons on rack
    ctx.strokeStyle = '#777';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(405, H * 0.55 - 22);
    ctx.lineTo(405, H * 0.55 - 35);
    ctx.moveTo(415, H * 0.55 - 22);
    ctx.lineTo(415, H * 0.55 - 33);
    ctx.stroke();

    // Cart/crate (far right)
    ctx.fillStyle = '#2a2018';
    ctx.fillRect(440, H * 0.55 - 14, 22, 14);
    ctx.strokeStyle = '#3a3020';
    ctx.lineWidth = 1;
    ctx.strokeRect(440, H * 0.55 - 14, 22, 14);
    // Wheel
    ctx.strokeStyle = '#4a3a28';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(445, H * 0.55 + 2, 4, 0, Math.PI * 2);
    ctx.stroke();
}

function drawVignette() {
    const grd = ctx.createRadialGradient(W/2, H/2, W*0.25, W/2, H/2, W*0.6);
    grd.addColorStop(0, 'transparent');
    grd.addColorStop(1, 'rgba(0,0,0,0.5)');
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, W, H);
}

// ---- RENDER LOOP ----
function render(timestamp) {
    const time = timestamp / 1000;
    const dt = time - lastTime;
    lastTime = time;

    updateParticles(dt);

    ctx.clearRect(0, 0, W, H);

    drawSky(time);
    drawStars(time);
    drawBackgroundElements(time);
    drawGround(time);
    drawCampProps(time);
    drawCharacters(time);
    drawCampfire(time);
    drawAmbientParticles(time);
    drawVignette();

    requestAnimationFrame(render);
}

// ---- INTERACTION ----
function getHoveredChar(lx, ly) {
    for (let i = 0; i < 4; i++) {
        const pos = CHAR_POSITIONS[i];
        const dx = lx - pos.x;
        const dy = ly - pos.y;
        if (dx * dx + dy * dy < HIT_RADIUS * HIT_RADIUS) return i;
    }
    return -1;
}

canvas = document.getElementById('camp-canvas');

canvas.addEventListener('mousemove', (e) => {
    const lp = screenToLogical(e.clientX, e.clientY);
    mouseX = lp.x; mouseY = lp.y;
    const prev = hoveredChar;
    hoveredChar = getHoveredChar(lp.x, lp.y);
    canvas.style.cursor = hoveredChar >= 0 ? 'pointer' : 'default';
});

canvas.addEventListener('click', (e) => {
    const lp = screenToLogical(e.clientX, e.clientY);
    const clicked = getHoveredChar(lp.x, lp.y);

    // Close panels if clicking on canvas
    if (settingsOpen) { toggleSettings(); return; }
    if (hofOpen) { toggleHof(); return; }

    if (clicked >= 0) {
        if (selectedChar === clicked) {
            // Deselect
            selectedChar = -1;
            closeInfoPanel();
        } else {
            selectedChar = clicked;
            openInfoPanel(clicked);
        }
    } else {
        selectedChar = -1;
        closeInfoPanel();
    }
});

// ---- INFO PANEL ----
function openInfoPanel(idx) {
    const cls = CLASSES[idx];
    const state = getCharState(idx);
    const panel = document.getElementById('info-panel');
    const content = document.getElementById('info-content');

    const maxStat = { hp: 150, speed: 200, damage: 1.5, defense: 1.5 };

    let html = `<div class="info-icon">${cls.icon}</div>`;
    html += `<div class="info-class-name" style="color:${cls.accentColor}">${cls.name}</div>`;
    html += `<div class="info-class-desc">${cls.desc}</div>`;

    // Stats
    html += '<div class="info-section-label">STATS</div>';
    for (const [key, label] of [['hp','HP'],['speed','SPD'],['damage','DMG'],['defense','DEF']]) {
        const val = cls.stats[key];
        const pct = Math.round((val / maxStat[key]) * 100);
        html += `<div class="info-stat-row">
            <span class="info-stat-label">${label}</span>
            <div class="info-stat-track">
                <div class="info-stat-fill" style="width:${pct}%;background:linear-gradient(90deg,${cls.gradient[0]},${cls.gradient[1]})"></div>
            </div>
            <span class="info-stat-val">${val}</span>
        </div>`;
    }

    // Weapons
    html += '<div class="info-section-label" style="margin-top:14px">WEAPONS</div>';
    html += '<div class="info-weapons">';
    for (const w of cls.weapons) {
        html += `<span class="info-weapon-tag">${w}</span>`;
    }
    html += '</div>';

    // Passive
    html += '<div class="info-section-label">PASSIVE</div>';
    html += `<div class="info-passive-name" style="color:${cls.accentColor}">${cls.passive.name}</div>`;
    html += `<div class="info-passive-desc">${cls.passive.desc}</div>`;

    // World info
    html += `<div class="info-section-label">WORLD</div>`;
    html += `<div style="font-family:var(--pixel-font);font-size:7px;color:${cls.accentColor};margin-bottom:14px">${cls.worldName} Arena</div>`;

    // Play button
    if (state === 'locked') {
        html += `<div class="info-play-btn locked">LOCKED</div>`;
        html += `<div class="info-lock-msg">Complete ${CLASSES[cls.worldIndex - 1]?.worldName || 'previous'} world first</div>`;
    } else if (state === 'current') {
        const { save } = getSaveState();
        const label = save ? 'CONTINUE CAMPAIGN' : 'BEGIN CAMPAIGN';
        html += `<a href="arena.html?world=${cls.worldKey}" class="info-play-btn">${label}</a>`;
    } else {
        // cleared or all complete
        html += `<a href="arena.html?world=${cls.worldKey}" class="info-play-btn">ENTER ARENA</a>`;
    }

    content.innerHTML = html;
    panel.classList.add('open');
}

function closeInfoPanel() {
    document.getElementById('info-panel').classList.remove('open');
}

document.getElementById('info-close').addEventListener('click', () => {
    selectedChar = -1;
    closeInfoPanel();
});

// ---- HUD ----
function updateHud() {
    const { gold } = getSaveState();
    const el = document.getElementById('hud-gold');
    if (gold > 0) {
        el.textContent = '\u{1FA99} ' + gold.toLocaleString();
    } else {
        el.textContent = '';
    }
}

// ---- SETTINGS ----
function toggleSettings() {
    settingsOpen = !settingsOpen;
    document.getElementById('settings-panel').classList.toggle('open', settingsOpen);
    if (settingsOpen && hofOpen) toggleHof();
}

document.getElementById('btn-settings').addEventListener('click', toggleSettings);

document.getElementById('btn-export').addEventListener('click', () => {
    const save = loadSave();
    if (!save) { showToast('No save data'); return; }
    navigator.clipboard.writeText(JSON.stringify(save, null, 2))
        .then(() => showToast('Save copied'))
        .catch(() => showToast('Copy failed'));
});

document.getElementById('btn-import').addEventListener('click', () => {
    toggleSettings();
    document.getElementById('import-modal').classList.add('active');
    document.getElementById('import-textarea').value = '';
    document.getElementById('import-textarea').focus();
});

document.getElementById('btn-reset').addEventListener('click', () => {
    if (!confirm('Reset all progress? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    showToast('Progress reset');
    toggleSettings();
    selectedChar = -1;
    closeInfoPanel();
    updateHud();
    renderHof();
});

document.getElementById('btn-import-cancel').addEventListener('click', () => {
    document.getElementById('import-modal').classList.remove('active');
});

document.getElementById('btn-import-confirm').addEventListener('click', () => {
    const text = document.getElementById('import-textarea').value.trim();
    if (!text) { showToast('Paste JSON first'); return; }
    try {
        const parsed = JSON.parse(text);
        if (!parsed || typeof parsed !== 'object') throw new Error();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        document.getElementById('import-modal').classList.remove('active');
        showToast('Save imported');
        selectedChar = -1;
        closeInfoPanel();
        updateHud();
        renderHof();
    } catch(e) { showToast('Invalid JSON'); }
});

document.getElementById('import-modal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
});

// ---- HALL OF FAME ----
function toggleHof() {
    hofOpen = !hofOpen;
    document.getElementById('hof-panel').classList.toggle('open', hofOpen);
    if (hofOpen && settingsOpen) toggleSettings();
    if (hofOpen) renderHof();
}

document.getElementById('btn-hof').addEventListener('click', toggleHof);
document.getElementById('hof-close').addEventListener('click', toggleHof);

function renderHof() {
    const container = document.getElementById('hof-content');
    const save = loadSave();

    if (!save || !save.classStats) {
        container.innerHTML = '<div style="text-align:center;font-size:7px;color:rgba(176,160,144,0.4);padding:16px">No data yet. Play a run first!</div>';
        return;
    }

    let anyPlayed = false;
    for (const c of CLASSES) {
        const cs = save.classStats[c.id];
        if (cs && cs.totalRuns > 0) { anyPlayed = true; break; }
    }
    if (!anyPlayed) {
        container.innerHTML = '<div style="text-align:center;font-size:7px;color:rgba(176,160,144,0.4);padding:16px">No data yet. Play a run first!</div>';
        return;
    }

    let html = '<div class="hof-grid">';
    for (const c of CLASSES) {
        const cs = (save.classStats && save.classStats[c.id]) || {};
        const played = cs.totalRuns > 0;

        let starCount = 0;
        if (cs.totalRuns > 0) starCount = 1;
        if (cs.bestTime >= 300) starCount = 2;
        if (cs.bestTime >= 600) starCount = 3;

        let stars = '';
        for (let s = 0; s < 3; s++) {
            stars += s < starCount
                ? '<span class="hof-star-on">\u2605</span>'
                : '<span class="hof-star-off">\u2605</span>';
        }

        html += `<div class="hof-card ${played ? 'played' : 'unplayed'}">`;
        html += `<div class="hof-card-name" style="color:${c.accentColor}">${c.name}</div>`;
        html += `<div class="hof-stars">${stars}</div>`;
        if (played) {
            html += `<div class="hof-stat"><strong>${formatTime(cs.bestTime)}</strong> best</div>`;
            html += `<div class="hof-stat"><strong>${cs.bestKills || 0}</strong> kills</div>`;
            html += `<div class="hof-stat"><strong>${cs.totalRuns}</strong> runs</div>`;
        } else {
            html += '<div class="hof-no-data">Not played</div>';
        }
        html += '</div>';
    }
    html += '</div>';
    container.innerHTML = html;
}

function formatTime(seconds) {
    if (!seconds) return '0:00';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}

// ---- TOAST ----
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

// ---- INIT ----
initCanvas();
initParticles();
updateHud();
requestAnimationFrame(render);
</script>

</body>
</html>
