<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Geometer's Garden — A Moroccan Interactive Story</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-display: 'Cinzel', serif;
            --font-body: 'Cormorant Garamond', serif;
            --font-accent: 'Amiri', serif;

            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-7: 48px;
            --space-8: 64px;
            --space-9: 96px;

            --deep-blue: #1a3a5c;
            --royal-blue: #1e4d7b;
            --sapphire: #234e70;
            --midnight: #0f2439;
            --gold: #c9a227;
            --gold-light: #e6c84a;
            --gold-dark: #9a7b1a;
            --terracotta: #c45c3e;
            --terracotta-light: #d97b5c;
            --terracotta-dark: #8b3a24;
            --emerald: #1a6b52;
            --emerald-light: #2d8c6b;
            --emerald-dark: #0d4a38;
            --cream: #f5ebe0;
            --ivory: #faf6f0;
            --sand: #e8dcc4;
            --white: #ffffff;

            --text-primary: var(--cream);
            --text-secondary: rgba(245, 235, 224, 0.75);
            --text-dark: var(--midnight);
            --bg-primary: var(--deep-blue);
            --bg-secondary: var(--midnight);
            --accent-primary: var(--gold);
            --accent-secondary: var(--terracotta);
            --accent-tertiary: var(--emerald);

            --shadow-gold: 0 0 30px rgba(201, 162, 39, 0.3);
            --shadow-soft: 0 8px 32px rgba(15, 36, 57, 0.4);
            --shadow-inset: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            font-size: 1.125rem;
            font-weight: 400;
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Zellige Background */
        .zellige-bg {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0.06; pointer-events: none; z-index: 0;
            background-color: var(--deep-blue);
        }
        .zellige-bg svg { width: 100%; height: 100%; }

        .star-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: 0; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cpath d='M40 0 L45 35 L80 40 L45 45 L40 80 L35 45 L0 40 L35 35 Z' fill='%23c9a227' fill-opacity='1'/%3E%3C/svg%3E");
            background-size: 80px 80px;
        }

        /* Game Container */
        .game-container {
            max-width: 860px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* ============================================
           TITLE SCREEN
           ============================================ */
        .title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            text-align: center;
            position: relative;
        }

        .title-ornament {
            margin-bottom: var(--space-6);
        }
        .title-ornament svg {
            width: 200px; height: 60px;
        }

        .title-badge {
            display: inline-block;
            font-family: var(--font-display);
            font-size: 0.6875rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--terracotta);
            color: var(--terracotta);
            margin-bottom: var(--space-5);
        }

        .title-screen h1 {
            font-family: var(--font-display);
            font-size: clamp(2.5rem, 7vw, 4.5rem);
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--gold);
            text-shadow: var(--shadow-gold);
            margin-bottom: var(--space-3);
        }

        .title-subtitle {
            font-family: var(--font-accent);
            font-size: 1.375rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            font-style: italic;
            margin-bottom: var(--space-6);
        }

        .title-tagline {
            font-family: var(--font-accent);
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: var(--space-7);
            max-width: 500px;
            font-size: 1.125rem;
            line-height: 1.8;
        }

        .title-dots {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            margin-bottom: var(--space-7);
        }
        .title-dots span {
            width: 8px; height: 8px;
            background: var(--gold);
            transform: rotate(45deg);
        }
        .title-dots span:nth-child(2) {
            width: 12px; height: 12px;
            background: var(--terracotta);
        }

        .title-start {
            font-family: var(--font-display);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            padding: var(--space-5) var(--space-7) var(--space-4);
            border: 2px solid var(--gold);
            border-radius: 50px 50px 4px 4px;
            background: transparent;
            color: var(--gold);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .title-start::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            background: var(--gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            z-index: -1;
        }
        .title-start:hover {
            color: var(--midnight);
            border-color: var(--gold);
        }
        .title-start:hover::before {
            width: 300%; height: 300%;
        }

        .title-credits {
            margin-top: var(--space-7);
            font-family: var(--font-display);
            font-size: 0.65rem;
            color: var(--text-secondary);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.6;
        }

        /* ============================================
           SCENE WRAPPER
           ============================================ */
        .scene-wrapper {
            display: none;
            flex-direction: column;
            flex: 1;
        }
        .scene-wrapper.active {
            display: flex;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--space-4);
            margin-bottom: var(--space-6);
            border-bottom: 1px solid rgba(201, 162, 39, 0.2);
        }
        .scene-era {
            font-family: var(--font-display);
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--terracotta);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }
        .scene-fact-count {
            font-family: var(--font-display);
            font-size: 0.7rem;
            color: var(--gold);
            letter-spacing: 0.1em;
        }

        /* ============================================
           TYPOGRAPHY (from style guide)
           ============================================ */
        .type-label {
            font-family: var(--font-display);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            color: var(--terracotta);
            margin-bottom: var(--space-4);
        }
        .type-display {
            font-family: var(--font-display);
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--gold);
            text-shadow: var(--shadow-gold);
        }
        .type-heading {
            font-family: var(--font-display);
            font-size: clamp(1.5rem, 4vw, 2.25rem);
            font-weight: 500;
            letter-spacing: 0.08em;
            color: var(--cream);
        }
        .type-subheading {
            font-family: var(--font-accent);
            font-size: 1.75rem;
            font-weight: 400;
            font-style: italic;
            color: var(--text-secondary);
        }
        .type-body {
            font-family: var(--font-body);
            font-size: 1.125rem;
            font-weight: 400;
            line-height: 1.8;
            max-width: 65ch;
            margin: 0 auto;
            color: var(--text-secondary);
        }
        .type-accent {
            font-family: var(--font-accent);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--emerald-light);
        }

        /* ============================================
           FRAME (from style guide)
           ============================================ */
        .frame {
            position: relative;
            padding: var(--space-7);
            margin-bottom: var(--space-6);
            background: linear-gradient(135deg, rgba(15, 36, 57, 0.8) 0%, rgba(26, 58, 92, 0.6) 100%);
            border-radius: 4px;
        }
        .frame::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid var(--gold);
            border-radius: 4px;
            pointer-events: none;
        }
        .frame::after {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid rgba(201, 162, 39, 0.4);
            border-radius: 2px;
            pointer-events: none;
        }

        .corner-stars {
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            pointer-events: none;
        }
        .corner-star {
            position: absolute;
            width: 30px; height: 30px;
        }
        .corner-star svg { width: 100%; height: 100%; }
        .corner-star-tl { top: 0; left: 0; }
        .corner-star-tr { top: 0; right: 0; }
        .corner-star-bl { bottom: 0; left: 0; }
        .corner-star-br { bottom: 0; right: 0; }

        /* ============================================
           CARDS (from style guide)
           ============================================ */
        .card {
            background: linear-gradient(180deg, rgba(15, 36, 57, 0.9) 0%, rgba(26, 58, 92, 0.7) 100%);
            border: 2px solid rgba(201, 162, 39, 0.3);
            padding: var(--space-6);
            position: relative;
            text-align: center;
            overflow: hidden;
            margin-bottom: var(--space-5);
        }
        .card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--terracotta), var(--emerald), var(--gold));
            background-size: 300% 100%;
            animation: shimmer 4s ease infinite;
        }
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .card::after {
            content: '';
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid rgba(201, 162, 39, 0.15);
            pointer-events: none;
        }

        .card-featured {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--space-6);
            text-align: left;
            padding: var(--space-7);
        }

        .card-icon {
            width: 80px; height: 80px;
            margin: 0 auto var(--space-5);
            display: flex;
            align-items: center; justify-content: center;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        .card-icon svg { width: 32px; height: 32px; fill: var(--midnight); }

        .card-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--gold);
            margin-bottom: var(--space-3);
        }
        .card-content {
            font-family: var(--font-body);
            color: var(--text-secondary);
            line-height: 1.8;
        }

        /* ============================================
           SECTION ELEMENTS (from style guide)
           ============================================ */
        .section-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }
        .section-number {
            font-family: var(--font-accent);
            font-size: 3.5rem;
            color: var(--gold);
            opacity: 0.25;
            margin-bottom: var(--space-2);
            line-height: 1;
        }
        .section-title {
            font-family: var(--font-display);
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 500;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: var(--space-4);
        }
        .section-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }
        .section-divider::before,
        .section-divider::after {
            content: '';
            width: 80px; height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }
        .section-divider svg { width: 40px; height: 40px; }

        /* ============================================
           DIVIDERS (from style guide)
           ============================================ */
        .divider {
            display: flex;
            align-items: center; justify-content: center;
            gap: var(--space-4);
            margin: var(--space-6) 0;
        }
        .divider::before,
        .divider::after {
            content: '';
            flex: 1; height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }
        .divider-icon {
            width: 50px; height: 50px;
            display: flex;
            align-items: center; justify-content: center;
        }
        .divider-icon svg { width: 100%; height: 100%; }

        /* ============================================
           ALERTS (from style guide)
           ============================================ */
        .alert {
            padding: var(--space-5) var(--space-6);
            border-left: 4px solid var(--gold);
            background: rgba(15, 36, 57, 0.8);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
        }
        .alert-icon {
            flex-shrink: 0; width: 24px; height: 24px;
        }
        .alert-icon svg { width: 100%; height: 100%; fill: var(--gold); }
        .alert-content { flex: 1; }
        .alert-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--gold);
            margin-bottom: var(--space-1);
        }
        .alert-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        .alert-success { border-color: var(--emerald-light); }
        .alert-success .alert-icon svg { fill: var(--emerald-light); }
        .alert-success .alert-title { color: var(--emerald-light); }
        .alert-warning { border-color: var(--terracotta); }
        .alert-warning .alert-icon svg { fill: var(--terracotta); }
        .alert-warning .alert-title { color: var(--terracotta); }

        /* ============================================
           BADGES (from style guide)
           ============================================ */
        .badge-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--space-4);
        }
        .badge {
            font-family: var(--font-display);
            font-size: 0.6875rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--gold);
            color: var(--gold);
            transition: all 0.3s ease;
        }
        .badge-filled { background: var(--gold); color: var(--midnight); }
        .badge-terracotta { border-color: var(--terracotta); color: var(--terracotta); }
        .badge-emerald { border-color: var(--emerald-light); color: var(--emerald-light); }

        /* ============================================
           GEOMETRIC ELEMENTS (from style guide)
           ============================================ */
        .geo-star {
            width: 120px; height: 120px;
            margin: 0 auto var(--space-6);
            position: relative;
        }
        .geo-star svg {
            width: 100%; height: 100%;
            animation: star-rotate 20s linear infinite;
        }
        @keyframes star-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .geo-arch {
            width: 160px; height: 220px;
            margin: 0 auto var(--space-6);
            position: relative;
            border: 2px solid var(--gold);
            border-radius: 80px 80px 0 0;
        }
        .geo-arch::before {
            content: '';
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 0;
            border: 1px solid rgba(201, 162, 39, 0.5);
            border-radius: 65px 65px 0 0;
        }
        .geo-arch::after {
            content: '';
            position: absolute;
            top: 30px; left: 30px; right: 30px; bottom: 0;
            border: 1px solid rgba(201, 162, 39, 0.25);
            border-radius: 50px 50px 0 0;
        }

        /* ============================================
           BUTTONS (from style guide)
           ============================================ */
        .btn {
            font-family: var(--font-display);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            padding: var(--space-4) var(--space-7);
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            background: var(--gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            z-index: -1;
        }
        .btn:hover { color: var(--midnight); border-color: var(--gold); }
        .btn:hover::before { width: 300%; height: 300%; }

        .btn-filled { background: var(--gold); color: var(--midnight); }
        .btn-filled::before { background: var(--midnight); }
        .btn-filled:hover { color: var(--gold); }

        .btn-arch {
            border-radius: 50px 50px 4px 4px;
            padding: var(--space-5) var(--space-7) var(--space-4);
        }

        .btn-terracotta { border-color: var(--terracotta); color: var(--terracotta); }
        .btn-terracotta::before { background: var(--terracotta); }
        .btn-terracotta:hover { color: var(--cream); }

        .btn-emerald { border-color: var(--emerald-light); color: var(--emerald-light); }
        .btn-emerald::before { background: var(--emerald-light); }
        .btn-emerald:hover { color: var(--cream); }

        /* ============================================
           UTILITY CLASSES (from style guide)
           ============================================ */
        .text-gold { color: var(--gold); }
        .text-terracotta { color: var(--terracotta); }
        .text-emerald { color: var(--emerald-light); }
        .text-cream { color: var(--cream); }
        .text-center { text-align: center; }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }

        /* ============================================
           STORY-SPECIFIC: CHOICES
           ============================================ */
        .choices {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin-top: var(--space-5);
            opacity: 0;
            animation: choicesFadeIn 0.6s ease-out 0.8s forwards;
        }
        @keyframes choicesFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .choice-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: var(--space-4) var(--space-5);
            font-family: var(--font-display);
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            border: 2px solid rgba(201, 162, 39, 0.3);
            background: rgba(15, 36, 57, 0.6);
            color: var(--cream);
            cursor: pointer;
            transition: all 0.35s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            background: var(--gold);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            transform-origin: bottom;
        }
        .choice-btn:hover {
            border-color: var(--gold);
            background: rgba(201, 162, 39, 0.08);
            padding-left: calc(var(--space-5) + 6px);
            box-shadow: var(--shadow-gold);
        }
        .choice-btn:hover::before {
            transform: scaleY(1);
        }
        .choice-key {
            display: inline-flex;
            align-items: center; justify-content: center;
            width: 28px; height: 28px;
            border: 1px solid rgba(201, 162, 39, 0.4);
            font-size: 0.7rem;
            color: var(--gold);
            margin-right: var(--space-4);
            flex-shrink: 0;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            background: rgba(201, 162, 39, 0.1);
        }
        .choice-btn:hover .choice-key {
            background: var(--gold);
            color: var(--midnight);
        }

        /* ============================================
           STORY-SPECIFIC: FACT FOUND
           ============================================ */
        .fact-found {
            display: inline-flex;
            align-items: center;
            gap: var(--space-3);
            background: rgba(201, 162, 39, 0.15);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: var(--space-2) var(--space-4);
            font-family: var(--font-display);
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-top: var(--space-5);
            animation: factReveal 0.6s ease-out;
        }
        @keyframes factReveal {
            from { opacity: 0; transform: translateY(10px) rotate(-2deg); }
            to { opacity: 1; transform: translateY(0) rotate(0); }
        }

        /* ============================================
           STORY-SPECIFIC: KNOWLEDGE TRACKER
           ============================================ */
        .knowledge-tracker {
            position: fixed;
            top: 1.5rem; right: 1.5rem;
            z-index: 100;
            max-width: 260px;
        }
        .knowledge-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: var(--space-2) var(--space-4);
            background: var(--bg-secondary);
            border: 1px solid rgba(201, 162, 39, 0.3);
            color: var(--gold);
            font-family: var(--font-display);
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: auto;
        }
        .knowledge-toggle:hover {
            border-color: var(--gold);
            box-shadow: var(--shadow-gold);
        }
        .knowledge-panel {
            display: none;
            margin-top: var(--space-2);
            background: var(--bg-secondary);
            border: 1px solid rgba(201, 162, 39, 0.3);
            padding: var(--space-4);
            max-height: 60vh;
            overflow-y: auto;
        }
        .knowledge-panel.open {
            display: block;
            animation: panelSlide 0.3s ease-out;
        }
        @keyframes panelSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .knowledge-panel h4 {
            font-family: var(--font-display);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--terracotta);
            margin-bottom: var(--space-3);
        }
        .knowledge-item {
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--gold);
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(201, 162, 39, 0.15);
            animation: factReveal 0.4s ease-out;
            line-height: 1.5;
        }
        .knowledge-item:last-child { border-bottom: none; }
        .no-facts {
            font-family: var(--font-accent);
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* ============================================
           STORY-SPECIFIC: TRANSITION
           ============================================ */
        .transition-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 500;
            pointer-events: none;
            opacity: 0;
        }
        .transition-overlay.active {
            pointer-events: all;
            animation: starTransition 1.4s ease-in-out;
        }
        @keyframes starTransition {
            0% { opacity: 0; }
            15% { opacity: 1; }
            50% { opacity: 1; }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }
        .transition-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--midnight);
        }
        .transition-star {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 0; height: 0;
            opacity: 0;
        }
        .transition-overlay.active .transition-star {
            animation: starExpand 1.4s ease-in-out;
        }
        @keyframes starExpand {
            0% { width: 0; height: 0; opacity: 0; }
            20% { width: 200vmax; height: 200vmax; opacity: 0.3; }
            50% { opacity: 0.3; }
            100% { width: 200vmax; height: 200vmax; opacity: 0; }
        }
        .transition-star svg {
            width: 100%; height: 100%;
            animation: starSpin 1.4s ease-in-out;
        }
        @keyframes starSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(72deg); }
        }

        /* ============================================
           STORY-SPECIFIC: SCENE FADE IN
           ============================================ */
        .scene-content {
            animation: sceneFadeIn 0.8s ease-out;
        }
        @keyframes sceneFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           STORY-SPECIFIC: GAME CONTROLS
           ============================================ */
        .game-controls {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-6);
            padding-top: var(--space-5);
            border-top: 1px solid rgba(201, 162, 39, 0.15);
        }
        .ctrl-btn {
            padding: var(--space-2) var(--space-5);
            font-family: var(--font-display);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            border: 1px solid rgba(201, 162, 39, 0.2);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        .ctrl-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ============================================
           STORY-SPECIFIC: DIALOGUE
           ============================================ */
        .dialogue-speaker {
            font-family: var(--font-display);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--gold);
            margin-bottom: var(--space-2);
        }
        .dialogue-text {
            font-family: var(--font-accent);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--cream);
            line-height: 1.8;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .game-container { padding: 1rem; }
            .frame { padding: var(--space-5); }
            .card-featured { grid-template-columns: 1fr; text-align: center; }
            .card-featured .card-icon { margin: 0 auto var(--space-4); }
            .knowledge-tracker { right: 0.75rem; top: 0.75rem; max-width: 200px; }
            .geo-arch { width: 120px; height: 170px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: rgba(201, 162, 39, 0.3); }
        ::selection { background: var(--gold); color: var(--midnight); }
    </style>
</head>
<body>
    <!-- Zellige Pattern Background -->
    <div class="zellige-bg">
        <svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMid slice">
            <defs>
                <pattern id="zellige" patternUnits="userSpaceOnUse" width="100" height="100">
                    <polygon points="50,10 58,35 85,35 63,50 71,75 50,60 29,75 37,50 15,35 42,35" fill="none" stroke="#c9a227" stroke-width="0.5"/>
                    <polygon points="50,20 55,38 72,38 58,48 63,65 50,55 37,65 42,48 28,38 45,38" fill="none" stroke="#c9a227" stroke-width="0.3"/>
                    <rect x="0" y="0" width="15" height="15" fill="none" stroke="#c9a227" stroke-width="0.3"/>
                    <rect x="85" y="0" width="15" height="15" fill="none" stroke="#c9a227" stroke-width="0.3"/>
                    <rect x="0" y="85" width="15" height="15" fill="none" stroke="#c9a227" stroke-width="0.3"/>
                    <rect x="85" y="85" width="15" height="15" fill="none" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="15" y1="7.5" x2="35" y2="7.5" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="65" y1="7.5" x2="85" y2="7.5" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="7.5" y1="15" x2="7.5" y2="35" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="92.5" y1="15" x2="92.5" y2="35" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="7.5" y1="65" x2="7.5" y2="85" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="92.5" y1="65" x2="92.5" y2="85" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="15" y1="92.5" x2="35" y2="92.5" stroke="#c9a227" stroke-width="0.3"/>
                    <line x1="65" y1="92.5" x2="85" y2="92.5" stroke="#c9a227" stroke-width="0.3"/>
                </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#zellige)"/>
        </svg>
    </div>
    <div class="star-overlay"></div>

    <!-- Transition Overlay -->
    <div class="transition-overlay" id="transition">
        <div class="transition-pattern"></div>
        <div class="transition-star">
            <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <polygon points="60,10 68,40 100,40 74,58 82,88 60,70 38,88 46,58 20,40 52,40" fill="none" stroke="#c9a227" stroke-width="1" opacity="0.4"/>
            </svg>
        </div>
    </div>

    <!-- Knowledge Tracker -->
    <div class="knowledge-tracker" id="knowledgeTracker" style="display: none;">
        <button class="knowledge-toggle" id="knowledgeToggle">
            <span>Knowledge</span>
            <span id="factCount">0</span>
        </button>
        <div class="knowledge-panel" id="knowledgePanel">
            <h4>Facts Discovered</h4>
            <div id="factList">
                <p class="no-facts">Your journey has just begun...</p>
            </div>
        </div>
    </div>

    <div class="game-container">
        <!-- Title Screen -->
        <div class="title-screen" id="titleScreen">
            <div class="title-ornament">
                <svg viewBox="0 0 200 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 5 L105 20 L120 20 L108 30 L113 45 L100 35 L87 45 L92 30 L80 20 L95 20 Z" fill="#c9a227"/>
                    <path d="M40 20 L43 28 L52 28 L45 33 L48 41 L40 36 L32 41 L35 33 L28 28 L37 28 Z" fill="#c45c3e" opacity="0.8"/>
                    <path d="M160 20 L163 28 L172 28 L165 33 L168 41 L160 36 L152 41 L155 33 L148 28 L157 28 Z" fill="#1a6b52" opacity="0.8"/>
                    <line x1="0" y1="30" x2="70" y2="30" stroke="#c9a227" stroke-width="1" opacity="0.5"/>
                    <line x1="130" y1="30" x2="200" y2="30" stroke="#c9a227" stroke-width="1" opacity="0.5"/>
                </svg>
            </div>
            <div class="title-badge">An Interactive Journey</div>
            <h1>The Geometer's Garden</h1>
            <p class="title-subtitle">Mathematics, Art, and the Soul of Moroccan Tiles</p>
            <div class="title-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <p class="title-tagline">"Every tile is a proof that the universe is built on order, harmony, and infinite complexity."</p>
            <button class="title-start" id="startBtn">Enter the Medina</button>
            <p class="title-credits">A story told in geometry and gold</p>
            <a href="index.html" class="back-to-stories" style="display:inline-block;margin-top:1.5rem;color:inherit;text-decoration:none;font-size:0.8rem;opacity:0.5;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'">&larr; All Stories</a>
        </div>

        <!-- Scene Container -->
        <div class="scene-wrapper" id="sceneWrapper">
            <div class="scene-header">
                <span class="scene-era" id="sceneEra">Fez, 1380 CE</span>
            </div>
            <div id="sceneContent"></div>
            <div class="game-controls">
                <button class="ctrl-btn" id="restartBtn">Begin Again</button>
            </div>
        </div>
    </div>

    <script>
    // ===============================================================
    //  THE GEOMETER'S GARDEN — Story Data
    // ===============================================================

    const STORY = {

        // --- SCENE 1: Arrival in Fez ---
        arrival: {
            era: 'Fez, 1380 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">I</div>
                    <h2 class="section-title">The Medina Awakens</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                    </div>
                    <p class="type-body">The evening call to prayer drifts over the rooftops of Fez as you pass through the Bab Bou Jeloud gate. You are seventeen, an orphan of the plague years, carrying nothing but a rolled scrap of leather and the name of a master tile-maker: <span class="text-gold">Moulay Idriss al-Fassi</span>.</p>
                    <p class="type-body mt-4">Inside the leather wrapping is a single zellige tile, chipped at one corner but still shimmering with a deep cobalt glaze. It belonged to your father, who said it came from <span class="text-emerald">Granada</span>. It is all you have left of your family.</p>
                    <p class="type-body mt-4">The medina swallows you in its labyrinth of narrow streets, the air thick with cedar smoke and the sound of copper being hammered somewhere in the distance. Lanterns flicker behind lattice screens. You have come to learn the art that made your father weep with its beauty.</p>
                </div>

                <div class="alert">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Historical Context</p>
                        <p class="alert-text">The University of Al-Qarawiyyin in Fez, founded in <strong>859 CE</strong>, is the world's oldest continuously operating university. By the 14th century, it was a major center for mathematics, astronomy, and Islamic jurisprudence.</p>
                    </div>
                </div>
            `,
            fact: 'Al-Qarawiyyin University in Fez (founded 859 CE) is the world\'s oldest continuously operating university.',
            choices: [
                { text: 'Explore the souk before finding the workshop', next: 'souk' },
                { text: 'Go directly to the master\'s workshop', next: 'workshop' }
            ]
        },

        // --- SCENE 2A: The Souk ---
        souk: {
            era: 'Fez, 1380 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">II</div>
                    <h2 class="section-title">The Living Labyrinth</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <p class="type-body">You wander deeper into the souk. Dyers' vats overflow with indigo and saffron. A brass merchant polishes a tray into a mirror. A spice seller calls out his wares in a voice that rises and falls like music.</p>

                <div class="divider">
                    <div class="divider-icon"><svg viewBox="0 0 50 50" fill="none"><polygon points="25,5 29,18 43,18 32,27 36,40 25,31 14,40 18,27 7,18 21,18" fill="#c9a227"/><polygon points="25,12 27,19 35,19 29,24 31,31 25,26 19,31 21,24 15,19 23,19" fill="#0f2439"/></svg></div>
                </div>

                <p class="type-body">Then you see it. In a tiled fountain at the junction of two alleyways, water catches the last light of day and scatters it across a mosaic of interlocking stars. Eight-pointed stars, nested inside octagons, surrounded by smaller diamond shapes — every piece cut by hand, every angle exact.</p>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Zellige-Marrakesh-1.JPG/800px-Zellige-Marrakesh-1.JPG" alt="Traditional Moroccan zellige tilework showing intricate geometric patterns with eight-pointed stars" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">Zellige mosaic from Morocco, featuring the interlocking geometric patterns that define this ancient art form</div>
                </div>

                <p class="type-body mt-4">An old woman notices you staring. <span class="text-gold">"Beautiful, yes?"</span> she says. <span class="text-gold">"The Marinid sultans commissioned those tiles over a hundred years ago. The technique was born here in Morocco in the 10th century."</span></p>

                <div class="alert alert-success">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">The Origins of Zellige</p>
                        <p class="alert-text">Zellige tilework was born in Morocco in the <strong>10th century</strong>, initially using only white and brown tones in imitation of Roman and Byzantine mosaics. It flourished under the <strong>Marinid Dynasty (13th-14th centuries)</strong>, when artisans developed the intricate geometric patterns that became synonymous with Moroccan design.</p>
                    </div>
                </div>
            `,
            fact: 'Zellige tilework was born in Morocco in the 10th century and flourished under the Marinid Dynasty (13th-14th centuries).',
            choices: [
                { text: 'Continue to the master\'s workshop', next: 'workshop' }
            ]
        },

        // --- SCENE 2B / 3: The Workshop ---
        workshop: {
            era: 'Fez, 1380 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">III</div>
                    <h2 class="section-title">The Language of Tiles</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#1a6b52"/></svg>
                    </div>
                </div>

                <div class="geo-arch" style="display:flex; align-items:center; justify-content:center;">
                    <span class="type-accent" style="font-size:0.9rem; text-align:center; padding: 40px 10px 10px;">Through<br>the Arch</span>
                </div>

                <p class="type-body">The workshop of Moulay Idriss al-Fassi is hidden behind an unremarkable wooden door. But when you step through, the courtyard opens like a revelation. Every surface sings with color: walls of zellige in cobalt, white, and emerald; a carved cedar ceiling; a small fountain murmuring at the center.</p>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/ff/Stucco_decoration%2C_Bou_Inania_Madrasa%2C_Fez%2C_Marocco_%28%D8%A7%D9%84%D9%85%D8%AF%D8%B1%D8%B3%D8%A9_%D8%A7%D9%84%D8%A8%D9%88%D8%B9%D9%86%D8%A7%D9%86%D9%8A%D8%A9%2C_%E2%B4%B0%E2%B5%99%E2%B5%89%E2%B5%8F%E2%B4%B0%E2%B5%8F_%E2%B4%B1%E2%B5%93_%E2%B5%89%E2%B5%8F%E2%B4%B0%E2%B5%8F%E2%B5%89%E2%B5%A2%E2%B4%B0%29.jpg/800px-Stucco_decoration%2C_Bou_Inania_Madrasa%2C_Fez%2C_Marocco_%28%D8%A7%D9%84%D9%85%D8%AF%D8%B1%D8%B3%D8%A9_%D8%A7%D9%84%D8%A8%D9%88%D8%B9%D9%86%D8%A7%D9%86%D9%8A%D8%A9%2C_%E2%B4%B0%E2%B5%99%E2%B5%89%E2%B5%8F%E2%B4%B0%E2%B5%8F_%E2%B4%B1%E2%B5%93_%E2%B5%89%E2%B5%8F%E2%B4%B0%E2%B5%8F%E2%B5%89%E2%B5%A2%E2%B4%B0%29.jpg" alt="Intricate zellige tilework and carved stucco in the Bou Inania Madrasa, Fez" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">The Bou Inania Madrasa in Fez, showcasing the mastery of zellige and geometric design in 14th-century Morocco</div>
                </div>

                <p class="type-body mt-4">The master himself is a thin man with steady hands and eyes that miss nothing. He examines the tile you carry from Granada, turning it slowly in the lamplight.</p>

                <div class="card mt-6" style="text-align:left;">
                    <div class="dialogue-speaker">Moulay Idriss al-Fassi</div>
                    <p class="dialogue-text">"This tile is from the Alhambra. I can tell by the glaze — they use a different kiln temperature in al-Andalus. Do you know what makes it beautiful?"</p>
                    <p class="type-body mt-4">You shake your head.</p>
                    <p class="dialogue-text mt-4">"It is not the color. It is the angle. Every edge, every intersection follows a mathematical law. This is what I will teach you — not to decorate, but to <span class="text-gold">calculate</span>."</p>
                </div>
            `,
            fact: 'Zellige artisans are applied mathematicians — every cut follows precise geometric and algebraic principles.',
            choices: [
                { text: 'Ask about the history of these mathematical principles', next: 'history_lesson' },
                { text: 'Ask why mathematics matters for art', next: 'math_art' }
            ]
        },

        // --- SCENE 4A: History Lesson ---
        history_lesson: {
            era: 'Baghdad, 820 CE (Flashback)',
            content: `
                <div class="section-header">
                    <div class="section-number">IV</div>
                    <h2 class="section-title">The House of Wisdom</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <p class="type-body">The master's eyes grow distant. He speaks, and his words carry you across centuries and continents, to a great library in Baghdad.</p>

                <div class="card card-featured mt-6" style="text-align:left;">
                    <div class="card-icon">
                        <svg viewBox="0 0 32 32"><polygon points="16,4 18,12 27,12 20,17 22,25 16,20 10,25 12,17 5,12 14,12"/></svg>
                    </div>
                    <div>
                        <h3 class="card-title">Al-Khwarizmi's Revolution</h3>
                        <p class="card-content">In the House of Wisdom, established during the reign of Caliph <strong>Harun al-Rashid in 786 CE</strong>, a Persian scholar named <strong>Muhammad ibn Musa al-Khwarizmi</strong> completed a book that changed the world. Written between <strong>813 and 833 CE</strong>, <em>Al-Jabr</em> (The Compendious Book on Calculation by Completion and Balancing) established algebra as a systematic mathematical field.</p>
                        <p class="card-content mt-4">His name gave us the word <span class="text-gold">"algorithm."</span> His book's title gave us the word <span class="text-gold">"algebra."</span> And his work on geometry provided the mathematical foundations that artisans across the Islamic world would use to create patterns of infinite beauty.</p>
                    </div>
                </div>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Bodleian_MS._Huntington_214_roll332_frame36.jpg/600px-Bodleian_MS._Huntington_214_roll332_frame36.jpg" alt="Page from a Latin translation of al-Khwarizmi's Al-Jabr manuscript showing algebraic equations" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">A page from al-Khwarizmi's Al-Jabr, the foundational text that gave us the word "algebra"</div>
                </div>

                <div class="alert mt-6">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">The House of Wisdom</p>
                        <p class="alert-text">The House of Wisdom in Baghdad was the intellectual center of the Islamic Golden Age (<strong>8th-13th centuries</strong>). Scholars there translated Greek, Persian, and Indian texts into Arabic, then extended them with original discoveries in mathematics, astronomy, medicine, and optics.</p>
                    </div>
                </div>
            `,
            fact: 'Al-Khwarizmi completed Al-Jabr (813-833 CE) at Baghdad\'s House of Wisdom, giving us the words "algebra" and "algorithm."',
            choices: [
                { text: 'Continue your apprenticeship', next: 'plague_memory' }
            ]
        },

        // --- SCENE 4B: Math and Art ---
        math_art: {
            era: 'Fez, 1380 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">IV</div>
                    <h2 class="section-title">The Unity of Beauty</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <div class="geo-star">
                    <svg viewBox="0 0 120 120" fill="none">
                        <polygon points="60,10 68,40 100,40 74,58 82,88 60,70 38,88 46,58 20,40 52,40" fill="none" stroke="#c9a227" stroke-width="2"/>
                        <polygon points="60,20 65,42 88,42 70,54 76,76 60,64 44,76 50,54 32,42 55,42" fill="none" stroke="#c45c3e" stroke-width="1"/>
                        <polygon points="60,30 63,45 78,45 66,52 70,66 60,58 50,66 54,52 42,45 57,45" fill="none" stroke="#1a6b52" stroke-width="1"/>
                        <circle cx="60" cy="60" r="8" fill="#c9a227"/>
                    </svg>
                </div>

                <p class="type-body">The master picks up a compass and straightedge. With swift, practiced motions, he draws an 8-pointed star on a clay tablet. Two squares, overlapping at 45 degrees.</p>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/61/The_complexity_of_Islamic_geometric_patters_-_Islamic_Arts_Museum_Malaysia_%2818359241653%29.jpg/800px-The_complexity_of_Islamic_geometric_patters_-_Islamic_Arts_Museum_Malaysia_%2818359241653%29.jpg" alt="Islamic geometric tile pattern showing eight-pointed stars and interlocking shapes" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">Islamic geometric patterns based on eight-pointed stars and mathematical tessellation principles</div>
                </div>

                <div class="card mt-6" style="text-align:left;">
                    <div class="dialogue-speaker">Moulay Idriss al-Fassi</div>
                    <p class="dialogue-text">"A Persian scholar named al-Khwarizmi proved that equations are patterns, and patterns are equations. He completed his book <em>Al-Jabr</em> between 813 and 833 CE. From his name we get the word 'algorithm.' From his book's title we get the word <span class="text-gold">'algebra.'</span>"</p>
                    <p class="dialogue-text mt-4">"When I cut a tile, I am solving an equation with my hands. When I place it next to its neighbor, I am proving a theorem. Mathematics is not separate from beauty — it <em>is</em> beauty, expressed in the language of the universe."</p>
                </div>

                <div class="alert alert-success mt-6">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Trigonometry's Advance</p>
                        <p class="alert-text">By <strong>900 CE</strong>, mathematician <strong>Abu al-Wafa al-Buzjani</strong> had described all three trigonometric functions, enabling the precise angular calculations that artisans used to construct complex geometric patterns in architecture and tilework.</p>
                    </div>
                </div>
            `,
            fact: 'By 900 CE, Abu al-Wafa al-Buzjani had described all three trigonometric functions, enabling precise geometric architecture.',
            choices: [
                { text: 'Continue your apprenticeship', next: 'plague_memory' }
            ]
        },

        // --- SCENE 5: Plague Memory ---
        plague_memory: {
            era: 'Fez, 1380 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">V</div>
                    <h2 class="section-title">Dust and Inheritance</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative; background: linear-gradient(135deg, rgba(15, 36, 57, 0.9) 0%, rgba(15, 36, 57, 0.85) 100%);">
                    <p class="type-body">That night, alone in the apprentice's quarters, you unwrap your father's tile and hold it in the lamplight. The cobalt glaze catches the flame and throws tiny constellations across the ceiling.</p>
                    <p class="type-body mt-4">You remember the plague year. The coughing. The silence that came after. Your father pressing this tile into your hands with the last strength he had.</p>
                    <p class="type-body mt-4" style="color: var(--terracotta);"><em>"Find the master in Fez. Learn what this tile means. The pattern... the pattern never dies, even when we do."</em></p>
                    <p class="type-body mt-4">You turn the tile over. On the back, scratched into the clay before firing, a single line of text: coordinates, and the name <span class="text-gold">Ibn Khaldun</span>.</p>
                </div>

                <div class="alert alert-warning">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 4l7.53 13H4.47L12 6zm-1 6v4h2v-4h-2zm0 6v2h2v-2h-2z"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Ibn Khaldun</p>
                        <p class="alert-text"><strong>Ibn Khaldun</strong>, born <strong>27 May 1332</strong> in Tunis, was a mathematician, historian, and philosopher who survived the Black Death in Tunis (<strong>1348-1349</strong>). He pioneered modern methodology in historical analysis and became one of the greatest social scientists of the medieval world.</p>
                    </div>
                </div>
            `,
            fact: 'Ibn Khaldun (born 27 May 1332, Tunis) survived the Black Death and pioneered modern historical methodology.',
            choices: [
                { text: 'Continue', next: 'university' }
            ]
        },

        // --- SCENE 6: The University ---
        university: {
            era: 'Fez, 1381 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">VI</div>
                    <h2 class="section-title">The Mosque and the Scholars</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#1a6b52"/></svg>
                    </div>
                </div>

                <p class="type-body">Months pass. Your hands learn the chisel and the score line. But Moulay Idriss insists you study more than craft — he sends you to attend lectures at <span class="text-gold">Al-Qarawiyyin</span>.</p>

                <div class="card mt-6">
                    <div class="card-icon">
                        <svg viewBox="0 0 32 32"><rect x="6" y="6" width="20" height="20" rx="2"/><rect x="10" y="10" width="12" height="12"/></svg>
                    </div>
                    <h3 class="card-title">Al-Qarawiyyin University</h3>
                    <p class="card-content">Inside the great mosque, scholars discuss geometry, astronomy, and jurisprudence. A visiting mathematician from Tunis — a student of Ibn Khaldun himself — lectures on the relationship between algebraic equations and tessellating patterns.</p>
                </div>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Courtyard_of_the_Al-Qarawiyyin_Mosque.jpg/800px-Courtyard_of_the_Al-Qarawiyyin_Mosque.jpg" alt="The courtyard of Al-Qarawiyyin University in Fez, Morocco, the world's oldest continuously operating university" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">Al-Qarawiyyin University in Fez, founded 859 CE, where mathematics and geometry have been taught for over a millennium</div>
                </div>

                <p class="type-body mt-6">After the lecture, excited chatter fills the courtyard. A traveler has arrived from al-Andalus bearing drawings and detailed accounts of a palace that has just been completed in Granada.</p>
                <p class="type-body mt-4"><span class="text-gold">"The Alhambra,"</span> the scholars whisper. <span class="text-gold">"They say it contains every possible geometric pattern known to mathematics."</span></p>

                <div class="badge-row mt-6">
                    <span class="badge">Geometry</span>
                    <span class="badge badge-terracotta">Algebra</span>
                    <span class="badge badge-emerald">Tessellation</span>
                    <span class="badge badge-filled">Symmetry</span>
                </div>
            `,
            fact: 'Al-Qarawiyyin taught geometry and algebra for over 500 years, making zellige artisans into applied mathematicians.',
            choices: [
                { text: 'Examine the Alhambra drawings closely', next: 'alhambra' },
                { text: 'Ask about the mathematical proof of infinite patterns', next: 'wallpaper_groups' }
            ]
        },

        // --- SCENE 7A: The Alhambra ---
        alhambra: {
            era: 'Granada, 1238-1358 CE (Account)',
            content: `
                <div class="section-header">
                    <div class="section-number">VII</div>
                    <h2 class="section-title">Proof in Stone</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                    </div>
                    <p class="type-body">The traveler unrolls his drawings on a table. You gasp. The detail is extraordinary: walls covered in tessellating stars, arches within arches, and overhead, something you have never imagined --</p>
                    <p class="type-body mt-4"><span class="text-gold">Muqarnas.</span> Honeycomb vaulting. Three-dimensional geometric compositions that transform flat ceilings into cascading celestial domes. The traveler describes a single vault containing at least <strong>5,000 precisely cut prismatic pieces</strong> that unfold from a central summit into sixteen miniature domes.</p>

                    <div style="margin: 1.5rem 0; text-align: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Ceiling_-_Sala_de_los_Abencerrajes_-_Alhambra.JPG/800px-Ceiling_-_Sala_de_los_Abencerrajes_-_Alhambra.JPG" alt="Muqarnas dome ceiling in the Hall of the Abencerrajes, Alhambra, showing thousands of precisely cut honeycomb cells" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">Muqarnas dome in the Alhambra, a masterpiece of three-dimensional Islamic geometric art</div>
                    </div>

                    <p class="type-body mt-4">The Alhambra was constructed between <strong>1238 and 1358</strong> during the Nasrid dynasty's rule. And in its tile mosaics, mathematicians have found nearly all <strong>17 mathematically possible wallpaper groups</strong> — the complete set of ways a two-dimensional pattern can repeat symmetrically to fill a plane.</p>
                </div>

                <div style="margin: 1.5rem 0; text-align: center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Alicatados_de_la_Sala_del_Mexuar%2C_la_Alhambra.jpg/800px-Alicatados_de_la_Sala_del_Mexuar%2C_la_Alhambra.jpg" alt="Geometric tile mosaic from the Alhambra showing intricate tessellating star patterns" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">Tile mosaic from the Alhambra, demonstrating the mathematical precision of wallpaper symmetry groups</div>
                </div>

                <div class="alert">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">17 Wallpaper Groups</p>
                        <p class="alert-text">Mathematicians later proved there are exactly <strong>17 possible wallpaper groups</strong> — 17 distinct ways a pattern can tessellate a plane through combinations of rotation, reflection, and translation. The Alhambra's artisans discovered nearly all of them <strong>centuries before</strong> the mathematical proof was formalized in 1891.</p>
                    </div>
                </div>
            `,
            fact: 'The Alhambra (1238-1358) contains nearly all 17 mathematically possible wallpaper groups in its tile mosaics.',
            choices: [
                { text: 'Return to the workshop, inspired', next: 'craft_deepens' }
            ]
        },

        // --- SCENE 7B: Wallpaper Groups ---
        wallpaper_groups: {
            era: 'Fez, 1381 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">VII</div>
                    <h2 class="section-title">The Infinite Proof</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <div class="card card-featured mt-6" style="text-align:left;">
                    <div class="card-icon" style="width:100px;height:100px;">
                        <svg viewBox="0 0 48 48"><polygon points="24,4 28,16 42,16 31,24 35,38 24,29 13,38 17,24 6,16 20,16"/><polygon points="24,12 26,18 33,18 28,22 30,29 24,25 18,29 20,22 15,18 22,18"/></svg>
                    </div>
                    <div>
                        <h3 class="card-title">Symmetry Without End</h3>
                        <p class="card-content">The visiting scholar explains: there are exactly <strong>17 possible wallpaper groups</strong> — 17 distinct ways a two-dimensional pattern can repeat to fill a flat surface through combinations of rotation, reflection, glide reflection, and translation.</p>
                        <p class="card-content mt-4">"The artisans of the Alhambra in Granada discovered nearly all 17 through craft and intuition, <strong>centuries before</strong> mathematicians proved the classification in 1891. The palace was built between <strong>1238 and 1358</strong>. Its muqarnas vaulting contains at least <strong>5,000 precisely cut prismatic pieces</strong> forming sixteen miniature domes from a single summit."</p>
                    </div>
                </div>

                <p class="type-body mt-6">You begin to understand. The patterns are not decoration. They are <em>proofs</em> — visual demonstrations of mathematical truth, created by artisans who thought with their hands as deeply as scholars think with their pens.</p>
            `,
            fact: 'The Alhambra (1238-1358) contains nearly all 17 mathematically possible wallpaper groups in its tile mosaics.',
            choices: [
                { text: 'Return to the workshop, inspired', next: 'craft_deepens' }
            ]
        },

        // --- SCENE 8: The Craft Deepens ---
        craft_deepens: {
            era: 'Fez, 1382 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">VIII</div>
                    <h2 class="section-title">From Dust to Glory</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <p class="type-body">Months become a year. A year becomes two. Your hands grow calloused, your eye grows sharp. The master teaches you to cut zellige tiles from glazed terracotta slabs — scoring, chiseling, shaping each piece with a <em>menqash</em> (a sharp chisel) until it fits its neighbors with the precision of a mathematical proof.</p>

                <div class="divider">
                    <div class="divider-icon"><svg viewBox="0 0 50 50" fill="none"><polygon points="25,5 29,18 43,18 32,27 36,40 25,31 14,40 18,27 7,18 21,18" fill="#c9a227"/><polygon points="25,12 27,19 35,19 29,24 31,31 25,26 19,31 21,24 15,19 23,19" fill="#c45c3e"/><circle cx="25" cy="25" r="4" fill="#1a6b52"/></svg></div>
                </div>

                <div class="alert alert-success">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">The Expanding Palette</p>
                        <p class="alert-text">The color palette of zellige evolved dramatically over centuries: <strong>white and brown</strong> in the 10th century, <strong>blue and green</strong> added in the 14th century, <strong>yellow</strong> also in the 14th century, and <strong>red</strong> only becoming common in the 17th century. Each new color enabled increasingly complex compositions.</p>
                    </div>
                </div>

                <p class="type-body mt-6">You have learned to work in the expanded palette of your era: cobalt blue, emerald green, honey yellow, and the original white and brown. But the master says technique alone is not enough.</p>

                <div class="card mt-6" style="text-align:left;">
                    <div class="dialogue-speaker">Moulay Idriss al-Fassi</div>
                    <p class="dialogue-text">"Your cuts are clean. Your geometry is sound. But you calculate like a student and cut like a craftsman. To be a <em>maalem</em> — a true master — you must <span class="text-gold">feel</span> the mathematics. The pattern must live in your hands before it lives in the clay."</p>
                </div>
            `,
            fact: 'Zellige colors evolved: white/brown (10th c.), blue/green (14th c.), yellow (14th c.), red only common in the 17th century.',
            choices: [
                { text: 'Focus on mastering the mathematics', next: 'struggle_math' },
                { text: 'Focus on perfecting the cutting technique', next: 'struggle_craft' }
            ]
        },

        // --- SCENE 9A: Struggle with Math ---
        struggle_math: {
            era: 'Fez, 1382 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">IX</div>
                    <h2 class="section-title">The Scholar's Path</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <p class="type-body">You return to Al-Qarawiyyin. You study al-Khwarizmi's methods of completing the square. You learn to calculate the exact angles needed for 6-fold, 8-fold, 10-fold, and 12-fold rotational symmetry. You fill tablets with compass constructions until the geometry becomes second nature.</p>

                <p class="type-body mt-4">One night, bent over a complex tessellation problem, something shifts in your mind. The numbers stop being numbers. They become <em>shapes</em>. You can see the pattern unfolding before you draw it, can feel where each tile must go before your hands reach for it.</p>

                <div class="frame mt-6" style="position:relative; text-align:center;">
                    <p class="type-accent">"The pattern lives in your hands now."</p>
                    <p class="type-body mt-4">The master nods when he sees your next composition. It is time to attempt your masterwork.</p>
                </div>
            `,
            fact: 'Islamic geometric art uses precise calculations for 6-fold, 8-fold, 10-fold, and 12-fold rotational symmetry.',
            choices: [
                { text: 'Begin your masterwork composition', next: 'breakthrough' }
            ]
        },

        // --- SCENE 9B: Struggle with Craft ---
        struggle_craft: {
            era: 'Fez, 1382 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">IX</div>
                    <h2 class="section-title">The Artisan's Path</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <p class="type-body">You spend hours in the workshop, cutting tile after tile. Your fingers learn to read the grain of the clay, to feel where the glaze will resist the chisel and where it will yield. You shatter hundreds of pieces and reassemble thousands.</p>

                <p class="type-body mt-4">Slowly, the mathematics stops being abstract. You begin to <em>see</em> angles in the way your chisel meets the clay. The geometry is not separate from the cutting — it lives in the movement of your hand, in the pressure of your thumb, in the sound the menqash makes when the cut is true.</p>

                <div class="frame mt-6" style="position:relative; text-align:center;">
                    <p class="type-accent">"Your hands understand what your mind is still learning."</p>
                    <p class="type-body mt-4">The master watches your latest cuts — clean, precise, each angle exact to within a hair's breadth. He nods. It is time to attempt your masterwork.</p>
                </div>
            `,
            fact: 'A zellige master (maalem) must feel the geometry intuitively — the mathematics lives in the hands, not just the mind.',
            choices: [
                { text: 'Begin your masterwork composition', next: 'breakthrough' }
            ]
        },

        // --- SCENE 10: The Breakthrough ---
        breakthrough: {
            era: 'Fez, 1383 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">X</div>
                    <h2 class="section-title">The Star Emerges</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <div class="geo-star">
                    <svg viewBox="0 0 120 120" fill="none">
                        <polygon points="60,10 68,40 100,40 74,58 82,88 60,70 38,88 46,58 20,40 52,40" fill="none" stroke="#c9a227" stroke-width="2"/>
                        <polygon points="60,20 65,42 88,42 70,54 76,76 60,64 44,76 50,54 32,42 55,42" fill="none" stroke="#c45c3e" stroke-width="1.5"/>
                        <polygon points="60,30 63,45 78,45 66,52 70,66 60,58 50,66 54,52 42,45 57,45" fill="none" stroke="#1a6b52" stroke-width="1"/>
                        <circle cx="60" cy="60" r="8" fill="#c9a227"/>
                    </svg>
                </div>

                <p class="type-body">You lay out the composition on the workshop floor: a large 8-pointed star at the center, formed by two overlapping squares rotated 45 degrees — the fundamental form that al-Khwarizmi's geometry made possible. Around it, interlocking octagons. Between them, smaller 4-pointed stars. And filling every gap, the precise diamond shapes that complete the tessellation.</p>

                <p class="type-body mt-4">Cobalt blue for the central star. Emerald green for the octagons. Honey yellow for the small stars. White for the diamonds. Every piece cut by your hands, every angle calculated by your mind.</p>

                <div class="card mt-6" style="text-align:left;">
                    <div class="dialogue-speaker">Moulay Idriss al-Fassi</div>
                    <p class="dialogue-text">"This is worthy. Not because it is perfect — perfection belongs only to God. But because the <span class="text-gold">mathematics sings</span> in it. Each tile knows its place. Each angle serves the whole. You have understood what al-Khwarizmi understood: that geometry is the language the universe speaks to itself."</p>
                </div>

                <p class="type-body mt-6">He places his hand on your shoulder. It is the first time he has touched you in three years of apprenticeship.</p>
            `,
            fact: 'The 8-pointed star, formed by two overlapping squares at 45 degrees, is the fundamental form of Islamic geometric art.',
            choices: [
                { text: 'Continue', next: 'courtyard' }
            ]
        },

        // --- SCENE 11: The Courtyard ---
        courtyard: {
            era: 'Fez, 1383 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">XI</div>
                    <h2 class="section-title">The Courtyard Lives</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#1a6b52"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                    </div>
                    <p class="type-body">Your tilework is installed in a riad courtyard on the far side of the medina. A wealthy merchant has commissioned the work. When the last piece is set and the mortar dries, water is released into the central fountain.</p>

                    <div style="margin: 1.5rem 0; text-align: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Traditional_Moroccan_Fountain.JPG/800px-Traditional_Moroccan_Fountain.JPG" alt="Traditional Moroccan fountain in a riad courtyard surrounded by zellige tilework" style="max-width: 100%; height: auto; border: 2px solid #C9A227; border-radius: 4px;">
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #C9A227; font-style: italic;">A traditional Moroccan fountain with zellige tilework in a riad courtyard</div>
                    </div>

                    <p class="type-body mt-4">You watch the water flow across the zellige, filling the seams between tiles, turning the flat mosaic into a living mirror. Light reflects off the water and scatters across the courtyard walls in dancing geometric shadows. The 8-pointed stars shimmer and multiply, as if the pattern extends infinitely in every direction.</p>
                    <p class="type-body mt-4" style="color: var(--gold); font-family: var(--font-accent); font-style: italic; font-size: 1.25rem; text-align: center;">"Every tile is a prayer," the master says softly. "And every pattern is a proof that the universe is built on order, harmony, and infinite complexity."</p>
                </div>
            `,
            fact: 'Zellige tilework in riad courtyards uses water reflections to create the illusion of infinite pattern extension.',
            choices: [
                { text: 'Continue', next: 'legacy' }
            ]
        },

        // --- SCENE 12: The Legacy ---
        legacy: {
            era: 'Fez, 1395 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">XII</div>
                    <h2 class="section-title">What Continues</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <p class="type-body">Fifteen years have passed since you first walked through Bab Bou Jeloud. The master is old now, his hands trembling, his eyes dimming. But his mind is as sharp as the chisel he taught you to wield.</p>

                <p class="type-body mt-4">He summons you to the workshop one evening. On the table between you: his tools, his compass, his straightedge. The instruments of a lifetime of geometry.</p>

                <div class="card mt-6" style="text-align:left;">
                    <div class="dialogue-speaker">Moulay Idriss al-Fassi</div>
                    <p class="dialogue-text">"These patterns existed before I was born and will exist after you die. We are custodians, not creators. Al-Khwarizmi wrote his equations five hundred years ago. This university has taught geometry for over five hundred years. The patterns are <span class="text-gold">eternal</span>. We are merely the hands through which they pass."</p>
                    <p class="dialogue-text mt-4">"Take my tools. You are a <em>maalem</em> now. What will you do with what I have given you?"</p>
                </div>
            `,
            fact: 'The zellige tradition has been passed from master (maalem) to apprentice in an unbroken chain for over a thousand years.',
            choices: [
                { text: 'Dedicate yourself to teaching the next generation', next: 'ending_teacher' },
                { text: 'Travel to al-Andalus to see the Alhambra yourself', next: 'ending_traveler' },
                { text: 'Create a masterwork that bridges past and future', next: 'ending_artist' }
            ]
        },

        // --- ENDING A: The Teacher ---
        ending_teacher: {
            era: 'Fez, 1420 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">XIII</div>
                    <h2 class="section-title">The Eternal Pattern</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c9a227"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c9a227"/></svg></div>
                    </div>

                    <p class="type-body">You teach. For twenty-five years, you teach. Young hands come to your workshop — orphans, scholars' children, merchants' sons, even a girl who disguises herself as a boy for three months before you notice and decide you do not care.</p>
                    <p class="type-body mt-4">You teach them what the master taught you: that the chisel is a compass, that the tile is a theorem, that beauty is not separate from truth but its visible form. You tell them about al-Khwarizmi and the House of Wisdom. You show them drawings of the Alhambra. You make them study at Al-Qarawiyyin.</p>
                    <p class="type-body mt-4">And one day, an old student returns to show you a composition so beautiful it makes you weep. An 8-pointed star, perfect in every angle, surrounded by a pattern you have never seen before. Something new. Something that extends the tradition.</p>
                    <p class="type-body mt-4" style="color: var(--gold); font-family: var(--font-accent); font-style: italic; font-size: 1.25rem; text-align: center;">The pattern never dies. It only finds new hands.</p>
                </div>

                <div class="divider">
                    <div class="divider-icon"><svg viewBox="0 0 50 50" fill="none"><polygon points="25,5 29,18 43,18 32,27 36,40 25,31 14,40 18,27 7,18 21,18" fill="#c9a227"/><polygon points="25,12 27,19 35,19 29,24 31,31 25,26 19,31 21,24 15,19 23,19" fill="#c45c3e"/><circle cx="25" cy="25" r="4" fill="#1a6b52"/></svg></div>
                </div>

                <div class="alert">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Epilogue: 2014 CE</p>
                        <p class="alert-text">On <strong>August 13, 2014</strong>, Iranian mathematician <strong>Maryam Mirzakhani</strong> became the first woman to win the <strong>Fields Medal</strong>, mathematics' highest honor. Her research in hyperbolic geometry and Riemann surfaces extended the geometric traditions established in Islamic mathematics over a thousand years earlier. She passed away in 2017 at age 40. The pattern continues, finding new hands across centuries.</p>
                    </div>
                </div>

                <p class="text-center mt-6" style="font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-secondary); opacity: 0.6;">The End</p>
            `,
            fact: 'In 2014, Maryam Mirzakhani became the first woman to win the Fields Medal, extending Islamic geometric traditions.',
            choices: [
                { text: 'Begin Again', next: '_restart' }
            ]
        },

        // --- ENDING B: The Traveler ---
        ending_traveler: {
            era: 'Granada, 1396 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">XIII</div>
                    <h2 class="section-title">The Circle Completes</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#c45c3e"/></svg>
                    </div>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c45c3e"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c45c3e"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c45c3e"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#c45c3e"/></svg></div>
                    </div>

                    <p class="type-body">You cross the Strait of Gibraltar and enter al-Andalus. The journey is long and dangerous, but you carry the master's tools and your father's tile, and these are all the protection you need.</p>
                    <p class="type-body mt-4">When you finally stand in the Court of the Lions at the Alhambra, you understand why your father wept. The walls breathe with geometry. Every surface tessellates, every pattern interlocks, every angle sings. The muqarnas overhead — those <strong>5,000 precisely cut pieces</strong> forming sixteen miniature domes — look like frozen starlight.</p>
                    <p class="type-body mt-4">You press your father's tile against the wall and find its match. The glaze, the angle, the proportions — identical. This tile was cut here, in this palace, decades ago. And now it has returned.</p>
                    <p class="type-body mt-4" style="color: var(--gold); font-family: var(--font-accent); font-style: italic; font-size: 1.25rem; text-align: center;">The circle completes. The pattern returns to its origin.</p>
                </div>

                <div class="divider">
                    <div class="divider-icon"><svg viewBox="0 0 50 50" fill="none"><polygon points="25,5 29,18 43,18 32,27 36,40 25,31 14,40 18,27 7,18 21,18" fill="#c9a227"/><polygon points="25,12 27,19 35,19 29,24 31,31 25,26 19,31 21,24 15,19 23,19" fill="#c45c3e"/><circle cx="25" cy="25" r="4" fill="#1a6b52"/></svg></div>
                </div>

                <div class="alert">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Epilogue: 2014 CE</p>
                        <p class="alert-text">On <strong>August 13, 2014</strong>, Iranian mathematician <strong>Maryam Mirzakhani</strong> became the first woman to win the <strong>Fields Medal</strong>. Her work on hyperbolic geometry and Riemann surfaces continued the tradition of Islamic geometric mathematics — a tradition that, like the patterns of the Alhambra, tessellates across centuries, always finding new forms, always returning to its origins.</p>
                    </div>
                </div>

                <p class="text-center mt-6" style="font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-secondary); opacity: 0.6;">The End</p>
            `,
            fact: 'In 2014, Maryam Mirzakhani became the first woman to win the Fields Medal, extending Islamic geometric traditions.',
            choices: [
                { text: 'Begin Again', next: '_restart' }
            ]
        },

        // --- ENDING C: The Artist ---
        ending_artist: {
            era: 'Fez, 1400 CE',
            content: `
                <div class="section-header">
                    <div class="section-number">XIII</div>
                    <h2 class="section-title">Geometry Without End</h2>
                    <div class="section-divider">
                        <svg viewBox="0 0 40 40" fill="none"><polygon points="20,2 24,15 38,15 27,23 31,37 20,28 9,37 13,23 2,15 16,15" fill="#1a6b52"/></svg>
                    </div>
                </div>

                <div class="geo-star" style="width:160px; height:160px;">
                    <svg viewBox="0 0 120 120" fill="none">
                        <polygon points="60,10 68,40 100,40 74,58 82,88 60,70 38,88 46,58 20,40 52,40" fill="none" stroke="#c9a227" stroke-width="2"/>
                        <polygon points="60,20 65,42 88,42 70,54 76,76 60,64 44,76 50,54 32,42 55,42" fill="none" stroke="#c45c3e" stroke-width="1.5"/>
                        <polygon points="60,30 63,45 78,45 66,52 70,66 60,58 50,66 54,52 42,45 57,45" fill="none" stroke="#1a6b52" stroke-width="1"/>
                        <circle cx="60" cy="60" r="8" fill="#c9a227"/>
                    </svg>
                </div>

                <div class="frame" style="position:relative;">
                    <div class="corner-stars">
                        <div class="corner-star corner-star-tl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-tr"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-bl"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                        <div class="corner-star corner-star-br"><svg viewBox="0 0 30 30"><polygon points="15,2 17,11 27,11 19,17 22,26 15,20 8,26 11,17 3,11 13,11" fill="#1a6b52"/></svg></div>
                    </div>

                    <p class="type-body">You spend five years on your masterwork. It is not a wall or a fountain but an entire room: a small meditation chamber in a new madrasa near Al-Qarawiyyin. Floor, walls, and a muqarnas ceiling — all zellige, all interconnected, all following a single geometric system that unfolds from one 8-pointed star at the center of the floor into every surface.</p>
                    <p class="type-body mt-4">Scholars come from across the Maghreb to see it. A mathematician from Tunis counts the symmetry groups and finds <strong>fourteen of the seventeen possible wallpaper patterns</strong> — more than anyone has achieved in a single room outside the Alhambra itself.</p>
                    <p class="type-body mt-4">But what moves people most is not the mathematics. It is the beauty. The way light enters through a small window and multiplies across the tessellations until the entire room glows. The way the geometry creates silence — a stillness so complete that visitors whisper without knowing why.</p>
                    <p class="type-body mt-4" style="color: var(--gold); font-family: var(--font-accent); font-style: italic; font-size: 1.25rem; text-align: center;">You have created a space where mathematics becomes prayer and prayer becomes geometry. The pattern is infinite. The garden has no walls.</p>
                </div>

                <div class="divider">
                    <div class="divider-icon"><svg viewBox="0 0 50 50" fill="none"><polygon points="25,5 29,18 43,18 32,27 36,40 25,31 14,40 18,27 7,18 21,18" fill="#c9a227"/><polygon points="25,12 27,19 35,19 29,24 31,31 25,26 19,31 21,24 15,19 23,19" fill="#c45c3e"/><circle cx="25" cy="25" r="4" fill="#1a6b52"/></svg></div>
                </div>

                <div class="alert">
                    <div class="alert-icon"><svg viewBox="0 0 24 24"><polygon points="12,2 14,8 22,8 16,13 18,20 12,15 6,20 8,13 2,8 10,8"/></svg></div>
                    <div class="alert-content">
                        <p class="alert-title">Epilogue: 2014 CE</p>
                        <p class="alert-text">On <strong>August 13, 2014</strong>, Iranian mathematician <strong>Maryam Mirzakhani</strong> became the first woman to win the <strong>Fields Medal</strong>, the highest honor in mathematics. Her groundbreaking research in hyperbolic geometry and Riemann surfaces extended the geometric traditions established by al-Khwarizmi and the artisans of the Islamic Golden Age over a thousand years earlier. She died in 2017 at age 40 — but the patterns she discovered, like the zellige of Fez, continue without end.</p>
                    </div>
                </div>

                <p class="text-center mt-6" style="font-family: var(--font-display); font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--text-secondary); opacity: 0.6;">The End</p>
            `,
            fact: 'In 2014, Maryam Mirzakhani became the first woman to win the Fields Medal, extending Islamic geometric traditions.',
            choices: [
                { text: 'Begin Again', next: '_restart' }
            ]
        }
    };

    // ===============================================================
    //  STORY ENGINE
    // ===============================================================

    const engine = {
        currentScene: null,
        history: [],
        facts: [],
        panelOpen: false,

        init() {
            document.getElementById('startBtn').addEventListener('click', () => this.start());
            document.getElementById('restartBtn').addEventListener('click', () => this.restart());
            document.getElementById('knowledgeToggle').addEventListener('click', () => this.togglePanel());

            document.addEventListener('keydown', (e) => {
                if (e.key >= '1' && e.key <= '9') {
                    const idx = parseInt(e.key) - 1;
                    const btns = document.querySelectorAll('.choice-btn');
                    if (btns[idx]) btns[idx].click();
                }
            });
        },

        start() {
            document.getElementById('titleScreen').style.display = 'none';
            document.getElementById('sceneWrapper').classList.add('active');
            document.getElementById('knowledgeTracker').style.display = 'block';
            this.goTo('arrival');
        },

        restart() {
            this.currentScene = null;
            this.history = [];
            this.facts = [];
            this.panelOpen = false;
            document.getElementById('knowledgePanel').classList.remove('open');
            document.getElementById('sceneWrapper').classList.remove('active');
            document.getElementById('titleScreen').style.display = 'flex';
            document.getElementById('knowledgeTracker').style.display = 'none';
            this.updateFactUI();
            window.scrollTo(0, 0);
        },

        goTo(sceneId) {
            if (sceneId === '_restart') {
                this.restart();
                return;
            }

            const scene = STORY[sceneId];
            if (!scene) return;

            if (this.currentScene) {
                const overlay = document.getElementById('transition');
                overlay.classList.add('active');
                setTimeout(() => {
                    this.renderScene(sceneId, scene);
                    window.scrollTo({ top: 0, behavior: 'auto' });
                }, 600);
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 1400);
            } else {
                this.renderScene(sceneId, scene);
            }

            if (this.currentScene) {
                this.history.push(this.currentScene);
            }
            this.currentScene = sceneId;
        },

        renderScene(sceneId, scene) {
            const container = document.getElementById('sceneContent');
            const gameControls = document.querySelector('.game-controls');
            if (gameControls) gameControls.style.display = sceneId.startsWith('ending') ? 'none' : '';

            if (scene.era) {
                document.getElementById('sceneEra').textContent = scene.era;
            }

            let html = '<div class="scene-content">';

            html += scene.content;

            if (scene.fact) {
                this.addFact(scene.fact);
            }

            if (scene.choices && scene.choices.length > 0) {
                html += '<div class="choices">';
                scene.choices.forEach((choice, i) => {
                    html += '<button class="choice-btn" onclick="engine.goTo(\'' + choice.next + '\')">';
                    html += '<span class="choice-key">' + (i + 1) + '</span>';
                    html += choice.text;
                    html += '</button>';
                });
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;

            this.updateFactUI();
        },

        addFact(fact) {
            if (!this.facts.includes(fact)) {
                this.facts.push(fact);
            }
        },

        updateFactUI() {
            const count = this.facts.length;
            document.getElementById('factCount').textContent = count;

            const list = document.getElementById('factList');
            if (count === 0) {
                list.innerHTML = '<p class="no-facts">Your journey has just begun...</p>';
            } else {
                list.innerHTML = this.facts.map(f => '<div class="knowledge-item">' + f + '</div>').join('');
            }
        },

        togglePanel() {
            this.panelOpen = !this.panelOpen;
            document.getElementById('knowledgePanel').classList.toggle('open', this.panelOpen);
        }
    };

    engine.init();
    </script>
</body>
</html>
