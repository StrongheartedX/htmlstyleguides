<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slide Editor</title>
<link id="theme-fonts" rel="stylesheet" href="">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a1a; color: #e0e0e0; font-family: system-ui, -apple-system, sans-serif; }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .editor-layout {
    display: grid;
    grid-template-columns: 160px 1fr 240px;
    grid-template-rows: 48px 1fr;
    height: 100vh;
    gap: 0;
  }

  /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toolbar {
    grid-column: 1 / -1;
    background: #111;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 4px;
    z-index: 10;
  }
  .toolbar-group {
    display: flex; align-items: center; gap: 2px;
    padding: 0 8px;
    border-right: 1px solid #333;
  }
  .toolbar-group:last-child { border-right: none; }
  .toolbar button, .toolbar select {
    background: transparent; border: 1px solid transparent;
    color: #ccc; padding: 6px 10px; border-radius: 4px;
    cursor: pointer; font-size: 0.85rem; white-space: nowrap;
  }
  .toolbar button:hover, .toolbar select:hover { background: #333; border-color: #555; }
  .toolbar select { background: #222; border-color: #444; padding-right: 24px; }
  .toolbar .title-input {
    background: transparent; border: 1px solid transparent; color: #e0e0e0;
    font-size: 0.95rem; font-weight: 600; padding: 4px 8px; border-radius: 4px;
    width: 200px;
  }
  .toolbar .title-input:focus { border-color: #555; outline: none; background: #222; }
  .toolbar-spacer { flex: 1; }

  /* â”€â”€ Slide Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #slide-panel {
    background: #111;
    border-right: 1px solid #333;
    overflow-y: auto;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .slide-thumb {
    position: relative;
    cursor: pointer;
    border: 2px solid #333;
    border-radius: 4px;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .slide-thumb:hover { border-color: #666; }
  .slide-thumb.active { border-color: #2563eb; }
  .thumb-num {
    position: absolute; top: 2px; left: 4px;
    font-size: 0.65rem; color: #888; z-index: 1;
  }
  .thumb-preview {
    width: 100%;
    aspect-ratio: 16/9;
    position: relative;
    overflow: hidden;
  }
  .slide-add-btn {
    background: transparent; border: 2px dashed #444;
    color: #888; padding: 8px; border-radius: 4px;
    cursor: pointer; font-size: 0.8rem;
    transition: all 0.2s;
  }
  .slide-add-btn:hover { border-color: #666; color: #ccc; }

  /* â”€â”€ Canvas Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .canvas-area {
    background: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding: 24px;
    position: relative;
  }
  #slide-canvas {
    position: relative;
    aspect-ratio: 16/9;
    max-width: 100%;
    max-height: 100%;
    overflow: hidden;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
  }

  /* â”€â”€ Editor Element Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .editor-element {
    position: relative;
  }
  .editor-element.selected {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
  }
  .editor-element.editing {
    outline: 2px solid #10b981;
    outline-offset: 2px;
  }
  .resize-handle {
    position: absolute;
    background: #2563eb;
    border: 1px solid #fff;
    border-radius: 2px;
    width: 8px; height: 8px;
    display: none;
    z-index: 5;
  }
  .selected .resize-handle { display: block; }
  .resize-se { bottom: -4px; right: -4px; cursor: se-resize; }
  .resize-e { top: 50%; right: -4px; transform: translateY(-50%); cursor: e-resize; }
  .resize-s { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize; }

  /* â”€â”€ Properties Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #props-panel {
    background: #111;
    border-left: 1px solid #333;
    overflow-y: auto;
    padding: 12px;
    font-size: 0.85rem;
  }
  .props-empty {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 100%; text-align: center; color: #666;
  }
  .props-section { margin-bottom: 16px; }
  .props-section h3 {
    font-size: 0.75rem; text-transform: uppercase;
    letter-spacing: 0.1em; color: #888;
    margin-bottom: 10px; padding-bottom: 6px;
    border-bottom: 1px solid #333;
  }
  .props-section label {
    display: flex; flex-direction: column; gap: 3px;
    margin-bottom: 8px; color: #aaa; font-size: 0.8rem;
  }
  .props-section input, .props-section select, .props-section textarea {
    background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
    padding: 5px 8px; border-radius: 3px; font-size: 0.85rem;
    font-family: inherit;
  }
  .props-section input:focus, .props-section select:focus, .props-section textarea:focus {
    border-color: #2563eb; outline: none;
  }
  .props-section textarea { resize: vertical; min-height: 48px; }
  .props-delete {
    background: #3a1a1a; border: 1px solid #5a2a2a; color: #ff6b6b;
    padding: 6px 12px; border-radius: 4px; cursor: pointer;
    font-size: 0.8rem; width: 100%; margin-top: 8px;
  }
  .props-delete:hover { background: #4a2020; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    .editor-layout {
      grid-template-columns: 1fr;
      grid-template-rows: 48px 1fr 200px;
    }
    #slide-panel { display: none; }
    #props-panel { border-left: none; border-top: 1px solid #333; }
  }
</style>
</head>
<body>

<div class="editor-layout">
  <div class="toolbar">
    <div class="toolbar-group">
      <input type="text" class="title-input" id="deck-title" placeholder="Presentation title" spellcheck="false">
    </div>
    <div class="toolbar-group">
      <button onclick="SlideEditor.addElement('text')" title="Add text">T Text</button>
      <button onclick="SlideEditor.addElement('shape', {shape:'rect'})" title="Add rectangle">â–¬ Rect</button>
      <button onclick="SlideEditor.addElement('shape', {shape:'circle'})" title="Add circle">â— Circle</button>
      <button onclick="SlideEditor.addElement('line')" title="Add line">â•± Line</button>
      <button onclick="SlideEditor.addElement('mermaid')" title="Add Mermaid diagram">â—ˆ Mermaid</button>
    </div>
    <div class="toolbar-group">
      <label style="color:#aaa;font-size:0.8rem;display:flex;align-items:center;gap:6px">
        Theme
        <select id="theme-select">
          <option value="default">Default</option>
          <option value="graffiti">Graffiti</option>
          <option value="cyberpunk">Cyberpunk</option>
        </select>
      </label>
    </div>
    <div class="toolbar-group">
      <button onclick="handleDeleteSlide()" title="Delete current slide">ğŸ—‘ Slide</button>
      <button onclick="SlideEditor.duplicateSlide(SlideEditor.currentSlide)" title="Duplicate slide">â§‰ Duplicate</button>
    </div>
    <div class="toolbar-spacer"></div>
    <div class="toolbar-group">
      <button onclick="SlideEditor.previewInViewer()" title="Preview in viewer">â–¶ Preview</button>
      <button onclick="SlideEditor.exportJSON()" title="Download JSON">â†“ Export</button>
      <button onclick="document.getElementById('import-file').click()" title="Load JSON file">â†‘ Import</button>
      <input type="file" id="import-file" accept=".json" style="display:none">
    </div>
  </div>

  <div id="slide-panel"></div>

  <div class="canvas-area">
    <div id="slide-canvas"></div>
  </div>

  <div id="props-panel">
    <div class="props-empty">
      <p>Select an element to edit its properties</p>
    </div>
  </div>
</div>

<script src="editor.js"></script>
<script>
(async function() {
  const params = new URLSearchParams(window.location.search);
  const deckName = params.get('deck');
  let deckData = null;

  // Try to load from URL param
  if (deckName) {
    try {
      const res = await fetch(`decks/${deckName}.json`);
      if (res.ok) deckData = await res.json();
    } catch (e) { /* will use draft or empty */ }
  }

  // Try draft from localStorage
  if (!deckData) {
    deckData = SlideEditor.loadDraft();
  }

  // Load initial theme
  const themeName = (deckData && deckData.theme) || 'default';
  await loadTheme(themeName);
  document.getElementById('theme-select').value = themeName;

  // Initialize editor
  const options = { theme: window.SLIDE_THEME, draftKey: deckName ? `slides-draft-${deckName}` : 'slides-draft' };
  if (deckData) options.deck = deckData;
  SlideEditor.init(options);

  // Title input
  const titleInput = document.getElementById('deck-title');
  titleInput.value = (SlideEditor.deck && SlideEditor.deck.title) || '';
  titleInput.addEventListener('input', () => {
    SlideEditor.updateDeckMeta('title', titleInput.value);
    document.title = titleInput.value + ' â€” Slide Editor';
  });
  document.title = (titleInput.value || 'Untitled') + ' â€” Slide Editor';

  // Theme switcher
  document.getElementById('theme-select').addEventListener('change', async (e) => {
    await loadTheme(e.target.value);
    SlideEditor.setTheme(window.SLIDE_THEME);
  });

  // Import
  document.getElementById('import-file').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      await SlideEditor.importJSON(file);
      titleInput.value = SlideEditor.deck.title || '';
      if (SlideEditor.deck.theme) {
        await loadTheme(SlideEditor.deck.theme);
        document.getElementById('theme-select').value = SlideEditor.deck.theme;
        SlideEditor.setTheme(window.SLIDE_THEME);
      }
    } catch (err) {
      alert('Failed to import: ' + err.message);
    }
    e.target.value = '';
  });

  // Fit canvas
  fitCanvas();
  window.addEventListener('resize', fitCanvas);

  function fitCanvas() {
    const area = document.querySelector('.canvas-area');
    const canvas = document.getElementById('slide-canvas');
    if (!area || !canvas) return;
    const aw = area.clientWidth - 48;
    const ah = area.clientHeight - 48;
    const ar = 16 / 9;
    let w, h;
    if (aw / ah > ar) { h = ah; w = h * ar; } else { w = aw; h = w / ar; }
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
  }

  function loadTheme(name) {
    return new Promise((resolve) => {
      // Remove old theme script
      const old = document.getElementById('theme-script');
      if (old) old.remove();
      const script = document.createElement('script');
      script.id = 'theme-script';
      script.src = `themes/${name}.js`;
      script.onload = resolve;
      script.onerror = resolve; // graceful fallback
      document.head.appendChild(script);
    });
  }
})();

function handleDeleteSlide() {
  if (confirm('Delete this slide?')) {
    SlideEditor.deleteSlide(SlideEditor.currentSlide);
  }
}
</script>
</body>
</html>
